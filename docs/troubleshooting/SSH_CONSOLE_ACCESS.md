# SSH and Console Access - Technical Details

**Created**: 2026-01-13
**Purpose**: Document findings about SSH configuration vs console access behavior

---

## Executive Summary

This document clarifies the relationship between SSH daemon configuration (`sshd_config`) and Hetzner Cloud Console (VNC) access, specifically addressing concerns about root account lockout.

## Key Findings

### 1. SSH Configuration Does NOT Affect Console Access

The `PermitRootLogin` setting in `/etc/ssh/sshd_config` **only controls the SSH daemon** for network-based SSH connections. It does **not affect** local console login (Hetzner Cloud Console/VNC).

**Source**: [Using the console - Hetzner Docs](https://docs.hetzner.com/cloud/servers/getting-started/vnc-console/)

### 2. Console Uses Direct PAM Authentication

The Hetzner Cloud Console uses a separate authentication path:
- **SSH**: Uses `sshd` daemon → reads `/etc/ssh/sshd_config` → applies `PermitRootLogin` rules
- **Console**: Direct TTY access → uses PAM/login → bypasses SSH configuration entirely

**Source**: [SSH PermitRootLogin | Proxmox Support Forum](https://forum.proxmox.com/threads/ssh-permitrootlogin.157426/)

### 3. PermitRootLogin Options

| Setting | SSH with Key | SSH with Password | Console with Password |
|---------|-------------|-------------------|----------------------|
| `yes` | ✅ Allowed | ✅ Allowed | ✅ Allowed |
| `prohibit-password` | ✅ Allowed | ❌ Blocked | ✅ Allowed |
| `forced-commands-only` | ⚠️ Limited | ❌ Blocked | ✅ Allowed |
| `no` | ❌ Blocked | ❌ Blocked | ✅ Allowed |

**Source**: [SSH Root Login: How to Enable or Disable + Troubleshooting](https://phoenixnap.com/kb/ssh-root-login)

## Our Implementation

### Cloud-init Configuration

**File**: `terraform/modules/hetzner-server/templates/cloud-init.yml`

**Strategy**: Security-hardened with Debian 13 fixes
- Creates admin user (`malpanez`) with sudo and SSH key
- **Unlocks root account** for console access (Debian 13 requirement)
- Configures UFW firewall with management IP restriction
- Applies sysctl kernel hardening
- Installs fail2ban and unattended-upgrades
- Full security baseline before Ansible runs

```yaml
# CRITICAL: Debian 13 locks root by default - explicitly enable it
disable_root: false

# Create admin user with passwordless sudo
users:
  - name: ${username}
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_authorized_keys:
      - ${ssh_pub_key}

# Unlock root account for console access
runcmd:
  - passwd -u root  # Unlocks root so Hetzner password works
  - |
    # Configure UFW firewall
    ufw --force reset
    ufw default deny incoming
    ufw default allow outgoing
    ufw allow from ${management_ip} to any port 22 proto tcp
    ufw allow 80/tcp
    ufw allow 443/tcp
    echo "y" | ufw enable
```

**Why `passwd -u root`?**: Debian 13 locks root by default. Hetzner sets a password (sent via email), but the account remains locked. The `passwd -u root` command unlocks it so console access works.

### SSH Hardening (Ansible)

**Role**: `ansible/roles/ssh_2fa`
**File**: `roles/ssh_2fa/templates/sshd_hardening.conf.j2`

**Configuration**:
```ini
# Allow root login with SSH key only (no password)
PermitRootLogin prohibit-password

# Disable password authentication for all users
PasswordAuthentication no

# Strong cryptography only
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com
```

**Result**:
- ✅ Root can SSH with Hetzner-injected key
- ✅ Root can login via console with password (auto-generated by Hetzner)
- ✅ Admin user (`malpanez`) exempt from 2FA via break-glass
- ✅ Security hardened without breaking access

### Break-glass Configuration

**File**: `roles/ssh_2fa/templates/sshd_2fa.conf.j2`

**Implementation**:
```ini
# Break-glass users - SSH key only (NO 2FA required)
Match User malpanez
    AuthenticationMethods publickey
    PermitTTY yes
    AllowTcpForwarding yes

# Default for all other users - Require 2FA
Match All
    AuthenticationMethods publickey,keyboard-interactive
```

**Purpose**: Prevents admin lockout during initial setup and provides emergency access.

## Access Methods

### 1. SSH Access (Normal Operation)

**Admin User** (Recommended):
```bash
ssh malpanez@<server-ip>
```
- Uses SSH key from Terraform/cloud-init
- No 2FA required (break-glass)
- Full sudo access

**Root User** (Initial Setup):
```bash
ssh root@<server-ip>
```
- Uses SSH key injected by Hetzner
- Blocked after Ansible hardening (best practice)
- Use admin user instead

### 2. Console Access (Emergency)

**Via Hetzner Cloud Console**:
1. Login to [Hetzner Cloud Console](https://console.hetzner.cloud/)
2. Select server → Click "Console" button
3. Login as `root` with password from Hetzner email

**Use cases**:
- SSH daemon crashed or misconfigured
- Firewall blocking SSH access
- Lost SSH keys
- Network connectivity issues

### 3. Rescue Mode (Critical Recovery)

**Via Hetzner Cloud Console**:
1. Enable rescue mode from server settings
2. Reboot server
3. Access via console or SSH with temporary credentials
4. Fix configuration
5. Disable rescue mode and reboot

## Troubleshooting

### Problem: Cannot SSH but console works

**Cause**: SSH daemon misconfigured or not running

**Solution**:
```bash
# Via console
systemctl status sshd
journalctl -u sshd -n 50
sshd -t  # Test configuration
```

### Problem: Cannot access console

**Cause**: Root password unknown

**Solution**:
1. Hetzner Cloud Console → Server → Rescue tab
2. Click "Reset Root Password"
3. Check email for new password

### Problem: Both SSH and console locked

**Cause**: Severe misconfiguration

**Solution**:
1. Enable rescue mode in Hetzner Console
2. Boot into rescue system
3. Mount root filesystem
4. Fix `/etc/ssh/sshd_config` or `/etc/shadow`
5. Reboot normally

## Verification After Deployment

### 1. Test SSH Access

```bash
# Test admin user SSH
ssh malpanez@<server-ip> whoami

# Test root SSH (should work initially)
ssh root@<server-ip> whoami
```

### 2. Test Console Access

1. Open Hetzner Cloud Console
2. Connect to server console
3. Login as root with password
4. Verify access works

### 3. Verify SSH Configuration

```bash
# Check current config
sudo sshd -T | grep -E '(permitrootlogin|passwordauthentication)'

# Expected output:
# permitrootlogin prohibit-password
# passwordauthentication no
```

### 4. Verify Break-glass

```bash
# SSH as malpanez should NOT require 2FA
ssh malpanez@<server-ip>
# Should connect directly without TOTP prompt
```

## References

### Official Documentation
- [Hetzner Cloud Console](https://docs.hetzner.com/cloud/servers/getting-started/vnc-console/)
- [Hetzner Cloud FAQ](https://docs.hetzner.com/cloud/servers/faq/)
- [Hetzner SSH Tutorial](https://community.hetzner.com/tutorials/securing-ssh/)

### Technical Details
- [SSH PermitRootLogin Options](https://phoenixnap.com/kb/ssh-root-login)
- [Console vs SSH Authentication](https://forum.proxmox.com/threads/ssh-permitrootlogin.157426/)
- [Debian 13 Cloud Images](https://wiki.debian.org/Cloud/AmazonEC2Image/Trixie)

### Design Decisions
- [Basic Cloud Config | Hetzner Community](https://community.hetzner.com/tutorials/basic-cloud-config/)
- [Hetzner Cloud: Disable Root and Add User](https://bobswinkels.com/posts/hetzner-cloud-config/)

---

## Changelog

- **2026-01-13**: Initial documentation based on deployment troubleshooting
- Clarified SSH vs console access behavior
- Documented break-glass configuration
- Added verification procedures
