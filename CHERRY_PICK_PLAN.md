# Cherry-Pick Plan: Elementos Seguros del Security Repo

## Contexto

El repositorio `malpanez/security` **no está 100% terminado**, pero contiene patrones probados que podemos aplicar de forma selectiva.

**Estrategia**: Tomar SOLO elementos específicos y probados, no integración completa.

---

## Elementos Seguros para Aplicar AHORA

### 1. Validación SSH Pre-Aplicación ⭐⭐⭐ (SEGURO - 5 minutos)

**Qué es**: Ansible valida configuración SSH ANTES de aplicarla usando `sshd -t`

**Riesgo**: CERO - solo agrega validación, no cambia lógica

**Implementación**:

Editar [`ansible/roles/ssh_2fa/tasks/configure.yml`](ansible/roles/ssh_2fa/tasks/configure.yml):

```yaml
- name: Deploy SSH 2FA configuration
  ansible.builtin.template:
    src: sshd_2fa.conf.j2
    dest: /etc/ssh/sshd_config.d/20-2fa.conf
    owner: root
    group: root
    mode: '0644'
    validate: '/usr/sbin/sshd -t -f %s'  # ← AGREGAR ESTA LÍNEA
    backup: yes
  notify: restart ssh
```

**Resultado**: Si la configuración generada es inválida, Ansible RECHAZA el cambio automáticamente.

**Testing**: El próximo deploy probará automáticamente.

---

### 2. SSH Version Detection ⭐⭐ (SEGURO - 10 minutos)

**Qué es**: Detecta versión de OpenSSH para logging y debugging

**Riesgo**: CERO - solo lectura, no modifica nada

**Implementación**:

Editar [`ansible/roles/ssh_2fa/tasks/main.yml`](ansible/roles/ssh_2fa/tasks/main.yml) - agregar al principio:

```yaml
---
# Detect OpenSSH version for logging and compatibility
- name: Detect OpenSSH version
  ansible.builtin.command: /usr/sbin/sshd -V
  register: sshd_version_output
  changed_when: false
  failed_when: false
  tags: [ssh, 2fa, preflight]

- name: Extract OpenSSH version
  ansible.builtin.set_fact:
    openssh_version: "{{ sshd_version_output.stderr | regex_search('OpenSSH_([0-9]+\\.[0-9]+)', '\\1') | first | default('unknown') }}"
    cacheable: true
  tags: [ssh, 2fa, preflight]

- name: Display detected OpenSSH version
  ansible.builtin.debug:
    msg: "Detected OpenSSH version: {{ openssh_version }}"
  tags: [ssh, 2fa, preflight]

# Resto de tus tasks actuales...
- name: Install Google Authenticator
  # ...
```

**Resultado**: Logs muestran qué versión SSH se detectó. Útil para debugging.

**Uso futuro**: Podrías condicionar features: `when: openssh_version is version('8.2', '>=')`

---

### 3. Grupo MFA Bypass ⭐⭐ (BAJO RIESGO - 15 minutos)

**Qué es**: Grupo Linux que permite bypass de MFA para cuentas de servicio

**Riesgo**: BAJO - solo crea grupo, no modifica autenticación todavía

**Implementación Fase 1** (Solo crear grupo):

Editar [`ansible/roles/ssh_2fa/tasks/configure.yml`](ansible/roles/ssh_2fa/tasks/configure.yml) - agregar:

```yaml
# Create MFA bypass group for service accounts
- name: Create MFA bypass group
  ansible.builtin.group:
    name: mfa-bypass
    state: present
  tags: [ssh, 2fa, groups]

- name: Add ansible user to MFA bypass temporarily
  ansible.builtin.user:
    name: "{{ ansible_user }}"
    groups: mfa-bypass
    append: yes
  when: ansible_user is defined
  tags: [ssh, 2fa, groups]
```

**Resultado**: Grupo existe pero no afecta autenticación (todavía).

**Fase 2** (Aplicar bypass - DESPUÉS de testing):

Editar [`ansible/roles/ssh_2fa/templates/sshd_2fa.conf.j2`](ansible/roles/ssh_2fa/templates/sshd_2fa.conf.j2):

```jinja2
# SSH 2FA Configuration
# Generated by Ansible - DO NOT EDIT MANUALLY

# Service accounts and automation - NO MFA (public key only)
Match Group mfa-bypass
    AuthenticationMethods publickey
    PermitTTY yes

# Human users - REQUIRE MFA
Match Group sudo,admin
    AuthenticationMethods publickey,keyboard-interactive:pam
    PermitTTY yes

# Fallback - require keys at minimum
Match All
    AuthenticationMethods publickey
```

**Riesgo Fase 2**: MEDIO - cambia autenticación, pero más seguro que configuración actual.

---

### 4. PAM Stack Fix ⭐⭐⭐ (CRÍTICO - PERO RIESGOSO)

**Qué es**: Arregla configuración PAM incorrecta actual

**Problema actual** en tu código:

```
auth required pam_google_authenticator.so
```

**Problemas**:

- No hay bypass para service accounts
- Control flag `required` puede causar loops
- Podría estar en orden incorrecto

**Solución propuesta**:

```
# Bypass MFA for service accounts in mfa-bypass group
auth [success=done default=ignore] pam_succeed_if.so quiet user ingroup mfa-bypass

# Require Google Authenticator for interactive users
auth required pam_google_authenticator.so nullok echo_verification_code
```

**PERO**: Esto es RIESGOSO sin ver tu configuración PAM actual completa.

**Recomendación**: NO APLICAR hasta después de deployment exitoso básico.

---

## Plan de Implementación Seguro

### MAÑANA - Deploy Básico PRIMERO

**Objetivo**: Lograr deployment exitoso con código actual (con fixes ya aplicados)

```bash
# 1. Deploy infrastructure
cd terraform
terraform apply

# 2. Deploy Ansible
cd ../ansible
export HCLOUD_TOKEN="..."
ansible-playbook -u root playbooks/site.yml

# 3. Verificar acceso SSH
ssh -i ~/.ssh/github_ed25519 root@<IP>
```

**SI FUNCIONA**: Proceder a mejoras.

**SI FALLA**: Debugging con Hetzner Console.

---

### DESPUÉS del Deploy Básico - Mejoras Incrementales

#### Mejora 1: Validación SSH (SEGURO) ✅

- Aplicar cambio #1 (validate SSH config)
- Commit
- Redeploy
- Verificar logs muestran "validation passed"

#### Mejora 2: Version Detection (SEGURO) ✅

- Aplicar cambio #2 (detect SSH version)
- Commit
- Redeploy
- Verificar logs muestran versión correcta

#### Mejora 3: Grupo Bypass Fase 1 (BAJO RIESGO) ✅

- Aplicar cambio #3 Fase 1 (solo crear grupo)
- Commit
- Redeploy
- Verificar grupo existe: `getent group mfa-bypass`

#### Mejora 4: Match Blocks (MEDIO RIESGO) ⚠️

- Aplicar cambio #3 Fase 2 (SSH match blocks)
- **MANTENER sesión SSH root abierta**
- Commit
- Redeploy
- Verificar puedes abrir NUEVA sesión SSH
- Si falla: usar sesión abierta para revertir

#### Mejora 5: PAM Fix (ALTO RIESGO) ⚠️⚠️

- **PRIMERO**: Leer configuración PAM actual completa
- **SEGUNDO**: Crear backup manual
- **TERCERO**: Aplicar cambios PAM incrementalmente
- **CUARTO**: Testing exhaustivo

---

## Cambios a Aplicar HOY (Bajo Riesgo)

### Cambio 1: Validación SSH

<function_calls>
<invoke name="Read">
<parameter name="file_path">/home/malpanez/repos/hetzner-secure-infrastructure/ansible/roles/ssh_2fa/tasks/configure.yml
