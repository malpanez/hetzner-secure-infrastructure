name: Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run security scans weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  terraform-security:
    name: Terraform Security Scanner (Trivy)
    runs-on: ubuntu-slim

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy for Terraform
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'terraform'
          format: 'sarif'
          output: 'terraform-trivy.sarif'
          severity: 'MEDIUM,HIGH,CRITICAL'
          exit-code: '0'

      - name: Upload Terraform Trivy SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: terraform-trivy.sarif
        continue-on-error: true

  checkov:
    name: Checkov - IaC Security Scanner
    runs-on: ubuntu-slim

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install Checkov with UV
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          uv pip install --system --break-system-packages checkov
          checkov --version

      - name: Run Checkov
        id: checkov
        run: |
          checkov -d terraform --framework terraform --output sarif --skip-check CKV_TF_1 > results.sarif || true
        continue-on-error: true

      - name: Upload Checkov SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: results.sarif

  trivy:
    name: Trivy - Vulnerability Scanner
    runs-on: ubuntu-slim

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (IaC)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail on findings, just report

      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif

      - name: Run Trivy vulnerability scanner (Filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'

  ansible-lint:
    name: Ansible Lint
    runs-on: ubuntu-slim

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install Ansible and ansible-lint with UV
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          uv pip install --system --break-system-packages ansible ansible-lint

      - name: Run ansible-lint
        run: |
          ansible-lint ansible/
        continue-on-error: true

  shellcheck:
    name: ShellCheck - Shell Script Linter
    runs-on: ubuntu-slim

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: warning
        continue-on-error: true

  secret-scan:
    name: GitLeaks - Secret Detection
    runs-on: ubuntu-slim

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better detection

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_COMMENTS: true

  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-slim

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install safety with UV
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          uv pip install --system --break-system-packages safety

      - name: Check Python dependencies
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          uv pip list | safety check --stdin || true

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-slim

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Run markdownlint
        run: |
          markdownlint --config .markdownlint.json '**/*.md' --ignore node_modules || true
        continue-on-error: true

  summary:
    name: Security Summary
    runs-on: ubuntu-slim
    needs: [terraform-security, checkov, trivy, ansible-lint, shellcheck, secret-scan]
    if: always()

    steps:
      - name: Security Scan Summary
        run: |
          echo "## Security Scan Results ðŸ”’" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scanner | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform (Trivy) | ${{ needs.terraform-security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Checkov | ${{ needs.checkov.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy (Full Scan) | ${{ needs.trivy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ansible Lint | ${{ needs.ansible-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ShellCheck | ${{ needs.shellcheck.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GitLeaks | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
