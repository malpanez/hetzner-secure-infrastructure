name: CI - Validate Infrastructure

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday

permissions:
  contents: read
  security-events: write
  pull-requests: write
  checks: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TERRAFORM_VERSION: '1.10.4'
  PYTHON_VERSION: '3.12'
  GO_VERSION: '1.22'

jobs:
  # ========================================
  # Terraform Validation
  # ========================================
  terraform-validate:
    name: Validate Terraform
    runs-on: ubuntu-slim

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        run: |
          cd terraform
          terraform fmt -check -recursive

      - name: Terraform Init
        run: |
          cd terraform
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          cd terraform
          terraform validate

  # ========================================
  # Ansible Validation
  # ========================================
  ansible-validate:
    name: Validate Ansible
    runs-on: ubuntu-slim

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install UV and Ansible
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          export PATH="$HOME/.cargo/bin:$PATH"
          uv venv
          source .venv/bin/activate
          uv pip install ansible ansible-lint yamllint requests python-dateutil

      - name: Install Ansible Galaxy requirements
        run: |
          source .venv/bin/activate
          cd ansible
          ansible-galaxy install -r requirements.yml
        continue-on-error: false

      - name: Create dummy vault password for CI
        run: echo "dummy_password_for_ci_only" > ~/.ansible_vault_pass

      - name: Ansible Syntax Check
        run: |
          source .venv/bin/activate
          cd ansible
          ansible-playbook playbooks/site.yml --syntax-check

      - name: Ansible Lint
        run: |
          source .venv/bin/activate
          cd ansible
          ansible-lint playbooks/site.yml
        continue-on-error: true

      - name: YAML Lint
        run: |
          source .venv/bin/activate
          yamllint ansible/
        continue-on-error: true

  # ========================================
  # Molecule Tests (Ansible Roles)
  # ========================================
  molecule-test:
    name: Test Ansible Roles
    runs-on: ubuntu-latest
    strategy:
      matrix:
        role:
          - apparmor
          - common
          - fail2ban
          - firewall
          - monitoring
          - nginx_wordpress
          - openbao
          - security_hardening
          - ssh_2fa
          - valkey
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install UV and Molecule
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          export PATH="$HOME/.cargo/bin:$PATH"
          uv venv
          source .venv/bin/activate
          uv pip install 'ansible-core>=2.15,<2.18' 'ansible>=8.0,<10.0' molecule 'molecule-plugins[docker]' ansible-lint

      - name: Run Molecule Test
        run: |
          source .venv/bin/activate
          cd ansible/roles/${{ matrix.role }}
          # Use /var/tmp instead of /tmp - /tmp is tmpfs mounted and fails with umask 77
          mkdir -p /var/tmp/ansible-tmp
          chmod 777 /var/tmp/ansible-tmp
          molecule test
        env:
          PY_COLORS: '1'
          ANSIBLE_FORCE_COLOR: '1'
          ALLOW_BROKEN_CONDITIONALS: 'true'
          # Fix for Docker container temp directory permission issues
          # /tmp is tmpfs mounted in molecule containers - use /var/tmp instead
          ANSIBLE_REMOTE_TMP: /var/tmp/ansible-tmp
          ANSIBLE_LOCAL_TMP: /var/tmp/ansible-tmp

  # ========================================
  # Security Scan
  # ========================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-slim

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-results.sarif'
        if: always()

  # ========================================
  # Documentation Check
  # ========================================
  docs-check:
    name: Check Documentation
    runs-on: ubuntu-latest  # Changed from ubuntu-slim to support Docker-based actions

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for broken links in Markdown
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'yes'
        continue-on-error: true

      - name: Verify all docs exist
        run: |
          required_docs=(
            "README.md"
            "docs/INDEX.md"
            "docs/guides/DEPLOYMENT.md"
          )

          missing=0
          for doc in "${required_docs[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "❌ Missing: $doc"
              missing=1
            else
              echo "✅ Found: $doc"
            fi
          done

          exit $missing

  # ========================================
  # Terratest (Go Tests)
  # ========================================
  terratest:
    name: Terratest Infrastructure Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: terraform/test/go.sum

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Download Go modules
        working-directory: terraform/test
        run: go mod download

      - name: Run Terratest (short mode)
        working-directory: terraform/test
        run: go test -v -timeout 15m -short
        env:
          TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN }}

  # ========================================
  # Pre-commit checks
  # ========================================
  pre-commit:
    name: Pre-commit Checks
    runs-on: ubuntu-slim

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install UV and pre-commit
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          export PATH="$HOME/.cargo/bin:$PATH"
          uv venv
          source .venv/bin/activate
          uv pip install pre-commit

      - name: Install terraform-docs
        run: |
          # Install terraform-docs for pre-commit hook
          TFDOCS_VERSION="v0.19.0"
          curl -sSLo /tmp/terraform-docs.tar.gz "https://github.com/terraform-docs/terraform-docs/releases/download/${TFDOCS_VERSION}/terraform-docs-${TFDOCS_VERSION}-linux-amd64.tar.gz"
          tar -xzf /tmp/terraform-docs.tar.gz -C /tmp
          chmod +x /tmp/terraform-docs
          sudo mv /tmp/terraform-docs /usr/local/bin/terraform-docs
          terraform-docs --version

      - name: Cache pre-commit environments
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-

      - name: Run pre-commit
        run: |
          source .venv/bin/activate
          pre-commit run --all-files --show-diff-on-failure
        continue-on-error: true

  # ========================================
  # CodeQL Analysis
  # ========================================
  codeql:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: python, go
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

  # ========================================
  # Dependency Review
  # ========================================
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-slim
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate

  # ========================================
  # Generate Badge
  # ========================================
  generate-badge:
    name: Generate Status Badge
    runs-on: ubuntu-slim
    needs: [terraform-validate, ansible-validate, security-scan]
    if: always()

    steps:
      - name: Create badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: your-gist-id
          filename: hetzner-infra-status.json
          label: build
          message: ${{ needs.terraform-validate.result == 'success' && needs.ansible-validate.result == 'success' && needs.security-scan.result == 'success' && 'passing' || 'failing' }}
          color: ${{ needs.terraform-validate.result == 'success' && needs.ansible-validate.result == 'success' && needs.security-scan.result == 'success' && 'brightgreen' || 'red' }}
        continue-on-error: true
