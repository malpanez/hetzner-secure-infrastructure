name: Ansible Validation

on:
  push:
    branches: [main, develop]
    paths:
      - 'ansible/**'
      - '.github/workflows/ansible-validate.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'ansible/**'

jobs:
  syntax-check:
    name: Syntax Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          pip install ansible ansible-lint yamllint

      - name: Install Ansible Galaxy dependencies
        run: |
          cd ansible
          ansible-galaxy install -r requirements.yml
        continue-on-error: true

      - name: Check Ansible version
        run: ansible --version

      - name: Create dummy vault password for CI
        run: echo "dummy_password_for_ci_only" > ~/.ansible_vault_pass

      - name: Ansible Syntax Check
        run: |
          cd ansible
          ansible-playbook playbooks/site.yml --syntax-check

  lint:
    name: Ansible Lint
    runs-on: ubuntu-latest
    needs: syntax-check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ansible-lint
        run: |
          pip install ansible ansible-lint

      - name: Run ansible-lint
        run: |
          cd ansible
          ansible-lint playbooks/ roles/ -v
        continue-on-error: true

      - name: Generate lint report
        if: always()
        run: |
          cd ansible
          ansible-lint playbooks/ roles/ --parseable > ../ansible-lint-report.txt || true

      - name: Upload lint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ansible-lint-report
          path: ansible-lint-report.txt

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install yamllint
        run: pip install yamllint

      - name: Run yamllint
        run: |
          yamllint -c .yamllint.yml ansible/
        continue-on-error: true

  molecule-test:
    name: Molecule Test
    runs-on: ubuntu-latest
    needs: [syntax-check, lint]
    if: false  # Disabled by default, enable when Molecule tests are created

    strategy:
      matrix:
        role:
          - common
          - security-hardening
          - firewall
          - fail2ban

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Molecule and dependencies
        run: |
          pip install molecule molecule-docker ansible-lint

      - name: Run Molecule test
        run: |
          cd ansible/roles/${{ matrix.role }}
          molecule test

  inventory-test:
    name: Inventory Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: pip install ansible

      - name: Validate inventory structure
        run: |
          cd ansible
          # Test that inventory can be parsed (will fail if no hosts, but validates structure)
          ansible-inventory -i inventory/hetzner.yml --list || true

  summary:
    name: Ansible Validation Summary
    runs-on: ubuntu-latest
    needs: [syntax-check, lint, yaml-lint, inventory-test]
    if: always()

    steps:
      - name: Validation Summary
        run: |
          echo "## Ansible Validation Results ⚙️" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Syntax Check | ${{ needs.syntax-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ansible Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| YAML Lint | ${{ needs.yaml-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Inventory Test | ${{ needs.inventory-test.result }} |" >> $GITHUB_STEP_SUMMARY
