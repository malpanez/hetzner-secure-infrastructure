#cloud-config
# Cloud-init configuration for initial server setup
# This runs BEFORE Ansible hardening

hostname: ${hostname}
fqdn: ${hostname}

# Packages to install on first boot
packages:
  - curl
  - wget
  - vim
  - git
  - htop
  - net-tools
  - python3
  - python3-pip
  - sudo
  - ufw

# Create admin user
users:
  - name: ${username}
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_authorized_keys:
      - ${ssh_pub_key}

# Disable root SSH login immediately
runcmd:
  - sed -i 's/^PermitRootLogin.*/PermitRootLogin prohibit-password/' /etc/ssh/sshd_config
  - systemctl restart sshd
  - apt-get update
  - apt-get upgrade -y
  - echo "Cloud-init completed" > /var/log/cloud-init-status.log

# Timezone
timezone: Europe/Dublin

# Enable automatic security updates
package_update: true
package_upgrade: true
package_reboot_if_required: false

# Set locale
locale: en_IE.UTF-8

# Final message
final_message: "Server ${hostname} is ready after $UPTIME seconds"
