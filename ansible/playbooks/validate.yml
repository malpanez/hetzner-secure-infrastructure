---
# Validation Playbook - Final Checks and Summary
#
# Validates the complete deployment and displays summary information.
#
# Usage:
#   ansible-playbook -i inventory/production.yml playbooks/validate.yml
#
# Tags:
#   - validate: All validation tasks
#   - summary: Deployment summary
#   - checklist: Post-deployment checklist

# ========================================
# Final Validation & Summary
# ========================================
- name: Validate complete deployment
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: Verify all servers are accessible
      ansible.builtin.ping:
      tags: [validate]

    - name: Gather service facts
      ansible.builtin.service_facts:
      tags: [validate]

    - name: Check critical services
      ansible.builtin.assert:
        that:
          - ansible_facts.services['ssh.service'].state == 'running'
          - not (firewall_enabled | default(true)) or (
              (ansible_facts.services['ufw.service'] is defined) and
              (
                ansible_facts.services['ufw.service'].state in ['running', 'exited'] or
                ansible_facts.services['ufw.service'].status == 'enabled'
              )
            )
        fail_msg: Critical services not running!
        success_msg: All critical services operational
      tags: [validate]

    - name: Display comprehensive deployment summary
      ansible.builtin.debug:
        msg: "{{ summary_message.split('\n') }}"
      vars:
        summary_message: |
          ========================================
          DEPLOYMENT COMPLETE
          ========================================

          Infrastructure Overview:
          {% if groups['wordpress_servers'] is defined %}
          WordPress Servers: {{ groups['wordpress_servers'] | length }}
          {% for host in groups['wordpress_servers'] %}
             - {{ host }}: {{ hostvars[host]['ansible_host'] | default('N/A') }}
          {% endfor %}
          {% endif %}

          {% if groups['secrets_servers'] is defined %}
          OpenBao Servers: {{ groups['secrets_servers'] | length }}
          {% for host in groups['secrets_servers'] %}
             - {{ host }}: {{ hostvars[host]['ansible_host'] | default('N/A') }}
          {% endfor %}
          {% endif %}

          {% if groups['monitoring_servers'] is defined %}
          Monitoring Servers: {{ groups['monitoring_servers'] | length }}
          {% for host in groups['monitoring_servers'] %}
             - {{ host }}: {{ hostvars[host]['ansible_host'] | default('N/A') }}
          {% endfor %}
          {% endif %}

          Security Features Enabled:
          {% if firewall_enabled | default(true) %}
          [x] UFW Firewall
          {% endif %}
          {% if fail2ban_enabled | default(true) %}
          [x] Fail2ban IDS
          {% endif %}
          {% if apparmor_enabled | default(true) %}
          [x] AppArmor MAC
          {% endif %}
          {% if ssh_2fa_enabled | default(true) %}
          [x] SSH 2FA
          {% endif %}
          [x] Kernel Hardening
          [x] Auto Security Updates

          All systems operational and secured!

          ========================================
      run_once: true
      delegate_to: localhost
      tags: [validate, summary, always]

# ========================================
# Post-Deployment Recommendations
# ========================================
- name: Display post-deployment checklist
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Build post-deployment checklist
      ansible.builtin.set_fact:
        # yamllint disable rule:line-length
        ssh_commands: >-
          {% for host in groups.get('hetzner', []) %}
          ssh {{ hostvars[host]['ansible_user'] | default('malpanez') }}@{{ hostvars[host]['ansible_host'] | default(host) }}
          {% endfor %}
        openbao_host: "{{ hostvars[groups['secrets_servers'][0]]['ansible_host'] | default('N/A') if groups['secrets_servers'] is defined and groups['secrets_servers'] | length > 0 else 'N/A' }}"
        monitoring_host: "{{ hostvars[groups['monitoring_servers'][0]]['ansible_host'] | default('N/A') if groups['monitoring_servers'] is defined and groups['monitoring_servers'] | length > 0 else 'N/A' }}"
        wordpress_host: "{{ hostvars[groups['wordpress_servers'][0]]['ansible_host'] | default('N/A') if groups['wordpress_servers'] is defined and groups['wordpress_servers'] | length > 0 else 'N/A' }}"
        wordpress_domain: "{{ hostvars[groups['wordpress_servers'][0]]['wordpress_domain'] | default(domain_name) | default('example.com') if groups['wordpress_servers'] is defined and groups['wordpress_servers'] | length > 0 else 'example.com' }}"
        # yamllint enable rule:line-length
      run_once: true
      tags: [info, checklist, always]

    - name: Show post-deployment tasks
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "      POST-DEPLOYMENT CHECKLIST           "
          - "=========================================="
          - ""
          - "1. Test SSH Access:"
          - "   {{ ssh_commands | trim }}"
          - ""
          - "2. Security Verification:"
          - "   sudo aa-status              # AppArmor"
          - "   sudo ufw status verbose     # Firewall"
          - "   sudo fail2ban-client status # IDS"
          - "   sudo sshd -t                # SSH config"
          - ""
          - "3. OpenBao Setup:"
          - "   export VAULT_ADDR='https://{{ openbao_host }}:8200'"
          - "   bao operator init"
          - "   # SAVE UNSEAL KEYS!"
          - ""
          - "4. Monitoring Access:"
          - "   Prometheus: http://{{ monitoring_host }}:9090"
          - "   Grafana:    http://{{ monitoring_host }}:3000"
          - ""
          - "5. WordPress Setup:"
          - "   SSL:   sudo certbot --nginx -d {{ wordpress_domain }}"
          - "   Admin: https://{{ wordpress_domain }}/wp-admin"
          - "   Install LearnDash Pro (requires license)"
          - ""
          - "=========================================="
      run_once: true
      tags: [info, checklist, always]
