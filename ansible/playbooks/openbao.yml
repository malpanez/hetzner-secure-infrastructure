---
# OpenBao Playbook - Secrets Management Deployment
#
# Deploys OpenBao (HashiCorp Vault alternative) for secrets management.
#
# Usage:
#   ansible-playbook -i inventory/production.yml playbooks/openbao.yml
#
# Tags:
#   - openbao: All OpenBao tasks
#   - secrets: Secrets management
#   - bootstrap: OpenBao initialization

- name: Deploy OpenBao secrets management
  hosts: secrets_servers
  become: true
  gather_facts: true

  pre_tasks:
    - name: Check OpenBao deployment status
      ansible.builtin.debug:
        msg: >-
          OpenBao will {{ 'be deployed' if (deploy_openbao | default(true) | bool)
          else 'NOT be deployed' }} on {{ inventory_hostname }}
      tags: [openbao]

  roles:
    - role: openbao
      tags: [openbao, secrets]
      when: deploy_openbao | default(true) | bool

  post_tasks:
    - name: Display OpenBao information
      ansible.builtin.debug:
        msg:
          - "========================================"
          - "OpenBao Deployed Successfully"
          - "========================================"
          - ""
          - "Server: {{ inventory_hostname }}"
          - "Address: {{ openbao_api_addr }}"
          - ""
          - "Manual initialization required:"
          - "1. SSH: ssh {{ ansible_user }}@{{ ansible_host }}"
          - "2. Export: export VAULT_ADDR='{{ openbao_api_addr }}'"
          - "3. Initialize: bao operator init"
          - "4. Save unseal keys and root token!"
          - "5. Unseal: bao operator unseal (3 times with different keys)"
          - ""
          - "========================================"
      when: deploy_openbao | default(true) | bool
      tags: [openbao, info]

# ========================================
# OpenBao Bootstrap (Init + Seed Secrets)
# ========================================
- name: Bootstrap OpenBao and seed secrets
  hosts: secrets_servers
  become: true
  gather_facts: false

  vars:
    openbao_cli: "{{ openbao_binary_path | default('bao') }}"
    openbao_env_base:
      VAULT_ADDR: "{{ openbao_api_addr }}"
    openbao_env: >-
      {{ openbao_env_base | combine(
        openbao_tls_self_signed | default(true) | bool | ternary({'VAULT_SKIP_VERIFY': '1'}, {})
      ) }}

  tasks:
    - name: Run OpenBao bootstrap tasks (opt-in)
      ansible.builtin.include_tasks: tasks/openbao-bootstrap.yml
      when: openbao_bootstrap_enabled | default(false) | bool
      tags: [openbao, bootstrap]
