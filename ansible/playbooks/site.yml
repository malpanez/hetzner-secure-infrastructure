---
# Main Site Playbook - Orchestrator
#
# Follows Red Hat CoP Automation Good Practices:
# https://redhat-cop.github.io/automation-good-practices/
#
# This playbook imports all component playbooks in the correct order:
# 1. common.yml - Base configuration and security hardening (all servers)
# 2. openbao.yml - Secrets management (secrets_servers)
# 3. wordpress.yml - Application stack (wordpress_servers)
# 4. monitoring.yml - Observability stack (monitoring_servers)
# 5. validate.yml - Final validation and summary
#
# Prerequisites:
#   ansible-galaxy install -r requirements.yml
#
# Usage:
#   # Full deployment
#   ansible-playbook -i inventory/production.yml playbooks/site.yml
#
#   # Individual playbooks (recommended for targeted runs)
#   ansible-playbook -i inventory/production.yml playbooks/common.yml
#   ansible-playbook -i inventory/production.yml playbooks/wordpress.yml
#   ansible-playbook -i inventory/production.yml playbooks/monitoring.yml
#
#   # With tags
#   ansible-playbook -i inventory/production.yml playbooks/site.yml --tags security
#   ansible-playbook -i inventory/production.yml playbooks/site.yml --tags wordpress
#
#   # Limit to specific hosts
#   ansible-playbook -i inventory/production.yml playbooks/site.yml --limit wordpress-prod
#
# Architecture:
# - Uses official Ansible Galaxy collections (grafana.grafana, prometheus.prometheus)
# - Uses trusted community roles (geerlingguy.mysql)
# - Custom roles for project-specific requirements

# ========================================
# Phase 1: Common Configuration (All Servers)
# ========================================
# Base system setup, security hardening, firewall, fail2ban, apparmor
# This MUST run first to establish security baseline
- name: Import common playbook
  ansible.builtin.import_playbook: common.yml
  tags: [common, security]

# ========================================
# Phase 2: Secrets Management
# ========================================
# OpenBao deployment (requires transit token in vault for auto-unseal)
#
# FIRST TIME SETUP (run these manually BEFORE site.yml):
#   1. ansible-playbook playbooks/openbao.yml
#   2. ansible-playbook playbooks/openbao-transit-bootstrap.yml -e openbao_transit_bootstrap_ack=true
#   3. Save transit unseal keys to password manager
#   4. ansible-vault edit inventory/group_vars/all/secrets.yml
#      Add: vault_openbao_transit_token: "s.xxxxx"
#   5. Now run: ansible-playbook playbooks/site.yml
#
- name: Import OpenBao playbook
  ansible.builtin.import_playbook: openbao.yml
  tags: [openbao, secrets]

# ========================================
# Phase 3: Application Stack
# ========================================
# WordPress with MariaDB, Valkey, Nginx
- name: Import WordPress playbook
  ansible.builtin.import_playbook: wordpress.yml
  tags: [wordpress, application]

# ========================================
# Phase 4: Monitoring Stack
# ========================================
# Node Exporter, Prometheus, Loki, Promtail, Grafana
# Runs AFTER applications are deployed so metrics are available
- name: Import monitoring playbook
  ansible.builtin.import_playbook: monitoring.yml
  tags: [monitoring, observability]

# ========================================
# Phase 5: Validation
# ========================================
# Final checks and deployment summary
- name: Import validation playbook
  ansible.builtin.import_playbook: validate.yml
  tags: [validate, summary]
