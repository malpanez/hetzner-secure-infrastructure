---
# Main Site Playbook - Flexible Multi-Server Deployment
#
# Follows Red Hat CoP Automation Good Practices:
# https://redhat-cop.github.io/automation-good-practices/
#
# Deploys infrastructure based on inventory configuration:
# - All-in-one (everything on one server)
# - Separated (each service on dedicated server)
# - Hybrid (mix of shared and dedicated)
#
# Prerequisites:
#   ansible-galaxy install -r requirements.yml
#
# Usage:
#   ansible-playbook -i inventory/production.yml playbooks/site.yml
#
# Selective deployment:
#   ansible-playbook -i inventory/production.yml playbooks/site.yml --tags wordpress
#   ansible-playbook -i inventory/production.yml playbooks/site.yml --tags openbao
#   ansible-playbook -i inventory/production.yml playbooks/site.yml --limit wordpress-prod
#
# Architecture:
# - Uses official Ansible Galaxy collections (grafana.grafana, prometheus.prometheus)
# - Uses trusted community roles (geerlingguy.mysql)
# - Custom roles for project-specific requirements

# ========================================
# Common Configuration (All Servers)
# ========================================
- name: Apply common security hardening to all servers
  hosts: hetzner
  become: true
  gather_facts: true

  pre_tasks:
    - name: Display deployment information
      ansible.builtin.debug:
        msg:
          - "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          - "‚ïë              DEPLOYMENT - STARTING                        ‚ïë"
          - "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          - ""
          - "üìç Target Host"
          - "‚îú‚îÄ Hostname:     {{ inventory_hostname }}"
          - "‚îú‚îÄ IP Address:   {{ ansible_default_ipv4.address | default('N/A') }}"
          - "‚îî‚îÄ Groups:       {{ group_names | join(', ') }}"
          - ""
          - "üíª System Information"
          - "‚îú‚îÄ OS:           {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "‚îú‚îÄ Kernel:       {{ ansible_kernel }}"
          - "‚îú‚îÄ Architecture: {{ ansible_architecture }}"
          - "‚îî‚îÄ CPUs:         {{ ansible_processor_vcpus }}"
          - ""
          - "üîß Configuration"
          - "‚îú‚îÄ User:         {{ ansible_user }}"
          - "‚îú‚îÄ Python:       {{ ansible_python_version }}"
          - "‚îî‚îÄ SSH Port:     {{ ansible_port | default(22) }}"
          - ""
          - "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
      tags: [always]

    - name: Update apt cache (Debian/Ubuntu)
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      when: ansible_os_family == 'Debian'
      tags: [always]

    - name: Check OS compatibility
      ansible.builtin.assert:
        that:
          - ansible_distribution in ['Debian', 'Ubuntu']
          - ansible_distribution_major_version | int >= 12
        fail_msg: This playbook requires Debian 12+ or Ubuntu 22.04+
        success_msg: OS compatibility check passed
      tags: [always]

  roles:

    - role: common
      tags: [common, base]

    - role: security_hardening
      tags: [security, hardening]

    # IMPORTANT: SSH 2FA must run BEFORE firewall to ensure SSH is configured
    # before UFW locks down the system
    - role: ssh_2fa
      tags: [security, ssh, 2fa]
      when: ssh_2fa_enabled | default(true) | bool

    # Firewall runs AFTER SSH is configured to avoid lockout
    - role: firewall
      tags: [security, firewall]
      when: firewall_enabled | default(true) | bool

    - role: fail2ban
      tags: [security, fail2ban]
      when: fail2ban_enabled | default(true) | bool

    - role: apparmor
      tags: [security, apparmor]
      when:
        - apparmor_enabled | default(true) | bool
        - ansible_distribution in ['Debian', 'Ubuntu']

  post_tasks:
    - name: Flush handlers
      ansible.builtin.meta: flush_handlers
      tags: [always]

# ========================================
# Reboot if Required (Kernel Parameters)
# ========================================
- name: Reboot servers if kernel parameters changed
  hosts: hetzner
  become: true
  gather_facts: true

  tasks:
    - name: Display reboot status
      ansible.builtin.debug:
        msg: "Reboot {{ 'IS' if (ansible_reboot_required | default(false)) else 'is NOT' }} required for this server"
      tags: [reboot, always]

    - name: Reboot server if required
      ansible.builtin.reboot:
        msg: "Rebooting to apply kernel parameters (audit=1, AppArmor, etc.)"
        connect_timeout: 10
        reboot_timeout: 600
        pre_reboot_delay: 5
        post_reboot_delay: 30
        test_command: "systemctl is-system-running || true"
      when: ansible_reboot_required | default(false)
      tags: [reboot]

    - name: Wait for SSH to be fully available
      ansible.builtin.wait_for_connection:
        delay: 10
        timeout: 300
      when: ansible_reboot_required | default(false)
      tags: [reboot]

    - name: Verify UFW is running and SSH is allowed
      ansible.builtin.shell: |
        ufw status | grep -q "Status: active" && \
        ufw status | grep -q "22/tcp" && \
        echo "UFW OK"
      register: ufw_check
      changed_when: false
      failed_when: false
      when: ansible_reboot_required | default(false)
      tags: [reboot, firewall]

    - name: Display UFW status after reboot
      ansible.builtin.debug:
        msg: "UFW Status: {{ ufw_check.stdout | default('Not checked') }}"
      when: ansible_reboot_required | default(false)
      tags: [reboot, firewall]

    - name: Gather facts after reboot
      ansible.builtin.setup:
      when: ansible_reboot_required | default(false)
      tags: [reboot]

# ========================================
# Post-Reboot Security Services
# ========================================
- name: Start security services after reboot
  hosts: hetzner
  become: true
  gather_facts: true

  tasks:
    - name: Start auditd after reboot
      ansible.builtin.systemd:
        name: auditd
        enabled: true
        state: started
      when:
        - ansible_reboot_required | default(false)
        - security_hardening_auditd_enabled | default(true)
      failed_when: false
      tags: [security, auditd]

# ========================================
# OpenBao Servers (Secrets Management)
# ========================================
- name: Deploy OpenBao secrets management
  hosts: secrets_servers
  become: true
  gather_facts: true

  pre_tasks:
    - name: Check OpenBao deployment status
      ansible.builtin.debug:
        msg: >-
          OpenBao will {{ 'be deployed' if (deploy_openbao | default(true) | bool)
          else 'NOT be deployed' }} on {{ inventory_hostname }}
      tags: [openbao]

  roles:
    - role: openbao
      tags: [openbao, secrets]
      when: deploy_openbao | default(true) | bool

  post_tasks:
    - name: Display OpenBao information
      ansible.builtin.debug:
        msg: |-
          ========================================
          OpenBao Deployed Successfully
          ========================================

          Server: {{ inventory_hostname }}
          Address: {{ openbao_api_addr }}

          Manual initialization required:
          1. SSH: ssh {{ ansible_user }}@{{ ansible_host }}
          2. Export: export VAULT_ADDR='{{ openbao_api_addr }}'
          3. Initialize: bao operator init
          4. Save unseal keys and root token!
          5. Unseal: bao operator unseal (3 times with different keys)

          ========================================
      when: deploy_openbao | default(true) | bool
      tags: [openbao, info]

# ========================================
# Monitoring Servers (Prometheus + Grafana)
# ========================================
- name: Deploy monitoring stack
  hosts: monitoring_servers
  become: true
  gather_facts: true

  pre_tasks:
    - name: Check monitoring deployment status
      ansible.builtin.debug:
        msg: Monitoring will {{ 'be deployed' if (deploy_monitoring | default(true) | bool) else 'NOT be deployed' }} on {{ inventory_hostname }}
      tags: [monitoring]

  roles:
    # Use official Prometheus Community collection
    - role: prometheus.prometheus.prometheus
      tags: [monitoring, prometheus]
      when: deploy_monitoring | default(true) | bool

    # Use official Grafana Labs collection
    - role: grafana.grafana.loki
      tags: [monitoring, loki, logging]
      when: deploy_loki | default(true) | bool

    - role: grafana.grafana.promtail
      tags: [monitoring, promtail, logging]
      when: deploy_promtail | default(true) | bool

    - role: grafana.grafana.grafana
      tags: [monitoring, grafana]
      when: deploy_monitoring | default(true) | bool

  post_tasks:
    # Ensure Prometheus file service discovery is properly configured
    - name: Prometheus | Post-config | Ensure file_sd directory exists
      ansible.builtin.file:
        path: "{{ prometheus_config_dir | default('/etc/prometheus') }}/file_sd"
        state: directory
        owner: prometheus
        group: prometheus
        mode: '0755'
      when: deploy_monitoring | default(true) | bool
      tags: [monitoring, prometheus, post-config]

    - name: Prometheus | Post-config | Create Node Exporter target file
      ansible.builtin.copy:
        dest: "{{ prometheus_config_dir | default('/etc/prometheus') }}/file_sd/node.yml"
        owner: prometheus
        group: prometheus
        mode: '0644'
        content: |
          ---
          - targets:
            - localhost:9100
            labels:
              instance: "{{ inventory_hostname }}"
              job: node_exporter
      when: deploy_monitoring | default(true) | bool
      notify: restart prometheus
      tags: [monitoring, prometheus, post-config]

    - name: Prometheus | Post-config | Restart Prometheus if config changed
      ansible.builtin.systemd:
        name: prometheus
        state: restarted
      when: deploy_monitoring | default(true) | bool
      tags: [monitoring, prometheus, post-config]

    - name: Display monitoring information
      ansible.builtin.debug:
        msg: |
          ========================================
          Monitoring Stack Deployed
          ========================================

          Prometheus: http://{{ ansible_host }}:{{ prometheus_port | default(9090) }}
          Loki: http://{{ ansible_host }}:{{ loki_http_listen_port | default(3100) }}
          Grafana: http://{{ ansible_host }}:{{ grafana_ini.server.http_port | default(3000) }}

          Default credentials:
          - Username: {{ grafana_ini.security.admin_user | default('admin') }}
          - Password: {{ grafana_ini.security.admin_password | default('changeme123') }}

          Grafana Data Sources:
          - Prometheus (metrics)
          - Loki (logs)

          Dashboards:
          - Node Exporter Full (#1860)
          - Prometheus Stats (#3662)

          Access via Nginx reverse proxy:
          - prometheus.{{ ansible_host }} ‚Üí http://localhost:9090
          - grafana.{{ ansible_host }} ‚Üí http://localhost:3000

          ========================================
      when: deploy_monitoring | default(true) | bool
      tags: [monitoring, info]

# ========================================
# Node Exporter (All Monitored Servers)
# ========================================
- name: Deploy Node Exporter metrics
  hosts: monitored_servers
  become: true
  gather_facts: true

  roles:
    # Use official Prometheus Community collection
    - role: prometheus.prometheus.node_exporter
      tags: [monitoring, node_exporter, metrics]
      when: node_exporter_enabled | default(true) | bool

# ========================================
# WordPress Application Servers
# ========================================
- name: Deploy WordPress application stack
  hosts: wordpress_servers
  become: true
  gather_facts: true

  roles:
    # Use Galaxy role for MariaDB
    - role: geerlingguy.mysql
      tags: [wordpress, database, mariadb]
      vars:
        mysql_databases:
          - name: "{{ wordpress_db_name | default('wordpress') }}"
            encoding: utf8mb4
            collation: utf8mb4_unicode_ci
        mysql_users:
          - name: "{{ wordpress_db_user | default('wordpress') }}"
            host: localhost
            password: "{{ wordpress_db_password }}"
            priv: "{{ wordpress_db_name | default('wordpress') }}.*:ALL"
      when: deploy_mariadb | default(true) | bool

    # Custom roles
    - role: valkey
      tags: [wordpress, redis, cache, performance]
      when: deploy_valkey | default(true) | bool

    - role: nginx_wordpress
      tags: [wordpress, nginx, webserver]

  tasks:
    - name: Create OpenBao config directory
      ansible.builtin.file:
        path: /etc/openbao
        state: directory
        owner: root
        group: root
        mode: '0750'
      when: openbao_rotation_enabled | default(true) | bool
      tags: [wordpress, openbao, rotation]

    - name: Install OpenBao environment file for rotation
      ansible.builtin.copy:
        dest: /etc/openbao/wordpress.env
        owner: root
        group: root
        mode: '0640'
        content: |
          VAULT_ADDR={{ openbao_api_addr | default('https://' ~ ansible_host ~ ':8200') }}
          {% if openbao_tls_self_signed | default(true) | bool %}
          VAULT_SKIP_VERIFY=1
          {% endif %}
      when: openbao_rotation_enabled | default(true) | bool
      tags: [wordpress, openbao, rotation]

    - name: Install OpenBao token for WordPress rotation
      ansible.builtin.copy:
        dest: /etc/openbao/wordpress.token
        owner: root
        group: root
        mode: '0400'
        content: "{{ openbao_wordpress_rotation_token | default(hostvars['localhost'].openbao_wordpress_token) }}"
      when:
        - openbao_rotation_enabled | default(true) | bool
        - openbao_wordpress_rotation_token is defined or hostvars['localhost'].openbao_wordpress_token is defined
      tags: [wordpress, openbao, rotation]

    - name: Install WordPress credential rotation script
      ansible.builtin.copy:
        dest: /usr/local/bin/openbao-rotate-wordpress.sh
        owner: root
        group: root
        mode: '0750'
        content: |
          #!/usr/bin/env bash
          set -euo pipefail

          OPENBAO_CLI="/usr/local/bin/bao"
          TOKEN_FILE="/etc/openbao/wordpress.token"
          ENV_FILE="/etc/openbao/wordpress.env"
          WP_CONFIG="{{ nginx_wordpress_web_root }}/wp-config.php"
          STATE_FILE="/var/lib/openbao/wp-rotation.timestamp"
          PHP_FPM_SERVICE="php{{ nginx_wordpress_php_version }}-fpm"
          ROTATION_SECONDS=$((90*24*60*60))

          if [[ ! -f "${TOKEN_FILE}" ]]; then
            echo "Missing token file: ${TOKEN_FILE}" >&2
            exit 1
          fi

          if [[ -f "${ENV_FILE}" ]]; then
            set -a
            # shellcheck disable=SC1090
            source "${ENV_FILE}"
            set +a
          fi

          export VAULT_TOKEN
          VAULT_TOKEN="$(cat "${TOKEN_FILE}")"

          if [[ -f "${STATE_FILE}" ]]; then
            last_rotation="$(stat -c %Y "${STATE_FILE}")"
            now="$(date +%s)"
            if (( now - last_rotation < ROTATION_SECONDS )); then
              exit 0
            fi
          fi

          "${OPENBAO_CLI}" token renew -increment=2160h >/dev/null 2>&1 || true

          OPENBAO_CREDS="$("${OPENBAO_CLI}" read -format=json database/creds/wordpress)"
          export OPENBAO_CREDS

          python3 - "${WP_CONFIG}" <<'PY'
          import json
          import os
          import re
          import sys

          wp_config = sys.argv[1]
          data = json.loads(os.environ["OPENBAO_CREDS"])
          username = data["data"]["username"]
          password = data["data"]["password"]

          with open(wp_config, "r", encoding="utf-8") as fh:
            contents = fh.read()

          contents, user_count = re.subn(
            r"define\('DB_USER',\s*'[^']*'\);",
            "define('DB_USER', '{}');".format(username),
            contents,
          )
          contents, pass_count = re.subn(
            r"define\('DB_PASSWORD',\s*'[^']*'\);",
            "define('DB_PASSWORD', '{}');".format(password),
            contents,
          )

          if user_count != 1 or pass_count != 1:
            raise SystemExit("Failed to update wp-config.php credentials")

          with open(wp_config, "w", encoding="utf-8") as fh:
            fh.write(contents)
          PY

          mkdir -p "$(dirname "${STATE_FILE}")"
          date +%s > "${STATE_FILE}"

          systemctl reload "${PHP_FPM_SERVICE}" >/dev/null 2>&1 || systemctl restart "${PHP_FPM_SERVICE}"
      when: openbao_rotation_enabled | default(true) | bool
      tags: [wordpress, openbao, rotation]

    - name: Install systemd service for WordPress rotation
      ansible.builtin.copy:
        dest: /etc/systemd/system/openbao-rotate-wordpress.service
        owner: root
        group: root
        mode: '0644'
        content: |
          [Unit]
          Description=Rotate WordPress DB credentials via OpenBao
          After=network-online.target

          [Service]
          Type=oneshot
          ExecStart=/usr/local/bin/openbao-rotate-wordpress.sh
      when: openbao_rotation_enabled | default(true) | bool
      tags: [wordpress, openbao, rotation]

    - name: Install systemd timer for WordPress rotation
      ansible.builtin.copy:
        dest: /etc/systemd/system/openbao-rotate-wordpress.timer
        owner: root
        group: root
        mode: '0644'
        content: |
          [Unit]
          Description=Rotate WordPress DB credentials every 90 days

          [Timer]
          OnCalendar=daily
          Persistent=true

          [Install]
          WantedBy=timers.target
      when: openbao_rotation_enabled | default(true) | bool
      tags: [wordpress, openbao, rotation]

    - name: Enable WordPress rotation timer
      ansible.builtin.systemd:
        name: openbao-rotate-wordpress.timer
        enabled: true
        state: started
        daemon_reload: true
      when: openbao_rotation_enabled | default(true) | bool
      tags: [wordpress, openbao, rotation]

  post_tasks:
    - name: Display WordPress deployment information
      ansible.builtin.debug:
        msg: |-
          ========================================
          WordPress Stack Deployed
          ========================================

          Server: {{ inventory_hostname }}
          IP: {{ ansible_host }}
          URL: http://{{ ansible_host }}

          WordPress already installed and configured!
          Database: {{ wordpress_db_name | default('wordpress') }}
          Admin User: {{ nginx_wordpress_admin_user | default('admin') }}

          Next steps:
          1. Access WordPress: http://{{ ansible_host }}/wp-admin
          2. Configure CloudFlare + SSL later
          3. Configure security plugins (Wordfence, WP 2FA)
          4. Install LearnDash Pro manually (requires license)

          ========================================
      tags: [wordpress, info]

# ========================================
# OpenBao Bootstrap (Init + Seed Secrets)
# ========================================
- name: Bootstrap OpenBao and seed secrets
  hosts: secrets_servers
  become: true
  gather_facts: false

  vars:
    openbao_cli: "{{ openbao_binary_path | default('bao') }}"
    openbao_env_base:
      VAULT_ADDR: "{{ openbao_api_addr }}"
    openbao_env: "{{ openbao_env_base | combine(openbao_tls_self_signed | default(true) | bool | ternary({'VAULT_SKIP_VERIFY': '1'}, {})) }}"

  tasks:
    - name: Run OpenBao bootstrap tasks (opt-in)
      ansible.builtin.include_tasks: tasks/openbao-bootstrap.yml
      when: openbao_bootstrap_enabled | default(false) | bool
      tags: [openbao, bootstrap]

# ========================================
# Final Validation & Summary
# ========================================
- name: Validate complete deployment
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: Verify all servers are accessible
      ansible.builtin.ping:
      tags: [validate]
    - name: Gather service facts
      ansible.builtin.service_facts:
      tags: [validate]
    - name: Check critical services
      ansible.builtin.assert:
        that:
          - ansible_facts.services['ssh.service'].state == 'running'
          - not (firewall_enabled | default(true)) or (
              (ansible_facts.services['ufw.service'] is defined) and
              (
                ansible_facts.services['ufw.service'].state in ['running', 'exited'] or
                ansible_facts.services['ufw.service'].status == 'enabled'
              )
            )
        fail_msg: Critical services not running!
        success_msg: All critical services operational
      tags: [validate]
    - name: Display comprehensive deployment summary
      ansible.builtin.debug:
        msg: "{{ summary_message.split('\n') }}"
      vars:
        summary_message: |
          ========================================
          üéâ DEPLOYMENT COMPLETE
          ========================================

          Infrastructure Overview:
          {% if groups['wordpress_servers'] is defined %}
          üìù WordPress Servers: {{ groups['wordpress_servers'] | length }}
          {% for host in groups['wordpress_servers'] %}
             - {{ host }}: {{ hostvars[host]['ansible_host'] | default('N/A') }}
          {% endfor %}
          {% endif %}

          {% if groups['secrets_servers'] is defined %}
          üîê OpenBao Servers: {{ groups['secrets_servers'] | length }}
          {% for host in groups['secrets_servers'] %}
             - {{ host }}: {{ hostvars[host]['ansible_host'] | default('N/A') }}
          {% endfor %}
          {% endif %}

          {% if groups['monitoring_servers'] is defined %}
          üìä Monitoring Servers: {{ groups['monitoring_servers'] | length }}
          {% for host in groups['monitoring_servers'] %}
             - {{ host }}: {{ hostvars[host]['ansible_host'] | default('N/A') }}
          {% endfor %}
          {% endif %}

          Security Features Enabled:
          {% if firewall_enabled | default(true) %}
          ‚úÖ UFW Firewall
          {% endif %}
          {% if fail2ban_enabled | default(true) %}
          ‚úÖ Fail2ban IDS
          {% endif %}
          {% if apparmor_enabled | default(true) %}
          ‚úÖ AppArmor MAC
          {% endif %}
          {% if ssh_2fa_enabled | default(true) %}
          ‚úÖ SSH 2FA
          {% endif %}
          ‚úÖ Kernel Hardening
          ‚úÖ Auto Security Updates

          üéØ All systems operational and secured!

          ========================================
      run_once: true
      delegate_to: localhost
      tags: [validate, summary, always]

# ========================================
# Post-Deployment Recommendations
# ========================================
- name: Display post-deployment checklist
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Show post-deployment tasks
      ansible.builtin.debug:
        msg: "{{ checklist_message.split('\n') }}"
      vars:
        checklist_message: |
          ========================================
          üìã POST-DEPLOYMENT CHECKLIST
          ========================================

          ‚ö†Ô∏è CRITICAL - Test SSH Access:
          {% for host in groups.get('hetzner', []) %}
          ssh {{ hostvars[host]['ansible_user'] }}@{{ hostvars[host]['ansible_host'] }}
          {% endfor %}

          üîí Security Verification:
          {% for host in groups.get('hetzner', []) %}
          On {{ host }}:
          - sudo aa-status              # AppArmor profiles
          - sudo ufw status verbose     # Firewall rules
          - sudo fail2ban-client status # IDS status
          - sudo sshd -t                # SSH config valid
          {% endfor %}

          üîê OpenBao Setup (if deployed):
          {% if groups['secrets_servers'] is defined %}
          {% for host in groups['secrets_servers'] %}
          ssh {{ hostvars[host]['ansible_user'] }}@{{ hostvars[host]['ansible_host'] }}
          export VAULT_ADDR='https://{{ hostvars[host]['ansible_host'] }}:8200'
          bao operator init
          # SAVE UNSEAL KEYS!
          {% endfor %}
          {% endif %}

          üìä Monitoring Access (if deployed):
          {% if groups['monitoring_servers'] is defined %}
          {% for host in groups['monitoring_servers'] %}
          Prometheus: http://{{ hostvars[host]['ansible_host'] }}:9090
          Grafana: http://{{ hostvars[host]['ansible_host'] }}:3000
          {% endfor %}
          {% endif %}

          üìù WordPress Setup (if deployed):
          {% if groups['wordpress_servers'] is defined %}
          {% for host in groups['wordpress_servers'] %}
          1. Get SSL: sudo certbot --nginx -d {{ hostvars[host]['wordpress_domain'] }}
          2. Install WordPress (see above)
          3. Install Tutor LMS
          4. Configure Cloudflare (if enabled)
          {% endfor %}
          {% endif %}

          ========================================
      run_once: true
      tags: [info, checklist, always]
