---
- name: Check OpenBao status
  ansible.builtin.command: "{{ openbao_cli }} status -format=json"
  environment: "{{ openbao_env }}"
  register: openbao_status_cmd
  changed_when: false
  failed_when: false
  tags: [openbao, bootstrap]

- name: Parse OpenBao status
  ansible.builtin.set_fact:
    openbao_status: "{{ (openbao_status_cmd.stdout | default('{}')) | from_json }}"
  when: openbao_status_cmd.rc == 0
  tags: [openbao, bootstrap]

- name: Initialize OpenBao (first run only)
  ansible.builtin.command: >-
    {{ openbao_cli }} operator init
    -format=json
    -key-shares={{ openbao_key_shares }}
    -key-threshold={{ openbao_key_threshold }}
  environment: "{{ openbao_env }}"
  register: openbao_init_cmd
  changed_when: true
  when: not ((openbao_status | default({})).initialized | default(false) | bool)
  no_log: true
  tags: [openbao, bootstrap]

- name: Capture OpenBao init output
  ansible.builtin.set_fact:
    openbao_init: "{{ (openbao_init_cmd.stdout | default('{}')) | from_json }}"
    openbao_bootstrap_token: "{{ (openbao_init_cmd.stdout | from_json).root_token }}"
  when:
    - openbao_init_cmd is defined
    - openbao_init_cmd is not skipped
    - openbao_init_cmd.stdout is defined
  no_log: true
  tags: [openbao, bootstrap]

- name: Unseal OpenBao (using first threshold keys)
  ansible.builtin.command: "{{ openbao_cli }} operator unseal {{ item }}"
  environment: "{{ openbao_env }}"
  loop: "{{ openbao_init.unseal_keys_b64[0:openbao_key_threshold] }}"
  when: openbao_init is defined
  no_log: true
  tags: [openbao, bootstrap]

- name: Enable KV secrets engine (kv-v2)
  ansible.builtin.command: "{{ openbao_cli }} secrets enable -path=secret kv-v2"
  environment: "{{ openbao_env | combine({'VAULT_TOKEN': openbao_bootstrap_token}) }}"
  register: openbao_kv_enable
  changed_when: openbao_kv_enable.rc == 0
  failed_when: false
  when: openbao_bootstrap_token is defined
  tags: [openbao, bootstrap]

- name: Seed WordPress database credentials in OpenBao
  ansible.builtin.command: >-
    {{ openbao_cli }} kv put secret/wordpress
    db_name={{ wordpress_db_name | default('wordpress') }}
    db_user={{ wordpress_db_user | default('wordpress') }}
    db_password={{ wordpress_db_password }}
  environment: "{{ openbao_env | combine({'VAULT_TOKEN': openbao_bootstrap_token}) }}"
  when: openbao_bootstrap_token is defined
  no_log: true
  tags: [openbao, bootstrap]

- name: Seed MariaDB root password in OpenBao
  ansible.builtin.command: >-
    {{ openbao_cli }} kv put secret/mariadb
    root_password={{ mariadb_root_password | default(vault_mariadb_root_password) }}
  environment: "{{ openbao_env | combine({'VAULT_TOKEN': openbao_bootstrap_token}) }}"
  when: openbao_bootstrap_token is defined
  no_log: true
  tags: [openbao, bootstrap]

- name: Enable database secrets engine
  ansible.builtin.command: "{{ openbao_cli }} secrets enable database"
  environment: "{{ openbao_env | combine({'VAULT_TOKEN': openbao_bootstrap_token}) }}"
  register: openbao_db_enable
  changed_when: openbao_db_enable.rc == 0
  failed_when: false
  when: openbao_bootstrap_token is defined
  tags: [openbao, bootstrap]

- name: Create OpenBao database user in MariaDB
  community.mysql.mysql_user:
    name: openbao
    password: "{{ openbao_mariadb_password | default(mariadb_root_password) }}"
    priv: "*.*:ALL,GRANT"
    host: "localhost"
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock
  when: openbao_bootstrap_token is defined
  no_log: true
  tags: [openbao, bootstrap, mysql]

- name: Configure MariaDB database connection for OpenBao
  ansible.builtin.command:
    argv:
      - "{{ openbao_cli }}"
      - write
      - database/config/wordpress
      - "plugin_name=mysql-database-plugin"
      - "allowed_roles=wordpress"
      - "connection_url={{ openbao_db_connection_url }}"
      - "username=openbao"
      - "password={{ openbao_mariadb_password | default(mariadb_root_password) }}"
  vars:
    openbao_db_connection_url: "{{ '{{' }}username{{ '}}' }}:{{ '{{' }}password{{ '}}' }}@tcp({{ mariadb_bind_address | default('127.0.0.1') }}:{{ mariadb_port | default(3306) }})/"
  environment: "{{ openbao_env | combine({'VAULT_TOKEN': openbao_bootstrap_token}) }}"
  when: openbao_bootstrap_token is defined
  no_log: true
  tags: [openbao, bootstrap]

- name: Configure OpenBao role for WordPress DB credentials
  ansible.builtin.command: >-
    {{ openbao_cli }} write database/roles/wordpress
    db_name=wordpress
    creation_statements="CREATE USER '{{'{{'}}name{{'}}'}}'@'%' IDENTIFIED BY '{{'{{'}}password{{'}}'}}'; GRANT ALL PRIVILEGES ON {{ wordpress_db_name | default('wordpress') }}.* TO '{{'{{'}}name{{'}}'}}'@'%';"
    default_ttl=2160h
    max_ttl=2160h
  environment: "{{ openbao_env | combine({'VAULT_TOKEN': openbao_bootstrap_token}) }}"
  when: openbao_bootstrap_token is defined
  tags: [openbao, bootstrap]

- name: Create OpenBao policy for WordPress credential rotation
  ansible.builtin.shell: |
    cat <<'EOF' | {{ openbao_cli }} policy write wordpress-rotator -
    path "database/creds/wordpress" {
      capabilities = ["read"]
    }
    path "auth/token/renew-self" {
      capabilities = ["update"]
    }
    EOF
  environment: "{{ openbao_env | combine({'VAULT_TOKEN': openbao_bootstrap_token}) }}"
  when: openbao_bootstrap_token is defined
  tags: [openbao, bootstrap]

- name: Create OpenBao token for WordPress rotation
  ansible.builtin.command: >-
    {{ openbao_cli }} token create -format=json -orphan -period=2160h -policy=wordpress-rotator
  environment: "{{ openbao_env | combine({'VAULT_TOKEN': openbao_bootstrap_token}) }}"
  register: openbao_wordpress_token_cmd
  when: openbao_bootstrap_token is defined
  no_log: true
  tags: [openbao, bootstrap]

- name: Capture WordPress rotation token on controller
  ansible.builtin.set_fact:
    openbao_wordpress_token: "{{ (openbao_wordpress_token_cmd.stdout | from_json).auth.client_token }}"
  delegate_to: localhost
  run_once: true
  when: openbao_wordpress_token_cmd is defined
  no_log: true
  tags: [openbao, bootstrap]

- name: Display OpenBao init keys and root token (copy once)
  ansible.builtin.debug:
    msg: "{{ openbao_init_message.split('\n') }}"
  vars:
    openbao_init_message: |
      ========================================
      üîê OPENBAO INITIALIZED - COPY THESE NOW
      ========================================
      Unseal Keys:
      {% for key in openbao_init.unseal_keys_b64 %}
      - {{ key }}
      {% endfor %}

      Root Token:
      - {{ openbao_init.root_token }}
      ========================================
  when: openbao_init is defined
  tags: [openbao, bootstrap]

- name: Remind to store rotation token in vault
  ansible.builtin.debug:
    msg: |
      Store the WordPress rotation token in your Ansible Vault:
        openbao_wordpress_rotation_token: <token>
      Then re-run playbooks that deploy WordPress rotation timers.
  when: openbao_wordpress_token is defined
  tags: [openbao, bootstrap]
