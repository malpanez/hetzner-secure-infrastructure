---
- name: Check OpenBao status
  ansible.builtin.command: "{{ openbao_cli }} status -format=json"
  environment: "{{ openbao_env }}"
  register: openbao_status_cmd
  changed_when: false
  failed_when: false
  tags: [openbao, bootstrap]

- name: Parse OpenBao status
  ansible.builtin.set_fact:
    openbao_status: "{{ (openbao_status_cmd.stdout | default('{}')) | from_json }}"
  # bao status returns rc=0 (unsealed), rc=1 (error), rc=2 (sealed but valid JSON)
  when: openbao_status_cmd.rc in [0, 2]
  tags: [openbao, bootstrap]

- name: Debug OpenBao status
  ansible.builtin.debug:
    msg:
      - "OpenBao status check: rc={{ openbao_status_cmd.rc }}"
      - "Initialized: {{ (openbao_status | default({})).initialized | default('unknown') }}"
      - "Sealed: {{ (openbao_status | default({})).sealed | default('unknown') }}"
      - "Recovery Seal Type: {{ (openbao_status | default({})).recovery_seal_type | default('none') }}"
  tags: [openbao, bootstrap]

# For Transit auto-unseal, use recovery shares instead of unseal keys
- name: Initialize OpenBao with Transit auto-unseal (first run only)
  ansible.builtin.command: >-
    {{ openbao_cli }} operator init
    -format=json
    -recovery-shares={{ openbao_key_shares }}
    -recovery-threshold={{ openbao_key_threshold }}
  environment: "{{ openbao_env }}"
  register: openbao_init_cmd
  changed_when: true
  when:
    - not ((openbao_status | default({})).initialized | default(false) | bool)
    - openbao_transit_enabled | default(false) | bool
  no_log: true
  tags: [openbao, bootstrap]

# For standard OpenBao (no Transit), use regular unseal keys
- name: Initialize OpenBao standard (first run only)
  ansible.builtin.command: >-
    {{ openbao_cli }} operator init
    -format=json
    -key-shares={{ openbao_key_shares }}
    -key-threshold={{ openbao_key_threshold }}
  environment: "{{ openbao_env }}"
  register: openbao_init_cmd_standard
  changed_when: true
  when:
    - not ((openbao_status | default({})).initialized | default(false) | bool)
    - not (openbao_transit_enabled | default(false) | bool)
  no_log: true
  tags: [openbao, bootstrap]

# Merge init results from either method
- name: Set init result from Transit or standard init
  ansible.builtin.set_fact:
    openbao_init_result: "{{ openbao_init_cmd if (openbao_init_cmd is defined and openbao_init_cmd is not skipped) else openbao_init_cmd_standard }}"
  when: (openbao_init_cmd is defined and openbao_init_cmd is not skipped) or (openbao_init_cmd_standard is defined and openbao_init_cmd_standard is not skipped)
  tags: [openbao, bootstrap]

- name: Capture OpenBao init output (Transit auto-unseal)
  ansible.builtin.set_fact:
    openbao_init: "{{ (openbao_init_cmd.stdout | default('{}')) | from_json }}"
    openbao_bootstrap_token: "{{ (openbao_init_cmd.stdout | from_json).root_token }}"
  when:
    - openbao_init_cmd is defined
    - openbao_init_cmd is not skipped
    - openbao_init_cmd.stdout is defined
    - openbao_transit_enabled | default(false) | bool
  no_log: true
  tags: [openbao, bootstrap]

- name: Capture OpenBao init output (standard)
  ansible.builtin.set_fact:
    openbao_init: "{{ (openbao_init_cmd_standard.stdout | default('{}')) | from_json }}"
    openbao_bootstrap_token: "{{ (openbao_init_cmd_standard.stdout | from_json).root_token }}"
  when:
    - openbao_init_cmd_standard is defined
    - openbao_init_cmd_standard is not skipped
    - openbao_init_cmd_standard.stdout is defined
    - not (openbao_transit_enabled | default(false) | bool)
  no_log: true
  tags: [openbao, bootstrap]

# Transit auto-unseal: wait for OpenBao to auto-unseal itself
- name: Wait for OpenBao to auto-unseal (Transit mode)
  ansible.builtin.command: "{{ openbao_cli }} status -format=json"
  environment: "{{ openbao_env }}"
  register: openbao_unseal_wait
  until: (openbao_unseal_wait.stdout | from_json).sealed == false
  retries: 12
  delay: 5
  changed_when: false
  when:
    - openbao_init is defined
    - openbao_transit_enabled | default(false) | bool
  tags: [openbao, bootstrap]

# Standard mode: manual unseal with keys
- name: Unseal OpenBao (using first threshold keys - standard mode only)
  ansible.builtin.command: "{{ openbao_cli }} operator unseal {{ item }}"
  environment: "{{ openbao_env }}"
  loop: "{{ openbao_init.unseal_keys_b64[0:openbao_key_threshold] }}"
  when:
    - openbao_init is defined
    - not (openbao_transit_enabled | default(false) | bool)
  no_log: true
  tags: [openbao, bootstrap]

- name: Enable KV secrets engine (kv-v2)
  ansible.builtin.command: "{{ openbao_cli }} secrets enable -path=secret kv-v2"
  environment: "{{ openbao_env | combine({'VAULT_TOKEN': openbao_bootstrap_token}) }}"
  register: openbao_kv_enable
  changed_when: openbao_kv_enable.rc == 0
  failed_when: false
  when: openbao_bootstrap_token is defined
  tags: [openbao, bootstrap]

- name: Seed WordPress database credentials in OpenBao
  ansible.builtin.command: >-
    {{ openbao_cli }} kv put secret/wordpress
    db_name={{ wordpress_db_name | default('wordpress') }}
    db_user={{ wordpress_db_user | default('wordpress') }}
    db_password={{ wordpress_db_password }}
  environment: "{{ openbao_env | combine({'VAULT_TOKEN': openbao_bootstrap_token}) }}"
  when: openbao_bootstrap_token is defined
  no_log: true
  tags: [openbao, bootstrap]

- name: Seed MariaDB root password in OpenBao
  ansible.builtin.command: >-
    {{ openbao_cli }} kv put secret/mariadb
    root_password={{ mariadb_root_password | default(vault_mariadb_root_password) }}
  environment: "{{ openbao_env | combine({'VAULT_TOKEN': openbao_bootstrap_token}) }}"
  when: openbao_bootstrap_token is defined
  no_log: true
  tags: [openbao, bootstrap]

- name: Enable database secrets engine
  ansible.builtin.command: "{{ openbao_cli }} secrets enable database"
  environment: "{{ openbao_env | combine({'VAULT_TOKEN': openbao_bootstrap_token}) }}"
  register: openbao_db_enable
  changed_when: openbao_db_enable.rc == 0
  failed_when: false
  when: openbao_bootstrap_token is defined
  tags: [openbao, bootstrap]

- name: Create OpenBao database user in MariaDB
  community.mysql.mysql_user:
    name: openbao
    password: "{{ openbao_mariadb_password | default(mariadb_root_password) }}"
    priv: "*.*:ALL,GRANT"
    host: "localhost"
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock
  when: openbao_bootstrap_token is defined
  no_log: true
  tags: [openbao, bootstrap, mysql]

- name: Configure MariaDB database connection for OpenBao
  ansible.builtin.command:
    argv:
      - "{{ openbao_cli }}"
      - write
      - database/config/wordpress
      - "plugin_name=mysql-database-plugin"
      - "allowed_roles=wordpress"
      - "connection_url={{ openbao_db_connection_url }}"
      - "username=openbao"
      - "password={{ openbao_mariadb_password | default(mariadb_root_password) }}"
  vars:
    openbao_db_connection_url: "{{ '{{' }}username{{ '}}' }}:{{ '{{' }}password{{ '}}' }}@tcp({{ mariadb_bind_address | default('127.0.0.1') }}:{{ mariadb_port | default(3306) }})/"
  environment: "{{ openbao_env | combine({'VAULT_TOKEN': openbao_bootstrap_token}) }}"
  when: openbao_bootstrap_token is defined
  no_log: true
  tags: [openbao, bootstrap]

- name: Configure OpenBao role for WordPress DB credentials
  ansible.builtin.command: >-
    {{ openbao_cli }} write database/roles/wordpress
    db_name=wordpress
    creation_statements="CREATE USER '{{'{{'}}name{{'}}'}}'@'%' IDENTIFIED BY '{{'{{'}}password{{'}}'}}'; GRANT ALL PRIVILEGES ON {{ wordpress_db_name | default('wordpress') }}.* TO '{{'{{'}}name{{'}}'}}'@'%';"
    default_ttl=2160h
    max_ttl=2160h
  environment: "{{ openbao_env | combine({'VAULT_TOKEN': openbao_bootstrap_token}) }}"
  when: openbao_bootstrap_token is defined
  tags: [openbao, bootstrap]

- name: Create OpenBao policy for WordPress credential rotation
  ansible.builtin.shell: |
    cat <<'EOF' | {{ openbao_cli }} policy write wordpress-rotator -
    path "database/creds/wordpress" {
      capabilities = ["read"]
    }
    path "auth/token/renew-self" {
      capabilities = ["update"]
    }
    EOF
  environment: "{{ openbao_env | combine({'VAULT_TOKEN': openbao_bootstrap_token}) }}"
  when: openbao_bootstrap_token is defined
  tags: [openbao, bootstrap]

- name: Create OpenBao token for WordPress rotation
  ansible.builtin.command: >-
    {{ openbao_cli }} token create -format=json -orphan -period=2160h -policy=wordpress-rotator
  environment: "{{ openbao_env | combine({'VAULT_TOKEN': openbao_bootstrap_token}) }}"
  register: openbao_wordpress_token_cmd
  when: openbao_bootstrap_token is defined
  no_log: true
  tags: [openbao, bootstrap]

- name: Capture WordPress rotation token on controller
  ansible.builtin.set_fact:
    openbao_wordpress_token: "{{ (openbao_wordpress_token_cmd.stdout | from_json).auth.client_token }}"
  delegate_to: localhost
  run_once: true
  when: openbao_wordpress_token_cmd is defined
  no_log: true
  tags: [openbao, bootstrap]

- name: Display OpenBao init keys and root token (Transit mode)
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "  OPENBAO INITIALIZED (Transit Auto-Unseal)"
      - "=========================================="
      - ""
      - "Recovery Keys (save securely):"
      - "  1. {{ openbao_init.recovery_keys_b64[0] }}"
      - "  2. {{ openbao_init.recovery_keys_b64[1] }}"
      - "  3. {{ openbao_init.recovery_keys_b64[2] }}"
      - "  4. {{ openbao_init.recovery_keys_b64[3] }}"
      - "  5. {{ openbao_init.recovery_keys_b64[4] }}"
      - ""
      - "Root Token:"
      - "  {{ openbao_init.root_token }}"
      - ""
      - "NOTE: Recovery keys are for emergency access only."
      - "OpenBao will auto-unseal via Transit instance."
      - "=========================================="
  when:
    - openbao_init is defined
    - openbao_transit_enabled | default(false) | bool
  tags: [openbao, bootstrap]

- name: Display OpenBao init keys and root token (standard mode)
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "  OPENBAO INITIALIZED - COPY THESE NOW   "
      - "=========================================="
      - ""
      - "Unseal Keys (need {{ openbao_key_threshold }} to unseal):"
      - "  1. {{ openbao_init.unseal_keys_b64[0] }}"
      - "  2. {{ openbao_init.unseal_keys_b64[1] }}"
      - "  3. {{ openbao_init.unseal_keys_b64[2] }}"
      - "  4. {{ openbao_init.unseal_keys_b64[3] }}"
      - "  5. {{ openbao_init.unseal_keys_b64[4] }}"
      - ""
      - "Root Token:"
      - "  {{ openbao_init.root_token }}"
      - "=========================================="
  when:
    - openbao_init is defined
    - not (openbao_transit_enabled | default(false) | bool)
  tags: [openbao, bootstrap]

- name: Remind to store rotation token in vault
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "  SAVE THIS TOKEN IN ANSIBLE VAULT       "
      - "=========================================="
      - ""
      - "Add to inventory/group_vars/all/secrets.yml:"
      - "  openbao_wordpress_rotation_token: {{ openbao_wordpress_token }}"
      - ""
      - "Then re-run site.yml to deploy rotation timers."
      - "=========================================="
  when: openbao_wordpress_token is defined
  tags: [openbao, bootstrap]
