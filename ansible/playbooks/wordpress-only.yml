---
# Simplified WordPress-only Playbook for Testing
# Skips monitoring and OpenBao to avoid missing dependencies

# ========================================
# Common Configuration (All Servers)
# ========================================
- name: Apply common security hardening to all servers
  hosts: hetzner
  become: true
  gather_facts: true

  pre_tasks:
    - name: Display deployment information
      ansible.builtin.debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘         WORDPRESS DEPLOYMENT - STARTING                   â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ðŸ“ Target Host"
          - "â”œâ”€ Hostname:     {{ inventory_hostname }}"
          - "â”œâ”€ IP Address:   {{ ansible_default_ipv4.address | default('N/A') }}"
          - "â””â”€ Groups:       {{ group_names | join(', ') }}"
          - ""
          - "ðŸ’» System Information"
          - "â”œâ”€ OS:           {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "â”œâ”€ Kernel:       {{ ansible_kernel }}"
          - "â”œâ”€ Architecture: {{ ansible_architecture }}"
          - "â””â”€ CPUs:         {{ ansible_processor_vcpus }}"
          - ""
          - "ðŸ”§ Configuration"
          - "â”œâ”€ User:         {{ ansible_user }}"
          - "â”œâ”€ Python:       {{ ansible_python_version }}"
          - "â””â”€ SSH Port:     {{ ansible_port | default(22) }}"
          - ""
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      tags: [always]

    - name: Update apt cache (Debian/Ubuntu)
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      when: ansible_os_family == 'Debian'
      tags: [always]

    - name: Check OS compatibility
      ansible.builtin.assert:
        that:
          - ansible_distribution in ['Debian', 'Ubuntu']
          - ansible_distribution_major_version | int >= 11
        fail_msg: This playbook requires Debian 11+ or Ubuntu 20.04+
        success_msg: OS compatibility check passed
      tags: [always]

  roles:
    - role: common
      tags: [common, base]

    - role: security_hardening
      tags: [security, hardening]

    - role: firewall
      tags: [security, firewall]
      when: firewall_enabled | default(true) | bool

    - role: fail2ban
      tags: [security, fail2ban]
      when: fail2ban_enabled | default(true) | bool

    - role: apparmor
      tags: [security, apparmor]
      when:
        - apparmor_enabled | default(true) | bool
        - ansible_distribution in ['Debian', 'Ubuntu']

    - role: ssh_2fa
      tags: [security, ssh, 2fa]
      when: ssh_2fa_enabled | default(true) | bool

  post_tasks:
    - name: Flush handlers
      ansible.builtin.meta: flush_handlers
      tags: [always]

# ========================================
# WordPress Application Servers
# ========================================
- name: Deploy WordPress application stack
  hosts: wordpress_servers
  become: true
  gather_facts: true

  roles:
    # Use Galaxy role for MariaDB
    - role: geerlingguy.mysql
      tags: [wordpress, database, mariadb]
      vars:
        mysql_databases:
          - name: "{{ wordpress_db_name | default('wordpress') }}"
            encoding: utf8mb4
            collation: utf8mb4_unicode_ci
        mysql_users:
          - name: "{{ wordpress_db_user | default('wordpress') }}"
            host: localhost
            password: "{{ wordpress_db_password }}"
            priv: "{{ wordpress_db_name | default('wordpress') }}.*:ALL"
      when: deploy_mariadb | default(true) | bool

    # Custom roles
    - role: valkey
      tags: [wordpress, redis, cache, performance]
      when: deploy_valkey | default(true) | bool

    - role: nginx_wordpress
      tags: [wordpress, nginx, webserver]
      vars:
        nginx_wordpress_db_password: "{{ wordpress_db_password }}"
        nginx_wordpress_server_name: "_"  # Accept any hostname/IP
        nginx_wordpress_server_aliases: []  # No aliases needed
        nginx_wordpress_admin_password: "{{ wordpress_db_password }}"  # Temporary - should use separate vault variable
        nginx_wordpress_admin_email: "admin@example.com"  # Default - should be changed in production

  post_tasks:
    - name: Display WordPress deployment information
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "âœ… WordPress Stack Deployed"
          - "========================================="
          - ""
          - "Server Information:"
          - "  â€¢ Hostname: {{ inventory_hostname }}"
          - "  â€¢ IP Address: {{ ansible_host }}"
          - "  â€¢ Domain: {{ nginx_wordpress_server_name }}"
          - "  â€¢ Install Path: {{ nginx_wordpress_web_root | default('/var/www/wordpress') }}"
          - ""
          - "Database Information:"
          - "  â€¢ Database: {{ wordpress_db_name | default('wordpress') }}"
          - "  â€¢ User: {{ wordpress_db_user | default('wordpress') }}"
          - ""
          - "Installed Plugins (9):"
          - "  1. Wordfence (Security)"
          - "  2. Sucuri Scanner (Security)"
          - "  3. WP 2FA (Two-factor auth)"
          - "  4. UpdraftPlus (Backups)"
          - "  5. Redis Cache (Performance - backend only)"
          - "  6. Yoast SEO (SEO)"
          - "  7. Enable Media Replace (Media)"
          - "  8. WP Mail SMTP (Email)"
          - "  9. Health Check (Monitoring)"
          - ""
          - "Next Steps:"
          - "  1. Access WordPress: http://{{ ansible_host }}"
          - "  2. WordPress is ready - login with admin credentials"
          - "  3. Configure plugin settings (see security recommendations above)"
          - "  4. Install LearnDash Pro manually (requires license)"
          - ""
          - "========================================="
      tags: [wordpress, info]

# ========================================
# Final Validation
# ========================================
- name: Validate deployment
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: Verify all servers are accessible
      ansible.builtin.ping:
      tags: [validate]

    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "ðŸŽ‰ WORDPRESS DEPLOYMENT COMPLETE"
          - "========================================="
          - ""
          - "Access your WordPress site:"
          - "  - URL: http://{{ hostvars[groups['wordpress_servers'][0]]['ansible_host'] }}"
          - "  - Admin: http://{{ hostvars[groups['wordpress_servers'][0]]['ansible_host'] }}/wp-admin"
          - ""
          - "Server Details:"
          - "  - Host: {{ hostvars[groups['wordpress_servers'][0]]['inventory_hostname'] }}"
          - "  - IP: {{ hostvars[groups['wordpress_servers'][0]]['ansible_host'] }}"
          - "  - SSH: ssh {{ hostvars[groups['wordpress_servers'][0]]['ansible_user'] }}@{{ hostvars[groups['wordpress_servers'][0]]['ansible_host'] }}"
          - ""
          - "WordPress Info:"
          - "  - Admin User: admin"
          - "  - Install Path: /var/www/wordpress"
          - "  - Database: wordpress"
          - ""
          - "Security Features Enabled:"
          - "  âœ… UFW Firewall (ports 22, 80, 443)"
          - "  âœ… Fail2ban IDS"
          - "  âœ… AppArmor (PHP-FPM, SSH, Fail2ban)"
          - "  âœ… Kernel Hardening (sysctl)"
          - "  âœ… Auto Security Updates"
          - "  âœ… SSH 2FA with Yubikey Support"
          - ""
          - "Performance Features:"
          - "  âœ… Valkey Object Cache (Redis-compatible)"
          - "  âœ… PHP 8.4-FPM"
          - "  âœ… Nginx Web Server"
          - ""
          - "Installed Plugins (9):"
          - "  â€¢ Wordfence (Security)"
          - "  â€¢ Sucuri Scanner (Security)"
          - "  â€¢ WP 2FA (Two-factor auth)"
          - "  â€¢ UpdraftPlus (Backups)"
          - "  â€¢ Redis Cache (Performance)"
          - "  â€¢ Yoast SEO (SEO)"
          - "  â€¢ Enable Media Replace (Media)"
          - "  â€¢ WP Mail SMTP (Email)"
          - "  â€¢ Health Check (Monitoring)"
          - ""
          - "Next Steps:"
          - "  1. Complete WordPress setup: http://{{ hostvars[groups['wordpress_servers'][0]]['ansible_host'] }}"
          - "  2. Configure SSL/TLS certificates (Let's Encrypt recommended)"
          - "  3. Configure plugin settings via WordPress admin"
          - "  4. Set up UpdraftPlus backup schedule"
          - "  5. Install LearnDash Pro manually (requires license)"
          - ""
          - "========================================="
      run_once: true
      tags: [validate, summary, always]
