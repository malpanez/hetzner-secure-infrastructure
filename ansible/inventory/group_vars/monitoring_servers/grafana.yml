---
# Grafana Configuration (v6+ compatible)
# Visualization and dashboarding platform
# Uses grafana_ini structure for grafana.grafana collection v6+

# ========================================
# Grafana Version and Repository
# ========================================
grafana_version: latest
grafana_manage_repo: true  # Use official Debian/Ubuntu repository

# ========================================
# Grafana Configuration (grafana.ini structure)
# ========================================
grafana_ini:
  # Paths
  paths:
    logs: "/var/log/grafana"
    data: "/var/lib/grafana"
    plugins: "/var/lib/grafana/plugins"

  # Server settings
  server:
    http_addr: "127.0.0.1"  # Behind Nginx reverse proxy
    http_port: 3000
    protocol: http
    domain: "grafana.{{ domain_name }}"
    root_url: "https://grafana.{{ domain_name }}"

  # Security
  security:
    admin_user: admin
    admin_password: "{{ vault_grafana_admin_password }}"
    disable_gravatar: true
    cookie_secure: true
    cookie_samesite: lax
    allow_embedding: false

  # Database (SQLite by default)
  database:
    type: sqlite3
    path: "/var/lib/grafana/grafana.db"

  # User management
  users:
    allow_sign_up: false
    auto_assign_org_role: Viewer
    default_theme: dark

  # Anonymous access
  auth.anonymous:
    enabled: false

  # Logging
  log:
    mode: "console file"
    level: info


# ========================================
# Grafana Data Sources (using provisioning)
# ========================================
grafana_use_provisioning: true
grafana_provisioning_synced: false

# Custom dashboards directory (for local JSON files, optional)
# Default "dashboards" is relative to playbook directory
# Created at: ansible/playbooks/dashboards/
# Leave commented to use default path
# grafana_dashboards_dir: "dashboards"

grafana_datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: "http://localhost:{{ prometheus_port | default(9090) }}"
    is_default: true
    editable: false
    version: 1

  - name: Loki
    type: loki
    access: proxy
    url: "http://localhost:{{ loki_http_listen_port | default(3100) }}"
    editable: false
    version: 1

# ========================================
# Grafana Dashboards (using provisioning)
# ========================================
grafana_dashboards_enabled: true
grafana_dashboards:
  # ==================
  # Metrics Dashboards
  # ==================

  # Node Exporter Full (System metrics)
  - dashboard_id: "1860"
    revision_id: "37"
    datasource: "Prometheus"

  # Prometheus Stats
  - dashboard_id: "3662"
    revision_id: "2"
    datasource: "Prometheus"

  # ==================
  # Logs Dashboards
  # ==================

  # Loki Dashboard Quick Search
  - dashboard_id: "12019"
    revision_id: "2"
    datasource: "Loki"

  # Loki Logs Dashboard with filters
  - dashboard_id: "13639"
    revision_id: "2"
    datasource: "Loki"

  # Loki & Promtail - Advanced
  - dashboard_id: "14055"
    revision_id: "5"
    datasource: "Loki"

  # ==================
  # Application Dashboards (WordPress Stack)
  # ==================

  # Nginx - Request metrics, connections, error rates
  - dashboard_id: "12708"
    revision_id: "1"
    datasource: "Prometheus"

  # MySQL/MariaDB Overview - Queries, connections, InnoDB
  - dashboard_id: "7362"
    revision_id: "5"
    datasource: "Prometheus"

  # PHP-FPM - Pool status, processes, slow requests
  - dashboard_id: "4912"
    revision_id: "1"
    datasource: "Prometheus"

  # Redis/Valkey - Cache hits, memory, keys, commands
  - dashboard_id: "11835"
    revision_id: "1"
    datasource: "Prometheus"

# ========================================
# Grafana Plugins
# ========================================
grafana_plugins:
  - grafana-piechart-panel
  - grafana-clock-panel

# ========================================
# Grafana Alerting
# ========================================
# grafana_alerting_enabled: false  # Not used in v6+ (always enabled)

# ========================================
# Grafana SMTP (for email alerts)
# ========================================
# grafana_smtp_enabled: false
# Configured via grafana_ini.smtp section if needed:
# grafana_ini:
#   smtp:
#     enabled: true
#     host: "smtp.gmail.com:587"
#     user: "alerts@example.com"
#     password: "{{ vault_grafana_smtp_password }}"
#     from_address: "alerts@example.com"
