---
# Grafana Configuration (v6+ compatible)
# Visualization and dashboarding platform
# Uses grafana_ini structure for grafana.grafana collection v6+

# ========================================
# Grafana Version and Repository
# ========================================
grafana_version: latest
grafana_manage_repo: true  # Use official Debian/Ubuntu repository

# ========================================
# Grafana Configuration (grafana.ini structure)
# ========================================
grafana_ini:
  # Paths
  paths:
    logs: "/var/log/grafana"
    data: "/var/lib/grafana"
    plugins: "/var/lib/grafana/plugins"

  # Server settings
  server:
    http_addr: "0.0.0.0"  # Override in staging/production as needed
    http_port: 3000
    protocol: http
    domain: "{{ ansible_host }}"
    root_url: "http://{{ ansible_host }}:3000"

  # Security
  security:
    admin_user: admin
    admin_password: "{{ vault_grafana_admin_password }}"
    disable_gravatar: true
    cookie_secure: false  # Set to true if using HTTPS
    cookie_samesite: lax
    allow_embedding: false

  # Database (SQLite by default)
  database:
    type: sqlite3
    path: "/var/lib/grafana/grafana.db"

  # User management
  users:
    allow_sign_up: false
    auto_assign_org_role: Viewer
    default_theme: dark

  # Anonymous access
  auth.anonymous:
    enabled: false

  # Logging
  log:
    mode: "console file"
    level: info

# ========================================
# Grafana Data Sources (using provisioning)
# ========================================
grafana_use_provisioning: true
grafana_provisioning_synced: false

grafana_datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: "http://localhost:{{ prometheus_port | default(9090) }}"
    is_default: true
    editable: false
    version: 1

  - name: Loki
    type: loki
    access: proxy
    url: "http://localhost:{{ loki_http_listen_port | default(3100) }}"
    editable: false
    version: 1

# ========================================
# Grafana Dashboards (using provisioning)
# ========================================
grafana_dashboards_enabled: true
grafana_dashboards:
  # Node Exporter Full (System metrics)
  - dashboard_id: "1860"
    revision_id: "37"
    datasource: "Prometheus"

  # Prometheus Stats
  - dashboard_id: "3662"
    revision_id: "2"
    datasource: "Prometheus"

# ========================================
# Grafana Plugins
# ========================================
grafana_plugins:
  - grafana-piechart-panel
  - grafana-clock-panel

# ========================================
# Grafana Alerting
# ========================================
# grafana_alerting_enabled: false  # Not used in v6+ (always enabled)

# ========================================
# Grafana SMTP (for email alerts)
# ========================================
# grafana_smtp_enabled: false
# Configured via grafana_ini.smtp section if needed:
# grafana_ini:
#   smtp:
#     enabled: true
#     host: "smtp.gmail.com:587"
#     user: "alerts@example.com"
#     password: "{{ vault_grafana_smtp_password }}"
#     from_address: "alerts@example.com"
