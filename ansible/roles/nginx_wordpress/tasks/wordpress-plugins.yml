---
# Nginx WordPress Role - WordPress Plugins Installation

- name: Nginx WordPress | Plugins | Check if WordPress is installed
  ansible.builtin.stat:
    path: "{{ nginx_wordpress_web_root }}/wp-config.php"
  register: wp_config_check
  tags: [nginx-wordpress, wordpress, plugins]

- name: Nginx WordPress | Plugins | Install mandatory WordPress plugins
  ansible.builtin.command:
    cmd: "{{ nginx_wordpress_wpcli_path }} plugin install {{ nginx_wordpress_plugins_mandatory | join(' ') }} --activate --path={{ nginx_wordpress_web_root }}"
  become_user: "{{ nginx_wordpress_nginx_user }}"
  register: plugin_install
  changed_when: "'Success: Plugin already installed' not in plugin_install.stdout"
  failed_when: false
  when: wp_config_check.stat.exists
  tags: [nginx-wordpress, wordpress, plugins, molecule-notest]

- name: Nginx WordPress | Plugins | Install LMS critical plugins
  ansible.builtin.command:
    cmd: "{{ nginx_wordpress_wpcli_path }} plugin install {{ nginx_wordpress_plugins_lms_critical | join(' ') }} --activate --path={{ nginx_wordpress_web_root }}"
  become_user: "{{ nginx_wordpress_nginx_user }}"
  register: lms_plugin_install
  changed_when: "'Success: Plugin already installed' not in lms_plugin_install.stdout"
  failed_when: false
  when: wp_config_check.stat.exists
  tags: [nginx-wordpress, wordpress, plugins, lms, molecule-notest]

- name: Nginx WordPress | Plugins | Install recommended plugins
  ansible.builtin.command:
    cmd: "{{ nginx_wordpress_wpcli_path }} plugin install {{ nginx_wordpress_plugins_recommended | join(' ') }} --activate --path={{ nginx_wordpress_web_root }}"
  become_user: "{{ nginx_wordpress_nginx_user }}"
  register: recommended_plugin_install
  changed_when: "'Success: Plugin already installed' not in recommended_plugin_install.stdout"
  failed_when: false
  when: wp_config_check.stat.exists
  tags: [nginx-wordpress, wordpress, plugins, recommended, molecule-notest]

- name: Nginx WordPress | Plugins | Check plugin installation status
  ansible.builtin.command:
    cmd: "{{ nginx_wordpress_wpcli_path }} plugin list --path={{ nginx_wordpress_web_root }} --format=json"
  become_user: "{{ nginx_wordpress_nginx_user }}"
  register: installed_plugins
  changed_when: false
  when: wp_config_check.stat.exists
  tags: [nginx-wordpress, wordpress, plugins, molecule-notest]

- name: Nginx WordPress | Plugins | Display installed plugins
  ansible.builtin.debug:
    msg: "{{ ['========================================',
             'Installed WordPress Plugins (9 total)',
             '========================================',
             '',
             'CRITICAL Infrastructure Integration (4):',
             '  ✓ redis-cache - Valkey object cache',
             '  ✓ nginx-helper - FastCGI cache purging',
             '  ✓ wordfence-login-security - 2FA/MFA',
             '  ✓ limit-login-attempts-reloaded - Login protection',
             '',
             'CRITICAL LMS Operations (3):',
             '  ✓ updraftplus - Backups (configure with Google Drive/Dropbox)',
             '  ✓ wp-mail-smtp - Email delivery (configure with Brevo Free)',
             '  ✓ seo-by-rank-math - SEO optimization',
             '',
             'IMPORTANT Content & Compliance (2):',
             '  ✓ kadence-blocks - Advanced Gutenberg blocks',
             '  ✓ cookie-notice - GDPR compliance',
             '',
             '========================================',
             'Infrastructure-Provided Features:',
             '========================================',
             '  ✓ Cloudflare WAF - Security & bot protection',
             '  ✓ Nginx FastCGI - Full page caching',
             '  ✓ Valkey - Object & database caching',
             '  ✓ AppArmor - Mandatory access control',
             '  ✓ Fail2ban - Brute force protection',
             '',
             '========================================',
             'All plugins are 100% FREE from WordPress.org',
             '',
             'NOTE: LearnDash Pro must be installed manually with license',
             '========================================'] }}"
  when:
    - wp_config_check.stat.exists
    - installed_plugins.stdout is defined
  tags: [nginx-wordpress, wordpress, plugins, info]

- name: Nginx WordPress | Plugins | Configure Redis Object Cache
  block:
    - name: Nginx WordPress | Plugins | Check if Redis/Valkey is running
      ansible.builtin.systemd:
        name: valkey
      register: valkey_status
      failed_when: false
      changed_when: false

    - name: Nginx WordPress | Plugins | Enable Redis Object Cache
      ansible.builtin.command:
        cmd: "{{ nginx_wordpress_wpcli_path }} redis enable --path={{ nginx_wordpress_web_root }}"
      become_user: "{{ nginx_wordpress_nginx_user }}"
      when: valkey_status.status.ActiveState == 'active'
      register: redis_enable
      changed_when: "'already enabled' not in redis_enable.stdout"
      failed_when: false

    - name: Nginx WordPress | Plugins | Display Redis cache status
      ansible.builtin.debug:
        msg: "Redis Object Cache: {{ 'ENABLED ✓' if valkey_status.status.ActiveState == 'active' else 'DISABLED (Valkey not running)' }}"
  when: wp_config_check.stat.exists
  tags: [nginx-wordpress, wordpress, plugins, redis]

- name: Nginx WordPress | Plugins | Configure Nginx Helper
  block:
    - name: Nginx WordPress | Plugins | Enable Nginx Helper purge on update
      ansible.builtin.command:
        cmd: "{{ nginx_wordpress_wpcli_path }} option update rt_wp_nginx_helper_options '{{ nginx_helper_options | to_json }}' --format=json --path={{ nginx_wordpress_web_root }}"
      become_user: "{{ nginx_wordpress_nginx_user }}"
      vars:
        nginx_helper_options:
          enable_purge: "1"
          cache_method: "enable_fastcgi"
          purge_method: "delete_local_server"
          enable_map: "0"
          enable_log: "0"
          enable_stamp: "0"
      register: nginx_helper_config
      changed_when: nginx_helper_config.rc == 0
      failed_when: false

    - name: Nginx WordPress | Plugins | Display Nginx Helper status
      ansible.builtin.debug:
        msg: "Nginx Helper: FastCGI cache purging ENABLED ✓"
  when: wp_config_check.stat.exists
  tags: [nginx-wordpress, wordpress, plugins, cache]

- name: Nginx WordPress | Plugins | Post-installation instructions
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "WordPress Post-Installation Tasks"
      - "========================================="
      - ""
      - "CRITICAL - Configure Immediately:"
      - ""
      - "1. UpdraftPlus (Backups):"
      - "   • WordPress Admin → Settings → UpdraftPlus Backups"
      - "   • Connect to Google Drive or Dropbox (free)"
      - "   • Schedule: Daily database, weekly files"
      - "   • Test restore to verify backups work"
      - ""
      - "2. WP Mail SMTP (Email Delivery):"
      - "   • WordPress Admin → WP Mail SMTP → Settings"
      - "   • Mailer: Brevo (recommended - 300 emails/day free)"
      - "   • Get API key: https://app.brevo.com/settings/keys/api"
      - "   • Send test email to verify"
      - ""
      - "3. Rank Math SEO:"
      - "   • WordPress Admin → Rank Math → Setup Wizard"
      - "   • Connect Google Search Console (optional)"
      - "   • Configure sitemap and schema"
      - ""
      - "4. Cookie Notice (GDPR):"
      - "   • WordPress Admin → Settings → Cookie Notice"
      - "   • Enable banner for EU visitors"
      - "   • Customize text and colors"
      - ""
      - "REQUIRED - Install Manually:"
      - ""
      - "5. LearnDash Pro (LMS):"
      - "   • Plugins → Add New → Upload Plugin"
      - "   • Upload LearnDash zip from your account"
      - "   • Activate with license key"
      - "   • Configure course settings & payment gateways"
      - ""
      - "ALREADY CONFIGURED:"
      - ""
      - "6. Redis Object Cache:"
      - "   • {{ 'ENABLED ✓ - Monitor via WordPress admin' if valkey_status.status.ActiveState == 'active' else 'Install Valkey role first' }}"
      - ""
      - "7. Nginx Helper:"
      - "   • CONFIGURED ✓ - Cache auto-purges on updates"
      - ""
      - "8. Wordfence Login Security:"
      - "   • Enable 2FA for all admin users"
      - "   • Use Google Authenticator or Authy app"
      - ""
      - "========================================="
      - "Infrastructure-Level Security (Active):"
      - "========================================="
      - "  ✓ Cloudflare WAF - DDoS & bot protection"
      - "  ✓ Nginx FastCGI - Full page caching"
      - "  ✓ Valkey - Object caching"
      - "  ✓ UFW Firewall - Port restrictions"
      - "  ✓ Fail2ban - Brute force protection"
      - "  ✓ AppArmor - Process isolation"
      - ""
      - "========================================="
  when: wp_config_check.stat.exists
  run_once: true
  tags: [nginx-wordpress, wordpress, plugins, info]
