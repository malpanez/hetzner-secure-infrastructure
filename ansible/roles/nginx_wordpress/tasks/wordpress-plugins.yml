---
# Nginx WordPress Role - WordPress Plugins Installation

- name: Nginx WordPress | Plugins | Check if WordPress is installed
  ansible.builtin.stat:
    path: "{{ nginx_wordpress_web_root }}/wp-config.php"
  register: wp_config_check
  tags: [nginx-wordpress, wordpress, plugins]

# ========================================
# Remove Bloat Plugins
# ========================================

- name: Nginx WordPress | Plugins | Remove bloat plugins
  ansible.builtin.command:
    cmd: >-
      {{ nginx_wordpress_wpcli_path }} plugin delete {{ item }}
      --path={{ nginx_wordpress_web_root }}
  become_user: "{{ nginx_wordpress_nginx_user }}"
  loop: "{{ nginx_wordpress_plugins_remove | default([]) }}"
  register: plugin_remove
  changed_when: "'Deleted' in plugin_remove.stdout"
  failed_when: false
  when:
    - wp_config_check.stat.exists
    - nginx_wordpress_plugins_remove is defined
    - nginx_wordpress_plugins_remove | length > 0
  tags: [nginx-wordpress, wordpress, plugins, cleanup, molecule-notest]

# ========================================
# Install Plugin Groups
# ========================================

- name: Nginx WordPress | Plugins | Install mandatory infrastructure plugins
  ansible.builtin.command:
    cmd: >-
      {{ nginx_wordpress_wpcli_path }} plugin install
      {{ nginx_wordpress_plugins_mandatory | join(' ') }} --activate
      --path={{ nginx_wordpress_web_root }}
  become_user: "{{ nginx_wordpress_nginx_user }}"
  register: plugin_install
  changed_when: "'Installing' in plugin_install.stdout"
  failed_when: false
  when:
    - wp_config_check.stat.exists
    - nginx_wordpress_plugins_mandatory | default([]) | length > 0
  tags: [nginx-wordpress, wordpress, plugins, molecule-notest]

- name: Nginx WordPress | Plugins | Install LMS critical plugins
  ansible.builtin.command:
    cmd: >-
      {{ nginx_wordpress_wpcli_path }} plugin install
      {{ nginx_wordpress_plugins_lms_critical | join(' ') }} --activate
      --path={{ nginx_wordpress_web_root }}
  become_user: "{{ nginx_wordpress_nginx_user }}"
  register: lms_plugin_install
  changed_when: "'Installing' in lms_plugin_install.stdout"
  failed_when: false
  when:
    - wp_config_check.stat.exists
    - nginx_wordpress_plugins_lms_critical | default([]) | length > 0
  tags: [nginx-wordpress, wordpress, plugins, lms, molecule-notest]

- name: Nginx WordPress | Plugins | Install page builder plugins
  ansible.builtin.command:
    cmd: >-
      {{ nginx_wordpress_wpcli_path }} plugin install
      {{ nginx_wordpress_plugins_page_builder | join(' ') }} --activate
      --path={{ nginx_wordpress_web_root }}
  become_user: "{{ nginx_wordpress_nginx_user }}"
  register: pagebuilder_plugin_install
  changed_when: "'Installing' in pagebuilder_plugin_install.stdout"
  failed_when: false
  when:
    - wp_config_check.stat.exists
    - nginx_wordpress_plugins_page_builder | default([]) | length > 0
  tags: [nginx-wordpress, wordpress, plugins, pagebuilder, molecule-notest]

- name: Nginx WordPress | Plugins | Install accessibility plugins
  ansible.builtin.command:
    cmd: >-
      {{ nginx_wordpress_wpcli_path }} plugin install
      {{ nginx_wordpress_plugins_accessibility | join(' ') }} --activate
      --path={{ nginx_wordpress_web_root }}
  become_user: "{{ nginx_wordpress_nginx_user }}"
  register: accessibility_plugin_install
  changed_when: "'Installing' in accessibility_plugin_install.stdout"
  failed_when: false
  when:
    - wp_config_check.stat.exists
    - nginx_wordpress_plugins_accessibility | default([]) | length > 0
  tags: [nginx-wordpress, wordpress, plugins, accessibility, molecule-notest]

- name: Nginx WordPress | Plugins | Install recommended plugins
  ansible.builtin.command:
    cmd: >-
      {{ nginx_wordpress_wpcli_path }} plugin install
      {{ nginx_wordpress_plugins_recommended | join(' ') }} --activate
      --path={{ nginx_wordpress_web_root }}
  become_user: "{{ nginx_wordpress_nginx_user }}"
  register: recommended_plugin_install
  changed_when: "'Installing' in recommended_plugin_install.stdout"
  failed_when: false
  when:
    - wp_config_check.stat.exists
    - nginx_wordpress_plugins_recommended | default([]) | length > 0
  tags: [nginx-wordpress, wordpress, plugins, recommended, molecule-notest]

# ========================================
# Display Installed Plugins
# ========================================

- name: Nginx WordPress | Plugins | Check plugin installation status
  ansible.builtin.command:
    cmd: >-
      {{ nginx_wordpress_wpcli_path }} plugin list
      --path={{ nginx_wordpress_web_root }} --format=json
  become_user: "{{ nginx_wordpress_nginx_user }}"
  register: installed_plugins
  changed_when: false
  when: wp_config_check.stat.exists
  tags: [nginx-wordpress, wordpress, plugins, molecule-notest]

- name: Nginx WordPress | Plugins | Display installed plugins summary
  ansible.builtin.debug:
    msg: "{{ ['========================================',
             'WordPress Plugins - Kadence + LearnDash Stack',
             '========================================',
             '',
             'INFRASTRUCTURE (4):',
             '  ✓ redis-cache - Valkey object cache',
             '  ✓ nginx-helper - FastCGI cache purging',
             '  ✓ wordfence-login-security - 2FA/MFA',
             '  ✓ limit-login-attempts-reloaded - Login protection',
             '',
             'LMS OPERATIONS (3):',
             '  ✓ updraftplus - Backups',
             '  ✓ wp-mail-smtp - Email delivery',
             '  ✓ seo-by-rank-math - SEO optimization',
             '',
             'KADENCE DESIGN (2):',
             '  ✓ kadence-blocks - Advanced Gutenberg blocks',
             '  ✓ kadence-starter-templates - Template importer',
             '',
             'ACCESSIBILITY (1):',
             '  ✓ accessibility-assistant - ADHD/Dyslexia modes',
             '',
             'COMPLIANCE (1):',
             '  ✓ cookie-notice - GDPR consent',
             '',
             'REMOVED BLOAT:',
             '  ✗ hello - Hello Dolly (useless)',
             '  ✗ akismet - Spam (not needed)',
             '',
             '========================================',
             'Total: 11 plugins (Gutenberg-native, no Elementor)',
             '========================================'] }}"
  when:
    - wp_config_check.stat.exists
    - installed_plugins.stdout is defined
  tags: [nginx-wordpress, wordpress, plugins, info]

# ========================================
# Configure Plugins
# ========================================

- name: Nginx WordPress | Plugins | Configure Redis Object Cache
  block:
    - name: Nginx WordPress | Plugins | Check if Redis/Valkey is running
      ansible.builtin.systemd:
        name: valkey
      register: valkey_status
      failed_when: false
      changed_when: false

    - name: Nginx WordPress | Plugins | Enable Redis Object Cache
      ansible.builtin.command:
        cmd: >-
          {{ nginx_wordpress_wpcli_path }} redis enable
          --path={{ nginx_wordpress_web_root }}
      become_user: "{{ nginx_wordpress_nginx_user }}"
      when: valkey_status.status.ActiveState == 'active'
      register: redis_enable
      changed_when: "'already enabled' not in redis_enable.stdout"
      failed_when: false

    - name: Nginx WordPress | Plugins | Display Redis cache status
      ansible.builtin.debug:
        msg: >-
          Redis Object Cache:
          {{ 'ENABLED ✓' if valkey_status.status.ActiveState == 'active'
             else 'DISABLED (Valkey not running)' }}
  when: wp_config_check.stat.exists
  tags: [nginx-wordpress, wordpress, plugins, redis]

- name: Nginx WordPress | Plugins | Configure Nginx Helper
  block:
    - name: Nginx WordPress | Plugins | Enable Nginx Helper purge on update
      ansible.builtin.command:
        cmd: >-
          {{ nginx_wordpress_wpcli_path }} option update rt_wp_nginx_helper_options
          '{{ nginx_helper_options | to_json }}' --format=json
          --path={{ nginx_wordpress_web_root }}
      become_user: "{{ nginx_wordpress_nginx_user }}"
      vars:
        nginx_helper_options:
          enable_purge: "1"
          cache_method: "enable_fastcgi"
          purge_method: "delete_local_server"
          enable_map: "0"
          enable_log: "0"
          enable_stamp: "0"
      register: nginx_helper_config
      changed_when: nginx_helper_config.rc == 0
      failed_when: false

    - name: Nginx WordPress | Plugins | Display Nginx Helper status
      ansible.builtin.debug:
        msg: "Nginx Helper: FastCGI cache purging ENABLED ✓"
  when: wp_config_check.stat.exists
  tags: [nginx-wordpress, wordpress, plugins, cache]

# ========================================
# Post-Installation Instructions
# ========================================

- name: Nginx WordPress | Plugins | Post-installation instructions
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "WordPress Post-Installation Wizards"
      - "========================================="
      - ""
      - "STEP 1 - Import Starter Template:"
      - "   Appearance → Kadence → Starter Templates"
      - "   → Select 'Gutenberg' as page builder"
      - "   → Choose 'Business Courses' template"
      - "   → Click 'Import Complete Site'"
      - ""
      - "STEP 2 - Customize Branding:"
      - "   Appearance → Customize → Site Identity"
      - "   → Upload logo and favicon"
      - "   → Set site title/tagline"
      - ""
      - "STEP 3 - Backups (UpdraftPlus):"
      - "   Settings → UpdraftPlus Backups"
      - "   → Connect Google Drive or Dropbox"
      - "   → Schedule: Daily DB, Weekly files"
      - ""
      - "STEP 4 - Email (WP Mail SMTP):"
      - "   WP Mail SMTP → Settings"
      - "   → Mailer: Brevo (300 emails/day free)"
      - "   → Get API key: https://app.brevo.com/settings/keys/api"
      - "   → Send test email"
      - ""
      - "STEP 5 - SEO (Rank Math):"
      - "   Rank Math → Setup Wizard"
      - "   → Connect Google Search Console (optional)"
      - "   → Configure sitemap"
      - ""
      - "STEP 6 - GDPR (Cookie Notice):"
      - "   Settings → Cookie Notice"
      - "   → Enable banner"
      - "   → Customize text/colors"
      - ""
      - "STEP 7 - 2FA (Wordfence Login Security):"
      - "   Users → Your Profile"
      - "   → Enable 2FA with authenticator app"
      - ""
      - "STEP 8 - Accessibility:"
      - "   Settings → Accessibility Assistant"
      - "   → Enable widget on frontend"
      - "   → Configure ADHD/Dyslexia modes"
      - ""
      - "MANUAL INSTALL REQUIRED:"
      - ""
      - "STEP 9 - LearnDash Pro:"
      - "   Plugins → Add New → Upload Plugin"
      - "   → Upload LearnDash zip from your account"
      - "   → Activate with license key"
      - "   → Run LearnDash Setup Wizard"
      - ""
      - "STEP 10 - Kadence Pro (optional, $149/year):"
      - "   Plugins → Add New → Upload Plugin"
      - "   → Upload Kadence Pro zip"
      - "   → Unlocks: Header/Footer builder, WooCommerce, Advanced Hooked Elements"
      - ""
      - "========================================="
      - "ALREADY CONFIGURED (no action needed):"
      - "========================================="
      - "  ✓ Redis Object Cache - Valkey connected"
      - "  ✓ Nginx Helper - Cache purging enabled"
      - "  ✓ Cloudflare WAF - DDoS protection"
      - "  ✓ Fail2ban - Brute force protection"
      - "  ✓ AppArmor - Process isolation"
      - ""
      - "========================================="
  when: wp_config_check.stat.exists
  run_once: true
  tags: [nginx-wordpress, wordpress, plugins, info]
