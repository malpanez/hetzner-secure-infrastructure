---
# Nginx WordPress Role - WordPress Plugins Installation

- name: Nginx WordPress | Plugins | Check if WordPress is installed
  ansible.builtin.stat:
    path: "{{ nginx_wordpress_web_root }}/wp-config.php"
  register: wp_config_check
  tags: [nginx-wordpress, wordpress, plugins]

- name: Nginx WordPress | Plugins | Install mandatory WordPress plugins
  ansible.builtin.command:
    cmd: "{{ nginx_wordpress_wpcli_path }} plugin install {{ nginx_wordpress_plugins_mandatory | join(' ') }} --activate --path={{ nginx_wordpress_web_root }}"
  become_user: "{{ nginx_wordpress_nginx_user }}"
  register: plugin_install
  changed_when: "'Success: Plugin already installed' not in plugin_install.stdout"
  failed_when: false
  when: wp_config_check.stat.exists
  tags: [nginx-wordpress, wordpress, plugins, molecule-notest]

- name: Nginx WordPress | Plugins | Check plugin installation status
  ansible.builtin.command:
    cmd: "{{ nginx_wordpress_wpcli_path }} plugin list --path={{ nginx_wordpress_web_root }} --format=json"
  become_user: "{{ nginx_wordpress_nginx_user }}"
  register: installed_plugins
  changed_when: false
  when: wp_config_check.stat.exists
  tags: [nginx-wordpress, wordpress, plugins, molecule-notest]

- name: Nginx WordPress | Plugins | Display installed plugins
  ansible.builtin.debug:
    msg: "{{ ['========================================',
             'Installed WordPress Plugins',
             '========================================'] +
            (installed_plugins.stdout | from_json | map(attribute='name') | list) +
            ['========================================',
             '',
             'Infrastructure-Provided Features:',
             '  ✓ Cloudflare WAF - Security & bot protection',
             '  ✓ Nginx FastCGI - Full page caching',
             '  ✓ Valkey - Object & database caching',
             '  ✓ AppArmor - Mandatory access control',
             '  ✓ Fail2ban - Brute force protection',
             '',
             'NOTE: LearnDash Pro must be installed manually with license',
             '========================================'] }}"
  when:
    - wp_config_check.stat.exists
    - installed_plugins.stdout is defined
  tags: [nginx-wordpress, wordpress, plugins, info]

- name: Nginx WordPress | Plugins | Configure Redis Object Cache
  block:
    - name: Nginx WordPress | Plugins | Check if Redis/Valkey is running
      ansible.builtin.systemd:
        name: valkey
      register: valkey_status
      failed_when: false
      changed_when: false

    - name: Nginx WordPress | Plugins | Enable Redis Object Cache
      ansible.builtin.command:
        cmd: "{{ nginx_wordpress_wpcli_path }} redis enable --path={{ nginx_wordpress_web_root }}"
      become_user: "{{ nginx_wordpress_nginx_user }}"
      when: valkey_status.status.ActiveState == 'active'
      register: redis_enable
      changed_when: "'already enabled' not in redis_enable.stdout"
      failed_when: false

    - name: Nginx WordPress | Plugins | Display Redis cache status
      ansible.builtin.debug:
        msg: "Redis Object Cache: {{ 'ENABLED ✓' if valkey_status.status.ActiveState == 'active' else 'DISABLED (Valkey not running)' }}"
  when: wp_config_check.stat.exists
  tags: [nginx-wordpress, wordpress, plugins, redis]

- name: Nginx WordPress | Plugins | Configure Nginx Helper
  block:
    - name: Nginx WordPress | Plugins | Enable Nginx Helper purge on update
      ansible.builtin.command:
        cmd: "{{ nginx_wordpress_wpcli_path }} option update rt_wp_nginx_helper_options '{{ nginx_helper_options | to_json }}' --format=json --path={{ nginx_wordpress_web_root }}"
      become_user: "{{ nginx_wordpress_nginx_user }}"
      vars:
        nginx_helper_options:
          enable_purge: "1"
          cache_method: "enable_fastcgi"
          purge_method: "delete_local_server"
          enable_map: "0"
          enable_log: "0"
          enable_stamp: "0"
      register: nginx_helper_config
      changed_when: nginx_helper_config.rc == 0
      failed_when: false

    - name: Nginx WordPress | Plugins | Display Nginx Helper status
      ansible.builtin.debug:
        msg: "Nginx Helper: FastCGI cache purging ENABLED ✓"
  when: wp_config_check.stat.exists
  tags: [nginx-wordpress, wordpress, plugins, cache]

- name: Nginx WordPress | Plugins | Post-installation instructions
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "WordPress Post-Installation Tasks"
      - "========================================="
      - ""
      - "REQUIRED:"
      - ""
      - "1. LearnDash Pro (LMS):"
      - "   • Install manually from WordPress admin"
      - "   • Activate with license key"
      - "   • Configure course settings & payment gateways"
      - ""
      - "2. Redis Object Cache:"
      - "   • {{ 'ENABLED ✓ - Monitor via WordPress admin' if valkey_status.status.ActiveState == 'active' else 'Install Valkey role first' }}"
      - ""
      - "3. Nginx Helper:"
      - "   • CONFIGURED ✓ - Cache auto-purges on updates"
      - ""
      - "OPTIONAL:"
      - ""
      - "4. Cloudflare Plugin (if using Cloudflare):"
      - "   • Configure API token"
      - "   • Enable auto-cache purge"
      - ""
      - "SECURITY NOTES:"
      - ""
      - "Infrastructure-level security (already active):"
      - "  ✓ Cloudflare WAF - Blocks malicious traffic"
      - "  ✓ UFW Firewall - Port restrictions"
      - "  ✓ Fail2ban - Brute force protection"
      - "  ✓ AppArmor - Process isolation"
      - "  ✓ Nginx rate limiting - Login protection"
      - ""
      - "WordPress-level (configure in admin panel):"
      - "  • Use strong admin passwords"
      - "  • Limit login attempts (via Limit Login Attempts Reloaded)"
      - "  • Regular updates (auto-update minor releases)"
      - "  • Database backups (manual or UpdraftPlus)"
      - ""
      - "========================================="
  when: wp_config_check.stat.exists
  run_once: true
  tags: [nginx-wordpress, wordpress, plugins, info]
