---
# Nginx WordPress Role - WordPress Optimization Settings
# Applies optimal settings via WP-CLI for LMS performance and security

- name: Nginx WordPress | Optimization | Check if WordPress is installed
  ansible.builtin.stat:
    path: "{{ nginx_wordpress_web_root }}/wp-config.php"
  register: wp_config_check
  tags: [nginx-wordpress, wordpress, optimization]

# ========================================
# General Settings
# ========================================

- name: Nginx WordPress | Optimization | Set timezone
  ansible.builtin.command:
    cmd: >-
      {{ nginx_wordpress_wpcli_path }} option update timezone_string
      '{{ nginx_wordpress_timezone }}'
      --path={{ nginx_wordpress_web_root }}
  become_user: "{{ nginx_wordpress_nginx_user }}"
  changed_when: true
  failed_when: false
  when:
    - wp_config_check.stat.exists
    - nginx_wordpress_timezone is defined
  tags: [nginx-wordpress, wordpress, optimization, molecule-notest]

- name: Nginx WordPress | Optimization | Set date format
  ansible.builtin.command:
    cmd: >-
      {{ nginx_wordpress_wpcli_path }} option update date_format
      '{{ nginx_wordpress_date_format }}'
      --path={{ nginx_wordpress_web_root }}
  become_user: "{{ nginx_wordpress_nginx_user }}"
  changed_when: true
  failed_when: false
  when:
    - wp_config_check.stat.exists
    - nginx_wordpress_date_format is defined
  tags: [nginx-wordpress, wordpress, optimization, molecule-notest]

- name: Nginx WordPress | Optimization | Set time format
  ansible.builtin.command:
    cmd: >-
      {{ nginx_wordpress_wpcli_path }} option update time_format
      '{{ nginx_wordpress_time_format }}'
      --path={{ nginx_wordpress_web_root }}
  become_user: "{{ nginx_wordpress_nginx_user }}"
  changed_when: true
  failed_when: false
  when:
    - wp_config_check.stat.exists
    - nginx_wordpress_time_format is defined
  tags: [nginx-wordpress, wordpress, optimization, molecule-notest]

# ========================================
# Permalink Structure (SEO)
# ========================================

- name: Nginx WordPress | Optimization | Set permalink structure
  ansible.builtin.command:
    cmd: >-
      {{ nginx_wordpress_wpcli_path }} rewrite structure
      '{{ nginx_wordpress_permalink_structure }}'
      --path={{ nginx_wordpress_web_root }}
  become_user: "{{ nginx_wordpress_nginx_user }}"
  changed_when: true
  failed_when: false
  when:
    - wp_config_check.stat.exists
    - nginx_wordpress_permalink_structure is defined
  tags: [nginx-wordpress, wordpress, optimization, seo, molecule-notest]

- name: Nginx WordPress | Optimization | Flush rewrite rules
  ansible.builtin.command:
    cmd: >-
      {{ nginx_wordpress_wpcli_path }} rewrite flush
      --path={{ nginx_wordpress_web_root }}
  become_user: "{{ nginx_wordpress_nginx_user }}"
  changed_when: false
  when: wp_config_check.stat.exists
  tags: [nginx-wordpress, wordpress, optimization, molecule-notest]

# ========================================
# Disable Comments (not needed for LMS)
# ========================================

- name: Nginx WordPress | Optimization | Disable comments on posts
  ansible.builtin.command:
    cmd: >-
      {{ nginx_wordpress_wpcli_path }} option update default_comment_status 'closed'
      --path={{ nginx_wordpress_web_root }}
  become_user: "{{ nginx_wordpress_nginx_user }}"
  changed_when: true
  failed_when: false
  when:
    - wp_config_check.stat.exists
    - nginx_wordpress_disable_comments | default(false) | bool
  tags: [nginx-wordpress, wordpress, optimization, molecule-notest]

- name: Nginx WordPress | Optimization | Disable pingbacks
  ansible.builtin.command:
    cmd: >-
      {{ nginx_wordpress_wpcli_path }} option update default_ping_status 'closed'
      --path={{ nginx_wordpress_web_root }}
  become_user: "{{ nginx_wordpress_nginx_user }}"
  changed_when: true
  failed_when: false
  when:
    - wp_config_check.stat.exists
    - nginx_wordpress_disable_pingbacks | default(false) | bool
  tags: [nginx-wordpress, wordpress, optimization, molecule-notest]

- name: Nginx WordPress | Optimization | Disable trackbacks
  ansible.builtin.command:
    cmd: >-
      {{ nginx_wordpress_wpcli_path }} option update default_pingback_flag '0'
      --path={{ nginx_wordpress_web_root }}
  become_user: "{{ nginx_wordpress_nginx_user }}"
  changed_when: true
  failed_when: false
  when:
    - wp_config_check.stat.exists
    - nginx_wordpress_disable_pingbacks | default(false) | bool
  tags: [nginx-wordpress, wordpress, optimization, molecule-notest]

# ========================================
# Database Optimization
# ========================================

- name: Nginx WordPress | Optimization | Set revision limit in wp-config.php
  ansible.builtin.lineinfile:
    path: "{{ nginx_wordpress_web_root }}/wp-config.php"
    regexp: "^define\\s*\\(\\s*'WP_POST_REVISIONS'"
    line: "define('WP_POST_REVISIONS', {{ nginx_wordpress_revision_limit }});"
    insertbefore: "^/\\* That's all"
    state: present
  when:
    - wp_config_check.stat.exists
    - nginx_wordpress_revision_limit is defined
  tags: [nginx-wordpress, wordpress, optimization]

- name: Nginx WordPress | Optimization | Disable file editing in admin
  ansible.builtin.lineinfile:
    path: "{{ nginx_wordpress_web_root }}/wp-config.php"
    regexp: "^define\\s*\\(\\s*'DISALLOW_FILE_EDIT'"
    line: "define('DISALLOW_FILE_EDIT', true);"
    insertbefore: "^/\\* That's all"
    state: present
  when: wp_config_check.stat.exists
  tags: [nginx-wordpress, wordpress, optimization, security]

- name: Nginx WordPress | Optimization | Set autosave interval (5 minutes)
  ansible.builtin.lineinfile:
    path: "{{ nginx_wordpress_web_root }}/wp-config.php"
    regexp: "^define\\s*\\(\\s*'AUTOSAVE_INTERVAL'"
    line: "define('AUTOSAVE_INTERVAL', 300);"
    insertbefore: "^/\\* That's all"
    state: present
  when: wp_config_check.stat.exists
  tags: [nginx-wordpress, wordpress, optimization]

- name: Nginx WordPress | Optimization | Empty trash after 7 days
  ansible.builtin.lineinfile:
    path: "{{ nginx_wordpress_web_root }}/wp-config.php"
    regexp: "^define\\s*\\(\\s*'EMPTY_TRASH_DAYS'"
    line: "define('EMPTY_TRASH_DAYS', 7);"
    insertbefore: "^/\\* That's all"
    state: present
  when: wp_config_check.stat.exists
  tags: [nginx-wordpress, wordpress, optimization]

# ========================================
# Security Hardening
# ========================================

- name: Nginx WordPress | Optimization | Disable XML-RPC (not needed, security risk)
  ansible.builtin.command:
    cmd: >-
      {{ nginx_wordpress_wpcli_path }} option update enable_xmlrpc '0'
      --path={{ nginx_wordpress_web_root }}
  become_user: "{{ nginx_wordpress_nginx_user }}"
  changed_when: true
  failed_when: false
  when: wp_config_check.stat.exists
  tags: [nginx-wordpress, wordpress, optimization, security, molecule-notest]

- name: Nginx WordPress | Optimization | Discourage search engines (staging only)
  ansible.builtin.command:
    cmd: >-
      {{ nginx_wordpress_wpcli_path }} option update blog_public '0'
      --path={{ nginx_wordpress_web_root }}
  become_user: "{{ nginx_wordpress_nginx_user }}"
  changed_when: true
  failed_when: false
  when:
    - wp_config_check.stat.exists
    - "'stag' in inventory_hostname or 'dev' in inventory_hostname or 'test' in inventory_hostname"
  tags: [nginx-wordpress, wordpress, optimization, molecule-notest]

# ========================================
# Media Settings
# ========================================

- name: Nginx WordPress | Optimization | Organize uploads by year/month
  ansible.builtin.command:
    cmd: >-
      {{ nginx_wordpress_wpcli_path }} option update uploads_use_yearmonth_folders '1'
      --path={{ nginx_wordpress_web_root }}
  become_user: "{{ nginx_wordpress_nginx_user }}"
  changed_when: true
  failed_when: false
  when: wp_config_check.stat.exists
  tags: [nginx-wordpress, wordpress, optimization, molecule-notest]

# ========================================
# Cache Optimization
# ========================================

- name: Nginx WordPress | Optimization | Clear all caches
  ansible.builtin.command:
    cmd: >-
      {{ nginx_wordpress_wpcli_path }} cache flush
      --path={{ nginx_wordpress_web_root }}
  become_user: "{{ nginx_wordpress_nginx_user }}"
  changed_when: false
  failed_when: false
  when: wp_config_check.stat.exists
  tags: [nginx-wordpress, wordpress, optimization, molecule-notest]

# ========================================
# Summary
# ========================================

- name: Nginx WordPress | Optimization | Display optimization summary
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "WordPress Optimization Applied"
      - "========================================="
      - ""
      - "GENERAL:"
      - "  ✓ Timezone: {{ nginx_wordpress_timezone }}"
      - "  ✓ Date format: {{ nginx_wordpress_date_format }}"
      - "  ✓ Time format: {{ nginx_wordpress_time_format }}"
      - ""
      - "SEO:"
      - "  ✓ Permalinks: {{ nginx_wordpress_permalink_structure }}"
      - ""
      - "PERFORMANCE:"
      - "  ✓ Post revisions limit: {{ nginx_wordpress_revision_limit }}"
      - "  ✓ Autosave interval: 5 minutes"
      - "  ✓ Empty trash: 7 days"
      - "  ✓ Uploads organized by year/month"
      - ""
      - "SECURITY:"
      - "  ✓ File editing in admin: DISABLED"
      - "  ✓ XML-RPC: DISABLED"
      - "  ✓ Comments: {{ 'DISABLED' if nginx_wordpress_disable_comments else 'ENABLED' }}"
      - "  ✓ Pingbacks/Trackbacks: {{ 'DISABLED' if nginx_wordpress_disable_pingbacks else 'ENABLED' }}"
      - ""
      - "========================================="
  when: wp_config_check.stat.exists
  run_once: true
  tags: [nginx-wordpress, wordpress, optimization, info]
