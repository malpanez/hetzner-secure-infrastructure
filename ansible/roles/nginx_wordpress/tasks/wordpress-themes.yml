---
# Nginx WordPress Role - WordPress Themes Installation

- name: Nginx WordPress | Themes | Check if WordPress is installed
  ansible.builtin.stat:
    path: "{{ nginx_wordpress_web_root }}/wp-config.php"
  register: wp_config_check
  tags: [nginx-wordpress, wordpress, themes]

- name: Nginx WordPress | Themes | Install primary theme
  ansible.builtin.command:
    cmd: >-
      {{ nginx_wordpress_wpcli_path }} theme install
      {{ nginx_wordpress_theme }} --path={{ nginx_wordpress_web_root }}
  become_user: "{{ nginx_wordpress_nginx_user }}"
  register: theme_install
  changed_when: "'Success: Installed' in theme_install.stdout"
  failed_when: false
  when:
    - wp_config_check.stat.exists
    - nginx_wordpress_theme is defined
    - nginx_wordpress_theme | length > 0
  tags: [nginx-wordpress, wordpress, themes, molecule-notest]

- name: Nginx WordPress | Themes | Activate primary theme
  ansible.builtin.command:
    cmd: >-
      {{ nginx_wordpress_wpcli_path }} theme activate
      {{ nginx_wordpress_theme }} --path={{ nginx_wordpress_web_root }}
  become_user: "{{ nginx_wordpress_nginx_user }}"
  register: theme_activate
  changed_when: "'Success: Switched' in theme_activate.stdout"
  failed_when: false
  when:
    - wp_config_check.stat.exists
    - nginx_wordpress_theme is defined
    - nginx_wordpress_theme | length > 0
    - nginx_wordpress_theme_activate | default(true)
  tags: [nginx-wordpress, wordpress, themes, molecule-notest]

- name: Nginx WordPress | Themes | Install additional themes
  ansible.builtin.command:
    cmd: >-
      {{ nginx_wordpress_wpcli_path }} theme install {{ item }}
      --path={{ nginx_wordpress_web_root }}
  become_user: "{{ nginx_wordpress_nginx_user }}"
  loop: "{{ nginx_wordpress_themes_additional }}"
  register: additional_themes_install
  changed_when: "'Success: Installed' in additional_themes_install.stdout"
  failed_when: false
  when:
    - wp_config_check.stat.exists
    - nginx_wordpress_themes_additional is defined
    - nginx_wordpress_themes_additional | length > 0
  tags: [nginx-wordpress, wordpress, themes, molecule-notest]

- name: Nginx WordPress | Themes | Get list of installed themes
  ansible.builtin.command:
    cmd: >-
      {{ nginx_wordpress_wpcli_path }} theme list
      --path={{ nginx_wordpress_web_root }} --format=json
  become_user: "{{ nginx_wordpress_nginx_user }}"
  register: installed_themes
  changed_when: false
  when: wp_config_check.stat.exists
  tags: [nginx-wordpress, wordpress, themes, molecule-notest]

- name: Nginx WordPress | Themes | Display installed themes
  ansible.builtin.debug:
    msg: "{{ ['========================================',
             'Installed WordPress Themes',
             '========================================',
             'Active Theme: ' + active_theme_name,
             '',
             'All Installed Themes:'] +
            installed_theme_names +
            ['',
             'Theme Information:',
             '  • Astra: Free, ultra-lightweight, 1.7M+ installs, LearnDash official partner',
             '  • GeneratePress: Free, performance-focused',
             '  • Neve: Free, mobile-first, AMP-ready',
             '',
             'Astra + LearnDash: Official integration with dedicated starter sites',
             'All themes are 100% FREE from WordPress.org',
             '========================================'] }}"
  vars:
    active_theme_name: >-
      {{ installed_themes.stdout
         | from_json
         | selectattr('status', 'equalto', 'active')
         | map(attribute='name')
         | first
         | default('unknown') }}
    installed_theme_names: >-
      {{ installed_themes.stdout | from_json | map(attribute='name') | list }}
  when:
    - wp_config_check.stat.exists
    - installed_themes.stdout is defined
  tags: [nginx-wordpress, wordpress, themes, info]

- name: Nginx WordPress | Themes | Post-installation notes
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "WordPress Theme Installation Complete"
      - "========================================="
      - ""
      - "Primary theme installed: {{ nginx_wordpress_theme }}"
      - "Theme activated: {{ 'Yes' if nginx_wordpress_theme_activate else 'No' }}"
      - ""
      - "NEXT STEPS (Astra + LearnDash Academy):"
      - ""
      - "1. Install LearnDash Pro:"
      - "   - Upload from Plugins -> Add New -> Upload"
      - "   - Activate with license key"
      - "   - Install LearnDash Course Grid plugin"
      - ""
      - "2. Import LearnDash Academy Starter Template:"
      - "   - Install 'Starter Templates' plugin (free)"
      - "   - Go to: Appearance -> Starter Templates"
      - "   - Select page builder (Gutenberg or Elementor)"
      - "   - Search: 'LearnDash Academy'"
      - "   - Click 'Import Complete Site'"
      - ""
      - "3. Customize:"
      - "   - Appearance -> Customize (logo, colors)"
      - "   - Create courses in LearnDash -> Courses"
      - ""
      - "Reference: https://wpastra.com/templates/learndash-academy-02/"
      - "========================================="
  when: wp_config_check.stat.exists
  run_once: true
  tags: [nginx-wordpress, wordpress, themes, info]
