---
# Nginx WordPress Role - WordPress Themes Installation

- name: Nginx WordPress | Themes | Check if WordPress is installed
  ansible.builtin.stat:
    path: "{{ nginx_wordpress_web_root }}/wp-config.php"
  register: wp_config_check
  tags: [nginx-wordpress, wordpress, themes]

- name: Nginx WordPress | Themes | Install primary theme
  ansible.builtin.command:
    cmd: "{{ nginx_wordpress_wpcli_path }} theme install {{ nginx_wordpress_theme }} --path={{ nginx_wordpress_web_root }}"
  become_user: "{{ nginx_wordpress_nginx_user }}"
  register: theme_install
  changed_when: "'Success: Installed' in theme_install.stdout"
  failed_when: false
  when:
    - wp_config_check.stat.exists
    - nginx_wordpress_theme is defined
    - nginx_wordpress_theme | length > 0
  tags: [nginx-wordpress, wordpress, themes, molecule-notest]

- name: Nginx WordPress | Themes | Activate primary theme
  ansible.builtin.command:
    cmd: "{{ nginx_wordpress_wpcli_path }} theme activate {{ nginx_wordpress_theme }} --path={{ nginx_wordpress_web_root }}"
  become_user: "{{ nginx_wordpress_nginx_user }}"
  register: theme_activate
  changed_when: "'Success: Switched' in theme_activate.stdout"
  failed_when: false
  when:
    - wp_config_check.stat.exists
    - nginx_wordpress_theme is defined
    - nginx_wordpress_theme | length > 0
    - nginx_wordpress_theme_activate | default(true)
  tags: [nginx-wordpress, wordpress, themes, molecule-notest]

- name: Nginx WordPress | Themes | Install additional themes
  ansible.builtin.command:
    cmd: "{{ nginx_wordpress_wpcli_path }} theme install {{ item }} --path={{ nginx_wordpress_web_root }}"
  become_user: "{{ nginx_wordpress_nginx_user }}"
  loop: "{{ nginx_wordpress_themes_additional }}"
  register: additional_themes_install
  changed_when: "'Success: Installed' in additional_themes_install.stdout"
  failed_when: false
  when:
    - wp_config_check.stat.exists
    - nginx_wordpress_themes_additional is defined
    - nginx_wordpress_themes_additional | length > 0
  tags: [nginx-wordpress, wordpress, themes, molecule-notest]

- name: Nginx WordPress | Themes | Get list of installed themes
  ansible.builtin.command:
    cmd: "{{ nginx_wordpress_wpcli_path }} theme list --path={{ nginx_wordpress_web_root }} --format=json"
  become_user: "{{ nginx_wordpress_nginx_user }}"
  register: installed_themes
  changed_when: false
  when: wp_config_check.stat.exists
  tags: [nginx-wordpress, wordpress, themes, molecule-notest]

- name: Nginx WordPress | Themes | Display installed themes
  ansible.builtin.debug:
    msg: "{{ ['========================================',
             'Installed WordPress Themes',
             '========================================',
             'Active Theme: ' + (installed_themes.stdout | from_json | selectattr('status', 'equalto', 'active') | map(attribute='name') | first | default('unknown')),
             '',
             'All Installed Themes:'] +
            (installed_themes.stdout | from_json | map(attribute='name') | list) +
            ['',
             'Theme Information:',
             '  • Kadence: Free, LearnDash-compatible, header/footer builder',
             '  • Astra: Free, ultra-lightweight, 1.7M+ installs',
             '  • Neve: Free, mobile-first, AMP-ready',
             '  • GeneratePress: Free, performance-focused',
             '',
             'All themes are 100% FREE from WordPress.org',
             '========================================'] }}"
  when:
    - wp_config_check.stat.exists
    - installed_themes.stdout is defined
  tags: [nginx-wordpress, wordpress, themes, info]

- name: Nginx WordPress | Themes | Post-installation notes
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "WordPress Theme Installation Complete"
      - "========================================="
      - ""
      - "✓ Primary theme installed: {{ nginx_wordpress_theme }}"
      - "✓ Theme activated: {{ 'Yes' if nginx_wordpress_theme_activate else 'No' }}"
      - ""
      - "NEXT STEPS:"
      - ""
      - "1. Customize Theme:"
      - "   • Go to: Appearance → Customize"
      - "   • Set logo, colors, typography"
      - "   • Configure header/footer"
      - ""
      - "2. {{ nginx_wordpress_theme | capitalize }} Specific:"
      - "{{ '   • Appearance → Kadence → Starter Templates (FREE)' if nginx_wordpress_theme == 'kadence' else '   • Install Starter Templates plugin (free)' }}"
      - "{{ '   • Choose LearnDash-compatible template' if nginx_wordpress_theme == 'kadence' else '   • Import LearnDash starter site' }}"
      - "{{ '   • Import demo content (optional)' if nginx_wordpress_theme == 'kadence' else '' }}"
      - ""
      - "3. Install LearnDash Pro:"
      - "   • Upload from Plugins → Add New → Upload"
      - "   • Activate with license key"
      - ""
      - "========================================="
  when: wp_config_check.stat.exists
  run_once: true
  tags: [nginx-wordpress, wordpress, themes, info]
