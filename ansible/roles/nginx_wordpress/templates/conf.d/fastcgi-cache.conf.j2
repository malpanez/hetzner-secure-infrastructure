# ============================================================================
# FastCGI Cache Configuration
# ============================================================================
# Managed by Ansible - nginx_wordpress role
#
# This configuration creates a FastCGI cache for WordPress pages.
# The cache stores complete HTML responses in memory/disk, allowing Nginx
# to serve pages without executing PHP or querying the database.
#
# Performance Impact: 30x faster page loads (300ms â†’ 10ms)
# ============================================================================

{% if nginx_wordpress_enable_fastcgi_cache | default(true) %}
# Cache storage configuration
fastcgi_cache_path /var/cache/nginx/wordpress
    levels=1:2                      # 2-level directory hierarchy (prevents too many files in one dir)
    keys_zone=wordpress:100m        # 100MB shared memory for cache keys (~800,000 pages)
    inactive=60m                    # Remove cached items not accessed for 60 minutes
    max_size=512m                   # Maximum 512MB disk space for cache files
    use_temp_path=off;              # Write directly to cache (faster, less I/O)

# Cache key format: creates unique identifier for each page
# Example: "httpsGETexample.com/courses/php-101?page=2"
fastcgi_cache_key "$scheme$request_method$host$request_uri";

# Use stale cache during backend issues (keeps site running during problems)
fastcgi_cache_use_stale error timeout invalid_header updating http_500 http_503;

# Update cache in background while serving stale content (better UX)
fastcgi_cache_background_update on;

# Prevent cache stampede: only one request generates cache, others wait
fastcgi_cache_lock on;
fastcgi_cache_lock_timeout 5s;

# Ignore these headers from WordPress (we control caching at Nginx level)
# WordPress plugins often set "no-cache" unnecessarily
fastcgi_ignore_headers Cache-Control Expires Set-Cookie;
{% endif %}
