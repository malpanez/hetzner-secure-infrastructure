# Nginx Main Configuration
# Optimized for WordPress + Tutor LMS
# Generated by Ansible

user {{ wordpress_user }};
worker_processes {{ nginx_worker_processes }};
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

# Performance: Increase file descriptor limit
worker_rlimit_nofile 65535;

events {
    worker_connections {{ nginx_worker_connections }};
    use epoll; # Efficient connection processing on Linux
    multi_accept on; # Accept multiple connections at once
}

http {
    ##
    # Basic Settings
    ##

    sendfile {{ nginx_sendfile }};
    tcp_nopush {{ nginx_tcp_nopush }};
    tcp_nodelay {{ nginx_tcp_nodelay }};
    keepalive_timeout {{ nginx_keepalive_timeout }};
    types_hash_max_size 2048;
    server_tokens off; # Hide Nginx version

    # Increase buffer sizes (helps with WordPress admin)
    client_body_buffer_size 128k;
    client_max_body_size {{ nginx_client_max_body_size }};
    client_header_buffer_size 1k;
    large_client_header_buffers 4 16k;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    ##
    # SSL Settings (Modern Configuration)
    ##

    ssl_protocols {{ nginx_ssl_protocols }};
    ssl_ciphers '{{ nginx_ssl_ciphers }}';
    ssl_prefer_server_ciphers {{ nginx_ssl_prefer_server_ciphers }};

    # SSL session caching
    ssl_session_cache {{ nginx_ssl_session_cache }};
    ssl_session_timeout {{ nginx_ssl_session_timeout }};
    ssl_session_tickets off;

    # Diffie-Hellman parameters for DHE ciphersuites
    ssl_dhparam /etc/nginx/dhparam.pem;

{% if nginx_ssl_stapling %}
    # OCSP stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 1.1.1.1 1.0.0.1 [2606:4700:4700::1111] [2606:4700:4700::1001] valid=300s;
    resolver_timeout 5s;
{% endif %}

    ##
    # Logging Settings
    ##

    log_format custom {{ nginx_log_format }};

    access_log /var/log/nginx/access.log custom;
    error_log /var/log/nginx/error.log warn;

    ##
    # Gzip Compression
    ##

{% if nginx_gzip_enabled %}
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level {{ nginx_gzip_comp_level }};
    gzip_types {{ nginx_gzip_types | join(' ') }};
    gzip_disable "msie6";
    gzip_min_length 256;
{% else %}
    gzip off;
{% endif %}

    ##
    # Brotli Compression (if module available)
    ##

{% if nginx_brotli_enabled %}
    brotli on;
    brotli_comp_level {{ nginx_brotli_comp_level }};
    brotli_types {{ nginx_gzip_types | join(' ') }};
{% endif %}

    ##
    # Open File Cache
    ##

{% if nginx_open_file_cache_enabled %}
    open_file_cache max={{ nginx_open_file_cache_max }} inactive={{ nginx_open_file_cache_inactive }};
    open_file_cache_valid {{ nginx_open_file_cache_valid }};
    open_file_cache_min_uses {{ nginx_open_file_cache_min_uses }};
    open_file_cache_errors {{ nginx_open_file_cache_errors }};
{% endif %}

    ##
    # FastCGI Cache Settings
    ##

{% if nginx_fastcgi_cache_enabled %}
    fastcgi_cache_path {{ nginx_fastcgi_cache_path }}
                       levels=1:2
                       keys_zone=wordpress:{{ nginx_fastcgi_cache_size }}
                       inactive={{ nginx_fastcgi_cache_inactive }}
                       max_size=512m;

    fastcgi_cache_key "$scheme$request_method$host$request_uri";
    fastcgi_cache_use_stale error timeout invalid_header updating http_500;
    fastcgi_cache_background_update on;
    fastcgi_cache_lock on;
    fastcgi_ignore_headers Cache-Control Expires Set-Cookie;
{% endif %}

    ##
    # Rate Limiting
    ##

{% if nginx_rate_limit_enabled %}
    # Login rate limiting
    limit_req_zone $binary_remote_addr zone={{ nginx_rate_limit_zone }}:{{ nginx_rate_limit_size }} rate={{ nginx_rate_limit_rate }};
    limit_req_status 429;
{% endif %}

    ##
    # Real IP Configuration (Cloudflare)
    ##

{% if cloudflare_enabled %}
    # Get real IP from Cloudflare
    real_ip_header {{ nginx_real_ip_header }};
    real_ip_recursive {{ nginx_real_ip_recursive }};

    # Cloudflare IPv4 ranges
{% for ip_range in cloudflare_ipv4_ranges %}
    set_real_ip_from {{ ip_range }};
{% endfor %}

    # Cloudflare IPv6 ranges
{% for ip_range in cloudflare_ipv6_ranges %}
    set_real_ip_from {{ ip_range }};
{% endfor %}
{% endif %}

    ##
    # Virtual Host Configs
    ##

    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}
