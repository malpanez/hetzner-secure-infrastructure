# WordPress + Tutor LMS Nginx Configuration
# Domain: {{ wordpress_domain }}
# Generated by Ansible

# Redirect HTTP to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name {{ wordpress_domain }} www.{{ wordpress_domain }};

    # Let's Encrypt ACME challenge
    location ^~ /.well-known/acme-challenge/ {
        default_type "text/plain";
        root /var/www/letsencrypt;
    }

    # Redirect all other traffic to HTTPS
    location / {
        return 301 https://{{ wordpress_domain }}$request_uri;
    }
}

{% if nginx_ssl_enabled %}
# HTTPS Server Block
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name {{ wordpress_domain }} www.{{ wordpress_domain }};

    root {{ wordpress_root }};
    index index.php index.html index.htm;

    # SSL certificates
    ssl_certificate {{ nginx_ssl_certificate }};
    ssl_certificate_key {{ nginx_ssl_certificate_key }};

{% if nginx_hsts_enabled %}
    # HSTS (HTTP Strict Transport Security)
    add_header Strict-Transport-Security "max-age={{ nginx_hsts_max_age }}{% if nginx_hsts_include_subdomains %}; includeSubDomains{% endif %}{% if nginx_hsts_preload %}; preload{% endif %}" always;
{% endif %}

{% if nginx_security_headers_enabled %}
    # Security headers
{% for header, value in nginx_security_headers.items() %}
    add_header {{ header }} "{{ value }}" always;
{% endfor %}
{% endif %}

{% if nginx_csp_enabled %}
    # Content Security Policy
    add_header Content-Security-Policy "{{ nginx_csp_policy }}" always;
{% endif %}

    # Logging
    access_log {{ nginx_access_log }};
    error_log {{ nginx_error_log }};

    # ========================================
    # WordPress Permalinks
    # ========================================

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    # ========================================
    # PHP Processing
    # ========================================

    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass unix:{{ php_fpm_socket }};
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;

        # FastCGI tuning
        fastcgi_buffers 16 16k;
        fastcgi_buffer_size 32k;
        fastcgi_read_timeout {% if tutor_lms_enabled %}{{ tutor_fastcgi_read_timeout }}{% else %}60{% endif %};
        fastcgi_connect_timeout 60;
        fastcgi_send_timeout 180;

{% if nginx_fastcgi_cache_enabled %}
        # FastCGI caching
        set $skip_cache 0;

        # Don't cache POST requests
        if ($request_method = POST) {
            set $skip_cache 1;
        }

        # Don't cache URLs with query strings (unless static)
        if ($query_string != "") {
            set $skip_cache 1;
        }

        # Don't cache logged-in users or recent commenters
        if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_logged_in") {
            set $skip_cache 1;
        }

        # Don't cache WooCommerce pages (if installed)
        if ($request_uri ~* "/cart|/checkout|/my-account") {
            set $skip_cache 1;
        }

{% if tutor_lms_enabled %}
        # Don't cache Tutor LMS pages
        if ($request_uri ~* "/courses|/lessons|/quiz|/tutor|/dashboard") {
            set $skip_cache 1;
        }
{% endif %}

        # Don't cache WordPress admin
        if ($request_uri ~* "wp-admin|wp-login") {
            set $skip_cache 1;
        }

        fastcgi_cache_bypass $skip_cache;
        fastcgi_no_cache $skip_cache;
        fastcgi_cache wordpress;
        fastcgi_cache_valid {{ nginx_fastcgi_cache_valid_200 }};
        fastcgi_cache_valid 301 {{ nginx_fastcgi_cache_valid_301 }};
        fastcgi_cache_valid 404 {{ nginx_fastcgi_cache_valid_404 }};
        add_header X-FastCGI-Cache $upstream_cache_status;
{% endif %}
    }

    # ========================================
    # Static File Caching
    # ========================================

    # Cache static assets
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot|otf|webp|mp4|webm|ogg)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
        log_not_found off;
    }

    # Cache WordPress uploads
    location ~* ^/wp-content/uploads/.*\.(jpg|jpeg|png|gif|ico|pdf|doc|docx|mp4|webm|zip)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        log_not_found off;
    }

{% if tutor_lms_enabled %}
    # Tutor LMS course materials (protected)
    location ~* ^/wp-content/uploads/tutor/ {
        # Require authentication for course materials
        if ($http_cookie !~* "wordpress_logged_in") {
            return 403;
        }
        expires 7d;
        add_header Cache-Control "private";
    }
{% endif %}

    # ========================================
    # Security: Block Access to Sensitive Files
    # ========================================

    # Block access to WordPress config
{% for file in wordpress_blocked_files %}
    location ~* /{{ file }}$ {
        deny all;
        return 404;
    }
{% endfor %}

    # Block access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Block access to backup files
    location ~* \.(bak|old|orig|sql|tar|gz|zip|rar)$ {
        deny all;
        return 404;
    }

    # Block access to sensitive directories
{% for dir in wordpress_blocked_directories %}
    location ~ /{{ dir }}/ {
        deny all;
        return 404;
    }
{% endfor %}

    # ========================================
    # WordPress-Specific Security
    # ========================================

    # Block XML-RPC (prevent DDoS and brute force)
    location = /xmlrpc.php {
        deny all;
        access_log off;
        log_not_found off;
        return 444;
    }

    # Rate limit wp-login.php
    location = /wp-login.php {
{% if nginx_rate_limit_enabled %}
        limit_req zone={{ nginx_rate_limit_zone }} burst={{ nginx_rate_limit_burst }}{% if not nginx_rate_limit_nodelay %} nodelay{% endif %};
{% endif %}
        include fastcgi_params;
        fastcgi_pass unix:{{ php_fpm_socket }};
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }

    # Protect wp-admin (except AJAX)
    location ~* ^/wp-admin/(?!admin-ajax\.php) {
        # Optional: Restrict to specific IPs
        # allow 203.0.113.50;
        # deny all;

        index index.php;
        try_files $uri $uri/ /wp-admin/index.php?$args;
    }

    # Allow wp-admin AJAX requests (needed for functionality)
    location = /wp-admin/admin-ajax.php {
        include fastcgi_params;
        fastcgi_pass unix:{{ php_fpm_socket }};
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
{% if nginx_fastcgi_cache_enabled %}
        fastcgi_cache_bypass 1;
        fastcgi_no_cache 1;
{% endif %}
    }

    # ========================================
    # WordPress REST API
    # ========================================

    location ~ ^/wp-json/ {
        # Allow REST API but with rate limiting
        try_files $uri $uri/ /index.php?$args;

        # Optional: Rate limit REST API
        # limit_req zone={{ nginx_rate_limit_zone }} burst=20;
    }

    # ========================================
    # WordPress Cron (disable in favor of system cron)
    # ========================================

    location = /wp-cron.php {
        # Block direct access (use system cron instead)
        deny all;
        access_log off;
        log_not_found off;
        return 404;
    }

    # ========================================
    # Favicon and Robots
    # ========================================

    location = /favicon.ico {
        log_not_found off;
        access_log off;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location = /robots.txt {
        log_not_found off;
        access_log off;
    }

    # ========================================
    # Error Pages
    # ========================================

    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;

    location = /50x.html {
        root /usr/share/nginx/html;
    }

    # ========================================
    # Tutor LMS Specific Configurations
    # ========================================

{% if tutor_lms_enabled %}
    # Course content protection
    location ~* ^/courses/ {
        try_files $uri $uri/ /index.php?$args;

{% if tutor_course_protection_enabled %}
        # Require login for courses
        if ($http_cookie !~* "wordpress_logged_in") {
            return 302 /wp-login.php?redirect_to=$request_uri;
        }
{% endif %}
    }

    # Quiz endpoints (no caching)
    location ~* ^/wp-admin/admin-ajax.php.*action=tutor_ {
        include fastcgi_params;
        fastcgi_pass unix:{{ php_fpm_socket }};
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_cache_bypass 1;
        fastcgi_no_cache 1;
    }

    # Course video streaming optimization
    location ~* \.(mp4|webm|ogg)$ {
        mp4;
        mp4_buffer_size 4M;
        mp4_max_buffer_size 10M;
        expires 7d;
        add_header Cache-Control "private";

        # Require authentication
        if ($http_cookie !~* "wordpress_logged_in") {
            return 403;
        }
    }
{% endif %}

    # ========================================
    # Health Check Endpoint
    # ========================================

    location = /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # ========================================
    # Cache Purge Endpoint (requires nginx-cache-purge module)
    # ========================================

    location ~ /purge(/.*) {
        # Restrict to localhost only
        allow 127.0.0.1;
        deny all;

{% if nginx_fastcgi_cache_enabled %}
        fastcgi_cache_purge wordpress "$scheme$request_method$host$1";
{% endif %}
    }
}
{% endif %}
