---
- name: Verify nginx-wordpress role
  hosts: all
  become: true
  tasks:
    - name: Check Nginx is installed
      ansible.builtin.package:
        name: nginx
        state: present
      check_mode: true
      register: nginx_check
      failed_when: nginx_check.changed

    - name: Check Nginx service is running
      ansible.builtin.service:
        name: nginx
        state: started
        enabled: true
      check_mode: true
      register: nginx_service
      failed_when: nginx_service.changed

    - name: Check PHP-FPM is installed
      ansible.builtin.package:
        name: php8.3-fpm
        state: present
      check_mode: true
      register: php_check
      failed_when: php_check.changed

    - name: Check PHP-FPM service is running
      ansible.builtin.service:
        name: php8.3-fpm
        state: started
        enabled: true
      check_mode: true
      register: php_service
      failed_when: php_service.changed

    - name: Check FastCGI cache directory exists
      ansible.builtin.stat:
        path: /var/run/nginx-cache
      register: cache_dir
      failed_when: not cache_dir.stat.exists or not cache_dir.stat.isdir

    - name: Check Nginx config is valid
      ansible.builtin.command: nginx -t
      changed_when: false
      register: nginx_config
      failed_when: nginx_config.rc != 0

    - name: Check PHP-FPM socket exists
      ansible.builtin.stat:
        path: /run/php/php8.3-fpm.sock
      register: php_socket
      failed_when: not php_socket.stat.exists

    - name: Verify Nginx listens on port 80
      ansible.builtin.wait_for:
        port: 80
        timeout: 5
      register: port_80
      failed_when: port_80.failed
