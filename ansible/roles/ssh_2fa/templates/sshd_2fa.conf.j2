# SSH 2FA Configuration
# Managed by Ansible - ssh_2fa role
# This file enables two-factor authentication for SSH

# Enable keyboard-interactive for 2FA
KbdInteractiveAuthentication yes
ChallengeResponseAuthentication {{ ssh_2fa_challenge_response_authentication }}

# Enable PAM for 2FA integration
UsePAM yes

# Require both publickey AND keyboard-interactive (2FA)
# Exception: break-glass users/group bypass 2FA
{% if ssh_2fa_break_glass_enabled | default(true) %}
{% if ssh_2fa_break_glass_users | default([]) | length > 0 %}
Match User {{ ssh_2fa_break_glass_users | join(',') }}
    AuthenticationMethods publickey
{% endif %}
Match Group ansible-automation
    AuthenticationMethods publickey
Match All
{% endif %}
AuthenticationMethods {{ ssh_2fa_auth_methods }}

# Allow publickey authentication
PubkeyAuthentication {{ ssh_2fa_pubkey_authentication }}
