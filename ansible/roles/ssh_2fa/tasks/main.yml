---

- name: SSH 2FA | Main | Load OS-specific variables
  ansible.builtin.include_vars: "{{ ansible_os_family }}.yml"
  tags: [ssh-2fa, always]

# SSH 2FA Role - Main Tasks (Orchestrator)

# Detect OpenSSH version from installed package (Debian/Ubuntu)
- name: SSH 2FA | Preflight | Get OpenSSH package version
  ansible.builtin.package_facts:
    manager: auto
  tags: [ssh-2fa, preflight]

- name: SSH 2FA | Preflight | Extract OpenSSH version from package facts
  ansible.builtin.set_fact:
    openssh_version: >-
      {{ ansible_facts.packages['openssh-server'][0].version
         | default('1:9.0')
         | regex_search('[0-9]+\.[0-9]+')
         | default('9.0') }}
    cacheable: true
  when: "'openssh-server' in ansible_facts.packages"
  tags: [ssh-2fa, preflight]

- name: SSH 2FA | Preflight | Set default OpenSSH version if not detected
  ansible.builtin.set_fact:
    openssh_version: "9.0"
    cacheable: true
  when: openssh_version is not defined
  tags: [ssh-2fa, preflight]

- name: SSH 2FA | Preflight | Display detected OpenSSH version
  ansible.builtin.debug:
    msg: "Detected OpenSSH version: {{ openssh_version }}"
  tags: [ssh-2fa, preflight]

- name: SSH 2FA | Main | Include installation tasks
  ansible.builtin.include_tasks: install.yml
  tags: [ssh-2fa, install]

- name: SSH 2FA | Main | Include faillock configuration tasks
  ansible.builtin.include_tasks: faillock.yml
  when: ssh_2fa_faillock_enabled | default(true)
  tags: [ssh-2fa, faillock, pam]

- name: SSH 2FA | Main | Include root-owned TOTP sudo MFA tasks
  ansible.builtin.include_tasks: totp_sudo.yml
  when: ssh_2fa_totp_root_owned | default(false)
  tags: [ssh-2fa, totp, sudo, mfa]

- name: SSH 2FA | Main | Include configuration tasks
  ansible.builtin.include_tasks: configure.yml
  tags: [ssh-2fa, config]

- name: SSH 2FA | Main | Include service tasks
  ansible.builtin.include_tasks: service.yml
  tags: [ssh-2fa, service]

- name: SSH 2FA | Main | Include validation tasks
  ansible.builtin.include_tasks: validate.yml
  tags: [ssh-2fa, validate]
