---

- name: SSH 2FA | Main | Load OS-specific variables
  ansible.builtin.include_vars: "{{ ansible_os_family }}.yml"
  tags: [ssh-2fa, always]

# SSH 2FA Role - Main Tasks (Orchestrator)

# Detect OpenSSH version for logging and future compatibility checks
- name: SSH 2FA | Preflight | Detect OpenSSH version
  ansible.builtin.command: /usr/sbin/sshd -V
  register: sshd_version_output
  changed_when: false
  failed_when: false
  tags: [ssh-2fa, preflight]

- name: SSH 2FA | Preflight | Extract and normalize SSH version
  ansible.builtin.set_fact:
    openssh_version: >-
      {{ (sshd_version_output.stderr + sshd_version_output.stdout)
         | regex_search('OpenSSH_([0-9]+\.[0-9]+)')
         | default('OpenSSH_9.0')
         | regex_replace('OpenSSH_', '') }}
    cacheable: true
  tags: [ssh-2fa, preflight]

- name: SSH 2FA | Preflight | Display detected OpenSSH version
  ansible.builtin.debug:
    msg: "Detected OpenSSH version: {{ openssh_version }}"
  tags: [ssh-2fa, preflight]

- name: SSH 2FA | Main | Include installation tasks
  ansible.builtin.include_tasks: install.yml
  tags: [ssh-2fa, install]

- name: SSH 2FA | Main | Include faillock configuration tasks
  ansible.builtin.include_tasks: faillock.yml
  when: ssh_2fa_faillock_enabled | default(true)
  tags: [ssh-2fa, faillock, pam]

- name: SSH 2FA | Main | Include root-owned TOTP sudo MFA tasks
  ansible.builtin.include_tasks: totp_sudo.yml
  when: ssh_2fa_totp_root_owned | default(false)
  tags: [ssh-2fa, totp, sudo, mfa]

- name: SSH 2FA | Main | Include configuration tasks
  ansible.builtin.include_tasks: configure.yml
  tags: [ssh-2fa, config]

- name: SSH 2FA | Main | Include service tasks
  ansible.builtin.include_tasks: service.yml
  tags: [ssh-2fa, service]

- name: SSH 2FA | Main | Include validation tasks
  ansible.builtin.include_tasks: validate.yml
  tags: [ssh-2fa, validate]
