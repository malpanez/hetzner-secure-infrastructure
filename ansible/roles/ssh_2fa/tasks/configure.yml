---
# SSH 2FA Role - Configuration Tasks

- name: SSH 2FA | Configure | Ensure sshd_config.d directory exists
  ansible.builtin.file:
    path: /etc/ssh/sshd_config.d
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags: [ssh, config]

- name: SSH 2FA | Configure | Check break-glass users exist
  ansible.builtin.getent:
    database: passwd
    key: "{{ item }}"
  loop: "{{ ssh_2fa_break_glass_users | default([ansible_user]) }}"
  register: ssh_2fa_break_glass_accounts
  when: ssh_2fa_break_glass_enabled | default(true)
  tags: [ssh, 2fa, break-glass]

- name: SSH 2FA | Configure | Check break-glass users have authorized_keys
  ansible.builtin.stat:
    path: "/home/{{ item }}/.ssh/authorized_keys"
  loop: "{{ ssh_2fa_break_glass_users | default([ansible_user]) }}"
  register: ssh_2fa_break_glass_keys
  when: ssh_2fa_break_glass_enabled | default(true)
  tags: [ssh, 2fa, break-glass]

- name: SSH 2FA | Configure | Set break-glass readiness
  ansible.builtin.set_fact:
    ssh_2fa_break_glass_ready: >-
      {{
        (ssh_2fa_break_glass_accounts.results | default([]) | selectattr('failed', 'defined') | list | length == 0)
        and
        (ssh_2fa_break_glass_keys.results | default([]) | selectattr('stat.exists', 'defined') | selectattr('stat.exists') | list | length
          == (ssh_2fa_break_glass_users | default([ansible_user]) | length))
      }}
  when: ssh_2fa_break_glass_enabled | default(true)
  tags: [ssh, 2fa, break-glass]

- name: SSH 2FA | Configure | Warn if break-glass not ready
  ansible.builtin.debug:
    msg: >-
      Break-glass users are not ready (missing user or authorized_keys). Skipping 2FA enablement
      to avoid lockout. Set ssh_2fa_require_break_glass_ready=false to force.
  when:
    - ssh_2fa_break_glass_enabled | default(true)
    - ssh_2fa_require_break_glass_ready | default(false)
    - not (ssh_2fa_break_glass_ready | default(false))
  tags: [ssh, 2fa, break-glass]

- name: SSH 2FA | Configure | Ensure Include directive exists in sshd_config
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^Include /etc/ssh/sshd_config\.d/\*\.conf'
    line: 'Include /etc/ssh/sshd_config.d/*.conf'
    insertbefore: BOF
    state: present
    validate: /usr/sbin/sshd -t -f %s
    backup: true
  notify: restart sshd
  tags: [ssh, config]

- name: SSH 2FA | Configure | Deploy hardened SSH configuration drop-in
  ansible.builtin.template:
    src: sshd_hardening.conf.j2
    dest: /etc/ssh/sshd_config.d/99-hardening.conf
    owner: root
    group: root
    mode: '0600'
    validate: /usr/sbin/sshd -t -f %s
    backup: yes
  notify: restart sshd
  tags: [ssh, config]

- name: SSH 2FA | Configure | Deploy FIDO2 SSH configuration drop-in
  ansible.builtin.template:
    src: sshd_fido2.conf.j2
    dest: /etc/ssh/sshd_config.d/20-fido2.conf
    owner: root
    group: root
    mode: '0600'
    validate: /usr/sbin/sshd -t -f %s
    backup: yes
  when: ssh_2fa_fido2_only | default(false)
  notify: restart sshd
  tags: [ssh, fido2, config]

- name: SSH 2FA | Configure | Deploy 2FA SSH configuration drop-in
  ansible.builtin.template:
    src: sshd_2fa.conf.j2
    dest: /etc/ssh/sshd_config.d/50-2fa.conf
    owner: root
    group: root
    mode: '0600'
    validate: /usr/sbin/sshd -t -f %s
    backup: yes
  when: ssh_2fa_enable_ssh | default(true)
    and (not ssh_2fa_require_break_glass_ready | default(false) or ssh_2fa_break_glass_ready | default(false))
  notify: restart sshd
  tags: [ssh, 2fa, config]

# ========================================
# PAM Configuration - Modular Approach
# ========================================
# Deploy separate PAM config files that are @include'd by main PAM files
# This prevents package updates from overwriting our customizations

- name: SSH 2FA | Configure | Deploy modular PAM config for SSH 2FA
  ansible.builtin.template:
    src: pam-ssh-2fa.j2
    dest: /etc/pam.d/sshd-2fa
    owner: root
    group: root
    mode: '0644'
    backup: yes
  when:
    - ssh_2fa_enable_ssh | default(true)
    - not ssh_2fa_require_break_glass_ready | default(false) or ssh_2fa_break_glass_ready | default(false)
  tags: [pam, 2fa, config]

- name: SSH 2FA | Configure | Add substack directive to /etc/pam.d/sshd (using pamd module)
  community.general.pamd:
    name: sshd
    type: auth
    control: substack
    module_path: sshd-2fa
    state: after
    new_type: auth
    new_control: include
    new_module_path: common-auth
    backup: yes
  when:
    - ssh_2fa_enable_ssh | default(true)
    - not ssh_2fa_require_break_glass_ready | default(false) or ssh_2fa_break_glass_ready | default(false)
  tags: [pam, 2fa]

- name: SSH 2FA | Configure | Deploy modular PAM config for sudo 2FA
  ansible.builtin.template:
    src: pam-sudo-2fa.j2
    dest: /etc/pam.d/sudo-2fa
    owner: root
    group: root
    mode: '0644'
    backup: yes
  when:
    - ssh_2fa_enable_sudo | default(true)
    - not ssh_2fa_require_break_glass_ready | default(false) or ssh_2fa_break_glass_ready | default(false)
  tags: [pam, 2fa, sudo, config]

- name: SSH 2FA | Configure | Add substack directive to /etc/pam.d/sudo (using pamd module)
  community.general.pamd:
    name: sudo
    type: auth
    control: substack
    module_path: sudo-2fa
    state: before
    new_type: auth
    new_control: include
    new_module_path: system-auth
    backup: yes
  when:
    - ssh_2fa_enable_sudo | default(true)
    - not ssh_2fa_require_break_glass_ready | default(false) or ssh_2fa_break_glass_ready | default(false)
  tags: [pam, 2fa, sudo]

- name: SSH 2FA | Configure | Create SSH banner
  ansible.builtin.template:
    src: ssh_banner.j2
    dest: /etc/ssh/banner
    owner: root
    group: root
    mode: '0644'
  when: ssh_2fa_banner_enabled | default(false)
  tags: [ssh, banner]
