---
# OpenBao Role - Main Tasks

- name: Check if deployment is enabled
  debug:
    msg: "OpenBao deployment: {{ deploy_openbao | default(true) }}"
  tags: [openbao]

- name: Skip OpenBao deployment if not enabled
  meta: end_play
  when: deploy_openbao is defined and not deploy_openbao
  tags: [openbao]

- name: Include OS-specific variables
  include_vars: "{{ ansible_os_family }}.yml"
  tags: [openbao]

- name: Install dependencies
  apt:
    name:
      - unzip
      - jq
      - curl
      - openssl
    state: present
    update_cache: yes
  tags: [openbao, packages]

- name: Create OpenBao system group
  group:
    name: "{{ openbao_group }}"
    system: yes
    state: present
  tags: [openbao, users]

- name: Create OpenBao system user
  user:
    name: "{{ openbao_user }}"
    group: "{{ openbao_group }}"
    system: yes
    shell: /bin/false
    home: "{{ openbao_data_dir }}"
    createhome: no
    state: present
  tags: [openbao, users]

- name: Create OpenBao directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ openbao_user }}"
    group: "{{ openbao_group }}"
    mode: '0750'
  loop:
    - "{{ openbao_config_dir }}"
    - "{{ openbao_data_dir }}"
    - "{{ openbao_tls_dir }}"
    - "{{ openbao_log_dir }}"
    - "{{ openbao_backup_dir }}"
  tags: [openbao, directories]

- name: Check if OpenBao binary exists
  stat:
    path: "{{ openbao_install_dir }}/bao"
  register: openbao_binary
  tags: [openbao, install]

- name: Download OpenBao binary
  get_url:
    url: "https://github.com/openbao/openbao/releases/download/v{{ openbao_version }}/bao_{{ openbao_version }}_linux_amd64.zip"
    dest: "/tmp/openbao_{{ openbao_version }}.zip"
    mode: '0644'
  when: not openbao_binary.stat.exists
  tags: [openbao, install]

- name: Extract OpenBao binary
  unarchive:
    src: "/tmp/openbao_{{ openbao_version }}.zip"
    dest: "{{ openbao_install_dir }}"
    remote_src: yes
    creates: "{{ openbao_install_dir }}/bao"
  when: not openbao_binary.stat.exists
  tags: [openbao, install]

- name: Set OpenBao binary permissions
  file:
    path: "{{ openbao_install_dir }}/bao"
    owner: root
    group: root
    mode: '0755'
  tags: [openbao, install]

- name: Set OpenBao binary capabilities
  capabilities:
    path: "{{ openbao_install_dir }}/bao"
    capability: cap_ipc_lock=+ep
    state: present
  when: not openbao_disable_mlock
  tags: [openbao, install]

- name: Generate self-signed TLS certificate
  command: >
    openssl req -x509 -newkey rsa:4096
    -keyout {{ openbao_tls_key_file }}
    -out {{ openbao_tls_cert_file }}
    -days 365 -nodes
    -subj "{{ openbao_tls_self_signed_subject }}"
  args:
    creates: "{{ openbao_tls_cert_file }}"
  when: openbao_tls_enabled and openbao_tls_self_signed
  tags: [openbao, tls]

- name: Set TLS certificate permissions
  file:
    path: "{{ item }}"
    owner: "{{ openbao_user }}"
    group: "{{ openbao_group }}"
    mode: '0600'
  loop:
    - "{{ openbao_tls_cert_file }}"
    - "{{ openbao_tls_key_file }}"
  when: openbao_tls_enabled
  tags: [openbao, tls]

- name: Deploy OpenBao configuration
  template:
    src: config.hcl.j2
    dest: "{{ openbao_config_dir }}/config.hcl"
    owner: "{{ openbao_user }}"
    group: "{{ openbao_group }}"
    mode: '0640'
  notify: restart openbao
  tags: [openbao, config]

- name: Deploy OpenBao systemd service
  template:
    src: openbao.service.j2
    dest: /etc/systemd/system/openbao.service
    owner: root
    group: root
    mode: '0644'
  notify: restart openbao
  tags: [openbao, systemd]

- name: Enable and start OpenBao service
  systemd:
    name: openbao
    enabled: yes
    state: started
    daemon_reload: yes
  tags: [openbao, service]

- name: Configure UFW firewall for OpenBao
  ufw:
    rule: allow
    port: "8200"
    proto: tcp
    from_ip: "{{ item }}"
    comment: "OpenBao API"
  loop: "{{ openbao_firewall_allowed_ips }}"
  when: openbao_firewall_enabled
  tags: [openbao, firewall]

- name: Wait for OpenBao to start
  wait_for:
    port: 8200
    delay: 5
    timeout: 60
  tags: [openbao, service]

- name: Deploy backup script
  template:
    src: backup-openbao.sh.j2
    dest: /usr/local/bin/backup-openbao.sh
    owner: root
    group: root
    mode: '0750'
  when: openbao_backup_enabled
  tags: [openbao, backup]

- name: Configure backup cron job
  cron:
    name: "OpenBao backup"
    minute: "0"
    hour: "2"
    job: "/usr/local/bin/backup-openbao.sh >> /var/log/openbao/backup.log 2>&1"
    user: root
    state: present
  when: openbao_backup_enabled
  tags: [openbao, backup]

- name: Display post-installation instructions
  debug:
    msg: |
      ========================================
      OpenBao Installation Complete
      ========================================

      OpenBao is running at: {{ openbao_api_addr }}

      NEXT STEPS (Run manually):

      1. Export environment variables:
         export VAULT_ADDR='{{ openbao_api_addr }}'
         {% if openbao_tls_self_signed %}export VAULT_SKIP_VERIFY=1{% endif %}

      2. Initialize OpenBao:
         bao operator init -key-shares={{ openbao_key_shares }} -key-threshold={{ openbao_key_threshold }}

      3. CRITICAL: Save the unseal keys and root token securely!
         Store in password manager or encrypted offline backup.

      4. Unseal OpenBao (requires {{ openbao_key_threshold }} keys):
         bao operator unseal <key1>
         bao operator unseal <key2>
         bao operator unseal <key3>

      5. Login with root token:
         bao login <root-token>

      6. Enable secrets engines:
         bao secrets enable -path=secret kv-v2
         bao secrets enable database

      7. Enable audit logging:
         bao audit enable file file_path={{ openbao_audit_path }}

      8. Create policies and tokens for applications

      ========================================
  tags: [openbao, info]
