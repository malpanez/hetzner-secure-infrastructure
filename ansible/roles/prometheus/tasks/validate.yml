---
# Prometheus Role - Validation Tasks

- name: Prometheus | Validate | Wait for Prometheus to be ready
  ansible.builtin.uri:
    url: http://localhost:{{ prometheus_port }}/-/ready
    status_code: 200
  register: result
  until: result.status == 200
  retries: 12
  delay: 5
  tags: [prometheus, validate]

- name: Prometheus | Validate | Verify Prometheus is collecting metrics
  ansible.builtin.uri:
    url: http://localhost:{{ prometheus_port }}/api/v1/query?query=up
    method: GET
    return_content: true
  register: prometheus_metrics
  tags: [prometheus, validate]

- name: Prometheus | Validate | Get Prometheus version
  ansible.builtin.command:
    cmd: prometheus --version
  register: prometheus_version_output
  changed_when: false
  tags: [prometheus, validate]

- name: Prometheus | Validate | Display Prometheus status
  ansible.builtin.debug:
    msg: |
      Prometheus deployed successfully!
      - Version: {{ prometheus_version_output.stdout_lines[0] | default('unknown') }}
      - Web UI: http://{{ ansible_host }}:{{ prometheus_port }}
      - Config: {{ prometheus_config_dir }}/prometheus.yml
      - Data: {{ prometheus_data_dir }}
      - Targets: {{ prometheus_node_targets | default([]) | length }} node exporters
      - Installation method: APT (DEB822 format)
      - Repository: Prometheus Community (Robust Perception)
  tags: [prometheus, info]
