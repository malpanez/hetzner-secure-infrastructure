---
# Prometheus Role - Main Tasks

- name: Check if deployment is enabled
  debug:
    msg: "Prometheus deployment: {{ deploy_prometheus | default(true) }}"
  tags: [prometheus]

- name: Skip Prometheus deployment if not enabled
  meta: end_play
  when: deploy_prometheus is defined and not deploy_prometheus
  tags: [prometheus]

# ========================================
# User and Group Creation
# ========================================

- name: Create Prometheus system group
  group:
    name: "{{ prometheus_group }}"
    system: yes
    state: present
  tags: [prometheus, users]

- name: Create Prometheus system user
  user:
    name: "{{ prometheus_user }}"
    group: "{{ prometheus_group }}"
    system: yes
    shell: /bin/false
    home: "{{ prometheus_data_dir }}"
    createhome: no
    state: present
  tags: [prometheus, users]

# ========================================
# Directory Creation
# ========================================

- name: Create Prometheus directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ prometheus_user }}"
    group: "{{ prometheus_group }}"
    mode: '0755'
  loop:
    - "{{ prometheus_install_dir }}"
    - "{{ prometheus_config_dir }}"
    - "{{ prometheus_data_dir }}"
    - "{{ prometheus_log_dir }}"
    - "{{ prometheus_rules_dir }}"
    - "{{ prometheus_backup_dir }}"
  tags: [prometheus, directories]

- name: Create TLS directory
  file:
    path: "{{ prometheus_config_dir }}/tls"
    state: directory
    owner: "{{ prometheus_user }}"
    group: "{{ prometheus_group }}"
    mode: '0700'
  when: prometheus_tls_enabled
  tags: [prometheus, tls]

- name: Create file service discovery directory
  file:
    path: "{{ prometheus_file_sd_path }}"
    state: directory
    owner: "{{ prometheus_user }}"
    group: "{{ prometheus_group }}"
    mode: '0755'
  when: prometheus_file_sd_enabled
  tags: [prometheus, service-discovery]

# ========================================
# Download and Install Prometheus
# ========================================

- name: Check if Prometheus binary exists
  stat:
    path: "{{ prometheus_install_dir }}/prometheus"
  register: prometheus_binary
  tags: [prometheus, install]

- name: Download Prometheus
  get_url:
    url: "https://github.com/prometheus/prometheus/releases/download/v{{ prometheus_version }}/prometheus-{{ prometheus_version }}.linux-amd64.tar.gz"
    dest: "/tmp/prometheus-{{ prometheus_version }}.tar.gz"
    mode: '0644'
  when: not prometheus_binary.stat.exists
  tags: [prometheus, install]

- name: Extract Prometheus
  unarchive:
    src: "/tmp/prometheus-{{ prometheus_version }}.tar.gz"
    dest: "/tmp"
    remote_src: yes
    creates: "/tmp/prometheus-{{ prometheus_version }}.linux-amd64"
  when: not prometheus_binary.stat.exists
  tags: [prometheus, install]

- name: Copy Prometheus binaries
  copy:
    src: "/tmp/prometheus-{{ prometheus_version }}.linux-amd64/{{ item }}"
    dest: "{{ prometheus_install_dir }}/{{ item }}"
    owner: "{{ prometheus_user }}"
    group: "{{ prometheus_group }}"
    mode: '0755'
    remote_src: yes
  loop:
    - prometheus
    - promtool
  when: not prometheus_binary.stat.exists
  tags: [prometheus, install]

- name: Copy console templates
  copy:
    src: "/tmp/prometheus-{{ prometheus_version }}.linux-amd64/{{ item }}/"
    dest: "{{ prometheus_config_dir }}/{{ item }}/"
    owner: "{{ prometheus_user }}"
    group: "{{ prometheus_group }}"
    mode: '0755'
    remote_src: yes
  loop:
    - consoles
    - console_libraries
  when: not prometheus_binary.stat.exists
  tags: [prometheus, install]

- name: Clean up downloaded archive
  file:
    path: "/tmp/prometheus-{{ prometheus_version }}.tar.gz"
    state: absent
  tags: [prometheus, cleanup]

- name: Clean up extracted directory
  file:
    path: "/tmp/prometheus-{{ prometheus_version }}.linux-amd64"
    state: absent
  tags: [prometheus, cleanup]

# ========================================
# Generate Scrape Targets from Inventory
# ========================================

- name: Generate node exporter targets from inventory
  set_fact:
    prometheus_node_targets: "{{ prometheus_node_targets | default([]) + [hostvars[item]['ansible_host'] + ':' + (prometheus_node_exporter_port | string)] }}"
  loop: "{{ groups['monitored_servers'] | default([]) }}"
  when:
    - prometheus_scrape_node_exporter
    - hostvars[item]['ansible_host'] is defined
    - hostvars[item]['node_exporter_enabled'] | default(true)
  tags: [prometheus, config]

# ========================================
# Configuration
# ========================================

- name: Deploy Prometheus configuration
  template:
    src: prometheus.yml.j2
    dest: "{{ prometheus_config_dir }}/prometheus.yml"
    owner: "{{ prometheus_user }}"
    group: "{{ prometheus_group }}"
    mode: '0644'
    validate: "{{ prometheus_install_dir }}/promtool check config %s"
  notify: reload prometheus
  tags: [prometheus, config]

- name: Deploy alert rules
  template:
    src: "rules/{{ item.name }}.yml.j2"
    dest: "{{ prometheus_rules_dir }}/{{ item.name }}.yml"
    owner: "{{ prometheus_user }}"
    group: "{{ prometheus_group }}"
    mode: '0644'
  loop: "{{ prometheus_default_rules }}"
  when:
    - prometheus_rules_enabled
    - item.enabled | default(true)
  notify: reload prometheus
  tags: [prometheus, rules]

- name: Deploy web configuration (if auth or TLS enabled)
  template:
    src: web.yml.j2
    dest: "{{ prometheus_config_dir }}/web.yml"
    owner: "{{ prometheus_user }}"
    group: "{{ prometheus_group }}"
    mode: '0644'
  when: prometheus_web_basic_auth_enabled or prometheus_tls_enabled
  notify: restart prometheus
  tags: [prometheus, config, security]

# ========================================
# Systemd Service
# ========================================

- name: Deploy Prometheus systemd service
  template:
    src: prometheus.service.j2
    dest: /etc/systemd/system/prometheus.service
    owner: root
    group: root
    mode: '0644'
  notify: restart prometheus
  tags: [prometheus, service]

- name: Enable and start Prometheus service
  systemd:
    name: prometheus
    enabled: yes
    state: started
    daemon_reload: yes
  tags: [prometheus, service]

# ========================================
# Firewall Configuration
# ========================================

- name: Allow Prometheus port in firewall
  ufw:
    rule: allow
    port: "{{ prometheus_port }}"
    proto: tcp
    src: "{{ item }}"
    comment: "Prometheus Web UI"
  loop: "{{ prometheus_firewall_allowed_ips }}"
  when: firewall_enabled | default(true)
  tags: [prometheus, firewall]

# ========================================
# Backup Configuration
# ========================================

- name: Deploy Prometheus backup script
  template:
    src: backup-prometheus.sh.j2
    dest: /usr/local/bin/backup-prometheus
    owner: root
    group: root
    mode: '0755'
  when: prometheus_backup_enabled
  tags: [prometheus, backup]

- name: Create Prometheus backup cron job
  cron:
    name: "Prometheus data backup"
    minute: "{{ prometheus_backup_schedule.split()[0] }}"
    hour: "{{ prometheus_backup_schedule.split()[1] }}"
    day: "{{ prometheus_backup_schedule.split()[2] }}"
    month: "{{ prometheus_backup_schedule.split()[3] }}"
    weekday: "{{ prometheus_backup_schedule.split()[4] }}"
    user: root
    job: "/usr/local/bin/backup-prometheus > /dev/null 2>&1"
    state: present
  when: prometheus_backup_enabled
  tags: [prometheus, backup]

# ========================================
# Validation
# ========================================

- name: Wait for Prometheus to be ready
  uri:
    url: "http://localhost:{{ prometheus_port }}/-/ready"
    status_code: 200
  register: result
  until: result.status == 200
  retries: 12
  delay: 5
  tags: [prometheus, validate]

- name: Verify Prometheus is collecting metrics
  uri:
    url: "http://localhost:{{ prometheus_port }}/api/v1/query?query=up"
    method: GET
    return_content: yes
  register: prometheus_metrics
  tags: [prometheus, validate]

- name: Display Prometheus status
  debug:
    msg: |
      Prometheus deployed successfully!
      - Version: {{ prometheus_version }}
      - Web UI: http://{{ ansible_host }}:{{ prometheus_port }}
      - Config: {{ prometheus_config_dir }}/prometheus.yml
      - Data: {{ prometheus_data_dir }}
      - Targets: {{ prometheus_node_targets | default([]) | length }} node exporters
  tags: [prometheus, info]
