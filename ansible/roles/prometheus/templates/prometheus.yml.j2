# Prometheus Configuration
# Generated by Ansible - Do not edit manually

global:
  scrape_interval: {{ prometheus_global_scrape_interval }}
  scrape_timeout: {{ prometheus_global_scrape_timeout }}
  evaluation_interval: {{ prometheus_global_evaluation_interval }}

  external_labels:
    cluster: 'hetzner-production'
    environment: '{{ ansible_environment | default("production") }}'

{% if prometheus_alertmanager_enabled %}
# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - '{{ prometheus_alertmanager_url }}'
{% endif %}

{% if prometheus_rules_enabled %}
# Load rules
rule_files:
{% for rule in prometheus_default_rules %}
{% if rule.enabled | default(true) %}
  - '{{ prometheus_rules_dir }}/{{ rule.name }}.yml'
{% endif %}
{% endfor %}
{% endif %}

# Scrape configurations
scrape_configs:

  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:{{ prometheus_port }}']
        labels:
          instance: '{{ inventory_hostname }}'
          role: 'monitoring'

{% if prometheus_scrape_node_exporter and prometheus_node_targets is defined and prometheus_node_targets | length > 0 %}
  # Node Exporter - System metrics from all monitored servers
  - job_name: 'node-exporter'
    static_configs:
      - targets:
{% for target in prometheus_node_targets %}
          - '{{ target }}'
{% endfor %}
        labels:
          environment: 'production'
{% endif %}

{% if prometheus_static_jobs | length > 0 %}
  # Custom static job configurations
{% for job in prometheus_static_jobs %}
  - job_name: '{{ job.job_name }}'
{% if job.static_configs is defined %}
    static_configs:
{% for config in job.static_configs %}
      - targets:
{% for target in config.targets %}
          - '{{ target }}'
{% endfor %}
{% if config.labels is defined %}
        labels:
{% for key, value in config.labels.items() %}
          {{ key }}: '{{ value }}'
{% endfor %}
{% endif %}
{% endfor %}
{% endif %}
{% if job.scrape_interval is defined %}
    scrape_interval: {{ job.scrape_interval }}
{% endif %}
{% if job.scrape_timeout is defined %}
    scrape_timeout: {{ job.scrape_timeout }}
{% endif %}
{% if job.metrics_path is defined %}
    metrics_path: {{ job.metrics_path }}
{% endif %}
{% endfor %}
{% endif %}

{% if prometheus_file_sd_enabled %}
  # File-based service discovery
  - job_name: 'file-sd'
    file_sd_configs:
      - files:
          - '{{ prometheus_file_sd_path }}/*.json'
          - '{{ prometheus_file_sd_path }}/*.yml'
        refresh_interval: 30s
{% endif %}

{% if prometheus_remote_write | length > 0 %}
# Remote write configuration
remote_write:
{% for remote in prometheus_remote_write %}
  - url: {{ remote.url }}
{% if remote.basic_auth is defined %}
    basic_auth:
      username: {{ remote.basic_auth.username }}
      password: {{ remote.basic_auth.password }}
{% endif %}
{% if remote.write_relabel_configs is defined %}
    write_relabel_configs:
{{ remote.write_relabel_configs | to_nice_yaml(indent=2) | indent(6, first=True) }}
{% endif %}
{% endfor %}
{% endif %}

{% if prometheus_remote_read | length > 0 %}
# Remote read configuration
remote_read:
{% for remote in prometheus_remote_read %}
  - url: {{ remote.url }}
{% if remote.basic_auth is defined %}
    basic_auth:
      username: {{ remote.basic_auth.username }}
      password: {{ remote.basic_auth.password }}
{% endif %}
{% endfor %}
{% endif %}
