#!/bin/bash
# Prometheus Backup Script
# Generated by Ansible - Do not edit manually

set -euo pipefail

# Configuration
BACKUP_DIR="{{ prometheus_backup_dir }}"
DATE=$(date +%Y%m%d-%H%M%S)
PROMETHEUS_DATA="{{ prometheus_data_dir }}"
PROMETHEUS_CONFIG="{{ prometheus_config_dir }}"
RETENTION_DAYS={{ prometheus_backup_retention_days }}
PROMETHEUS_USER="{{ prometheus_user }}"

# Logging
log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $*" | tee -a "${BACKUP_DIR}/backup.log"
}

# Create snapshot using Prometheus API
create_snapshot() {
    log "Creating Prometheus snapshot..."
    SNAPSHOT_NAME=$(curl -s -XPOST http://localhost:{{ prometheus_port }}/api/v1/admin/tsdb/snapshot | jq -r '.data.name')

    if [ -z "$SNAPSHOT_NAME" ] || [ "$SNAPSHOT_NAME" = "null" ]; then
        log "ERROR: Failed to create snapshot"
        return 1
    fi

    log "Snapshot created: $SNAPSHOT_NAME"
    echo "$SNAPSHOT_NAME"
}

# Backup snapshot
backup_snapshot() {
    local snapshot_name=$1
    local snapshot_path="${PROMETHEUS_DATA}/snapshots/${snapshot_name}"
    local backup_file="${BACKUP_DIR}/prometheus-data-${DATE}.tar.gz"

    log "Backing up snapshot to ${backup_file}..."
    tar -czf "${backup_file}" -C "$(dirname ${snapshot_path})" "$(basename ${snapshot_path})"

    # Set proper permissions
    chown root:root "${backup_file}"
    chmod 600 "${backup_file}"

    log "Snapshot backup complete: ${backup_file}"
}

# Backup configuration
backup_config() {
    local config_backup="${BACKUP_DIR}/prometheus-config-${DATE}.tar.gz"

    log "Backing up configuration to ${config_backup}..."
    tar -czf "${config_backup}" "${PROMETHEUS_CONFIG}"

    # Set proper permissions
    chown root:root "${config_backup}"
    chmod 600 "${config_backup}"

    log "Configuration backup complete: ${config_backup}"
}

# Cleanup old backups
cleanup_old_backups() {
    log "Cleaning up backups older than ${RETENTION_DAYS} days..."
    find "${BACKUP_DIR}" -name "prometheus-*.tar.gz" -type f -mtime "+${RETENTION_DAYS}" -delete
    log "Cleanup complete"
}

# Cleanup snapshot
cleanup_snapshot() {
    local snapshot_name=$1
    local snapshot_path="${PROMETHEUS_DATA}/snapshots/${snapshot_name}"

    log "Removing snapshot ${snapshot_name}..."
    rm -rf "${snapshot_path}"
    log "Snapshot removed"
}

# Main execution
main() {
    log "===== Prometheus Backup Started ====="

    # Ensure backup directory exists
    mkdir -p "${BACKUP_DIR}"

    # Create and backup snapshot
    snapshot_name=$(create_snapshot)
    if [ $? -eq 0 ]; then
        backup_snapshot "$snapshot_name"
        cleanup_snapshot "$snapshot_name"
    else
        log "ERROR: Snapshot backup failed"
        exit 1
    fi

    # Backup configuration
    backup_config

    # Cleanup old backups
    cleanup_old_backups

    # Calculate backup sizes
    total_size=$(du -sh "${BACKUP_DIR}" | cut -f1)
    log "Total backup size: ${total_size}"

    log "===== Prometheus Backup Completed ====="
}

# Execute main function
main "$@"
