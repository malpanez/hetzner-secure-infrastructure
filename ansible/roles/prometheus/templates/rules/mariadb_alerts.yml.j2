groups:
  - name: mariadb_alerts
    interval: 30s
    rules:
      - alert: MariaDBDown
        expr: mysql_up == 0
        for: 1m
        labels:
          severity: critical
          service: mariadb
        annotations:
          summary: "MariaDB is down on {{ $labels.instance }}"
          description: "MariaDB exporter cannot connect to MariaDB on {{ $labels.instance }} for more than 1 minute."

      - alert: MariaDBHighConnections
        expr: (mysql_global_status_threads_connected / mysql_global_variables_max_connections) > 0.8
        for: 5m
        labels:
          severity: warning
          service: mariadb
        annotations:
          summary: "MariaDB high connection usage on {{ $labels.instance }}"
          description: "MariaDB is using {{ $value | humanizePercentage }} of max_connections on {{ $labels.instance }}."

      - alert: MariaDBHighQueryRate
        expr: rate(mysql_global_status_queries[5m]) > 1000
        for: 10m
        labels:
          severity: info
          service: mariadb
        annotations:
          summary: "MariaDB high query rate on {{ $labels.instance }}"
          description: "MariaDB is handling {{ $value }} queries per second on {{ $labels.instance }}."

      - alert: MariaDBSlowQueries
        expr: rate(mysql_global_status_slow_queries[5m]) > 1
        for: 5m
        labels:
          severity: warning
          service: mariadb
        annotations:
          summary: "MariaDB slow queries detected on {{ $labels.instance }}"
          description: "MariaDB has {{ $value }} slow queries per second on {{ $labels.instance }}. Check slow query log."

      - alert: MariaDBReplicationLag
        expr: mysql_slave_status_seconds_behind_master > 30
        for: 5m
        labels:
          severity: warning
          service: mariadb
        annotations:
          summary: "MariaDB replication lag on {{ $labels.instance }}"
          description: "MariaDB replication is {{ $value }} seconds behind master on {{ $labels.instance }}."

      - alert: MariaDBHighTableLockWait
        expr: rate(mysql_global_status_table_locks_waited[5m]) > 10
        for: 5m
        labels:
          severity: warning
          service: mariadb
        annotations:
          summary: "High table lock wait rate on {{ $labels.instance }}"
          description: "MariaDB has {{ $value }} table lock waits per second on {{ $labels.instance }}. Consider optimizing queries or table structure."

      - alert: MariaDBInnoDBBufferPoolEfficiency
        expr: (mysql_global_status_innodb_buffer_pool_read_requests / (mysql_global_status_innodb_buffer_pool_read_requests + mysql_global_status_innodb_buffer_pool_reads)) < 0.95
        for: 10m
        labels:
          severity: info
          service: mariadb
        annotations:
          summary: "Low InnoDB buffer pool efficiency on {{ $labels.instance }}"
          description: "InnoDB buffer pool read efficiency is {{ $value | humanizePercentage }} on {{ $labels.instance }}. Consider increasing innodb_buffer_pool_size."

      - alert: MariaDBTooManyConnections
        expr: rate(mysql_global_status_aborted_connects[5m]) > 1
        for: 5m
        labels:
          severity: warning
          service: mariadb
        annotations:
          summary: "High connection abort rate on {{ $labels.instance }}"
          description: "MariaDB has {{ $value }} aborted connections per second on {{ $labels.instance }}. Check for connection issues."
