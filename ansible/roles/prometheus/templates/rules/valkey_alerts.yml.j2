groups:
  - name: valkey_alerts
    interval: 30s
    rules:
      - alert: ValkeyDown
        expr: redis_up == 0
        for: 1m
        labels:
          severity: critical
          service: valkey
        annotations:
          summary: "Valkey is down on {{ $labels.instance }}"
          description: "Valkey exporter cannot connect to Valkey on {{ $labels.instance }} for more than 1 minute."

      - alert: ValkeyHighMemoryUsage
        expr: (redis_memory_used_bytes / redis_memory_max_bytes) > 0.9
        for: 5m
        labels:
          severity: warning
          service: valkey
        annotations:
          summary: "Valkey high memory usage on {{ $labels.instance }}"
          description: "Valkey is using {{ $value | humanizePercentage }} of max memory on {{ $labels.instance }}. Evictions will start soon."

      - alert: ValkeyHighEvictionRate
        expr: rate(redis_evicted_keys_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          service: valkey
        annotations:
          summary: "Valkey high eviction rate on {{ $labels.instance }}"
          description: "Valkey is evicting {{ $value }} keys per second on {{ $labels.instance }}. Consider increasing maxmemory."

      - alert: ValkeyLowCacheHitRate
        expr: (rate(redis_keyspace_hits_total[5m]) / (rate(redis_keyspace_hits_total[5m]) + rate(redis_keyspace_misses_total[5m]))) < 0.8
        for: 10m
        labels:
          severity: warning
          service: valkey
        annotations:
          summary: "Valkey low cache hit rate on {{ $labels.instance }}"
          description: "Valkey cache hit rate is {{ $value | humanizePercentage }} on {{ $labels.instance }}. Investigate cache efficiency."

      - alert: ValkeyHighConnections
        expr: redis_connected_clients > 100
        for: 5m
        labels:
          severity: info
          service: valkey
        annotations:
          summary: "Valkey high connections on {{ $labels.instance }}"
          description: "Valkey has {{ $value }} connected clients on {{ $labels.instance }}."

      - alert: ValkeyRejectedConnections
        expr: rate(redis_rejected_connections_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
          service: valkey
        annotations:
          summary: "Valkey rejecting connections on {{ $labels.instance }}"
          description: "Valkey is rejecting {{ $value }} connections per second on {{ $labels.instance }}. Check maxclients setting."

      - alert: ValkeyReplicationBroken
        expr: redis_connected_slaves < 1
        for: 5m
        labels:
          severity: critical
          service: valkey
        annotations:
          summary: "Valkey replication broken on {{ $labels.instance }}"
          description: "Valkey master has no connected replicas on {{ $labels.instance }}."

      - alert: ValkeyRDBSaveFailed
        expr: redis_rdb_last_save_timestamp_seconds < (time() - 86400)
        for: 5m
        labels:
          severity: warning
          service: valkey
        annotations:
          summary: "Valkey RDB save not performed recently on {{ $labels.instance }}"
          description: "Last RDB save was {{ $value | humanizeDuration }} ago on {{ $labels.instance }}. Check backup process."

      - alert: ValkeyHighFragmentation
        expr: redis_mem_fragmentation_ratio > 1.5
        for: 10m
        labels:
          severity: warning
          service: valkey
        annotations:
          summary: "Valkey high memory fragmentation on {{ $labels.instance }}"
          description: "Valkey memory fragmentation ratio is {{ $value }} on {{ $labels.instance }}. Consider restart during low traffic."
