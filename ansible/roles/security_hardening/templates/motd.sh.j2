#!/bin/bash
# ============================================================================
# Dynamic MOTD - Post-Login Information Banner
# ============================================================================
# Managed by Ansible - security_hardening role
# Displays system information after successful authentication

# Colors for better readability
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Get system information
HOSTNAME=$(hostname -f 2>/dev/null || hostname)
KERNEL=$(uname -r)
UPTIME=$(uptime -p | sed 's/up //')
LOAD=$(cat /proc/loadavg | awk '{print $1", "$2", "$3}')
MEMORY=$(free -h | awk '/^Mem:/ {printf "%s / %s (%.1f%%)", $3, $2, ($3/$2)*100}')
DISK=$(df -h / | awk 'NR==2 {printf "%s / %s (%s)", $3, $2, $5}')
IP_ADDR=$(hostname -I | awk '{print $1}')
USERS=$(who | wc -l)
PROCESSES=$(ps aux | wc -l)

# Security status
FAIL2BAN_STATUS=$(systemctl is-active fail2ban 2>/dev/null || echo "inactive")
FIREWALL_STATUS=$([ -f /etc/ufw/ufw.conf ] && grep -q "ENABLED=yes" /etc/ufw/ufw.conf 2>/dev/null && echo "active" || echo "inactive")
UPDATES=$(apt list --upgradable 2>/dev/null | grep -c upgradable 2>/dev/null || echo "0")

# Print MOTD
echo ""
echo -e "${CYAN}################################################################################${NC}"
echo -e "${CYAN}#${NC}                                                                              ${CYAN}#${NC}"
echo -e "${CYAN}#${NC}                  ${GREEN}Welcome to Two Minds Trading Infrastructure${NC}                ${CYAN}#${NC}"
echo -e "${CYAN}#${NC}                                                                              ${CYAN}#${NC}"
echo -e "${CYAN}################################################################################${NC}"
echo ""
echo -e "${BLUE}System Information:${NC}"
echo -e "  Hostname:      ${GREEN}${HOSTNAME}${NC}"
echo -e "  IP Address:    ${GREEN}${IP_ADDR}${NC}"
echo -e "  Kernel:        ${KERNEL}"
echo -e "  Uptime:        ${UPTIME}"
echo -e "  Load Average:  ${LOAD}"
echo ""
echo -e "${BLUE}Resource Usage:${NC}"
echo -e "  Memory:        ${MEMORY}"
echo -e "  Disk (/):      ${DISK}"
echo -e "  Active Users:  ${USERS}"
echo -e "  Processes:     ${PROCESSES}"
echo ""
echo -e "${BLUE}Security Status:${NC}"
if [ "$FAIL2BAN_STATUS" = "active" ]; then
    echo -e "  Fail2ban:      ${GREEN}✓ Active${NC}"
else
    echo -e "  Fail2ban:      ${RED}✗ Inactive${NC}"
fi
if [ "$FIREWALL_STATUS" = "active" ]; then
    echo -e "  Firewall:      ${GREEN}✓ Active (UFW)${NC}"
else
    echo -e "  Firewall:      ${RED}✗ Inactive${NC}"
fi
echo ""
if [ -n "$UPDATES" ] && [ "$UPDATES" -gt "0" ] 2>/dev/null; then
    echo -e "${YELLOW}⚠ System Updates: ${UPDATES} package(s) available for update${NC}"
    echo -e "  Run: ${CYAN}sudo apt update && sudo apt upgrade${NC}"
    echo ""
fi
echo -e "${CYAN}################################################################################${NC}"
echo ""
