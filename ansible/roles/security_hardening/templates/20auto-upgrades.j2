# Automatic Updates Configuration
# Managed by Ansible - DO NOT EDIT MANUALLY
# Optimized for Debian 13 with WordPress

# ==================================================================
# UPDATE SCHEDULE
# ==================================================================

# Update package lists daily
APT::Periodic::Update-Package-Lists "1";

# Download upgradeable packages daily
APT::Periodic::Download-Upgradeable-Packages "1";

# Autoclean interval (remove old .deb files) - weekly
APT::Periodic::AutocleanInterval "7";

# Run unattended-upgrade daily
APT::Periodic::Unattended-Upgrade "1";

# Verbose output (0=no, 1=yes)
APT::Periodic::Verbose "1";

# ==================================================================
# ADVANCED SETTINGS
# ==================================================================

# Maximum age of cache in days before forced update
APT::Periodic::MaxAge "7";

# Minimum age of cache before update
APT::Periodic::MinAge "2";

# Maximum random sleep in seconds (to spread load on mirrors)
APT::Periodic::RandomSleep "1800";

# Enable unattended upgrades for security updates only
# (or all updates if you want)
Unattended-Upgrade::Automatic-Reboot "{{ unattended_upgrades_automatic_reboot | default('false') | lower }}";

# If automatic reboot is enabled, set the time
{% if unattended_upgrades_automatic_reboot | default(false) %}
Unattended-Upgrade::Automatic-Reboot-Time "{{ unattended_upgrades_automatic_reboot_time | default('03:00') }}";
{% endif %}

# Automatic reboot even if users are logged in
Unattended-Upgrade::Automatic-Reboot-WithUsers "{{ unattended_upgrades_reboot_with_users | default('false') | lower }}";

# ==================================================================
# EMAIL NOTIFICATIONS (optional)
# ==================================================================

{% if unattended_upgrades_email is defined and unattended_upgrades_email != '' %}
# Send email on upgrades and errors
Unattended-Upgrade::Mail "{{ unattended_upgrades_email }}";

# Only send mail on errors (comment out to send always)
Unattended-Upgrade::MailReport "only-on-error";
{% else %}
# Email notifications disabled - no email configured
# Unattended-Upgrade::Mail "root";
{% endif %}

# ==================================================================
# UPDATE BEHAVIOR
# ==================================================================

# Remove unused kernel packages automatically
Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";

# Remove unused dependencies automatically
Unattended-Upgrade::Remove-Unused-Dependencies "true";

# Remove new unused dependencies after upgrade
Unattended-Upgrade::Remove-New-Unused-Dependencies "true";

# Automatically fix interrupted dpkg
Unattended-Upgrade::AutoFixInterruptedDpkg "true";

# Minimal steps to reduce potential errors
Unattended-Upgrade::MinimalSteps "true";

# Install on shutdown if not during normal operation
Unattended-Upgrade::InstallOnShutdown "false";

# Do not suspend system on battery (for laptops)
Unattended-Upgrade::OnlyOnACPower "false";

# ==================================================================
# PACKAGE SOURCES
# ==================================================================

# Allow updates from these origins
Unattended-Upgrade::Allowed-Origins {
    "${distro_id}:${distro_codename}";
    "${distro_id}:${distro_codename}-security";
    "${distro_id}ESMApps:${distro_codename}-apps-security";
    "${distro_id}ESM:${distro_codename}-infra-security";
    "${distro_id}:${distro_codename}-updates";
};

# Optionally update from these origins (less stable)
# Unattended-Upgrade::Origins-Pattern {
#     "origin=Debian,codename=${distro_codename},label=Debian";
#     "origin=Debian,codename=${distro_codename}-updates";
# };

# ==================================================================
# PACKAGE BLACKLIST
# ==================================================================

# Packages that should NOT be automatically upgraded
Unattended-Upgrade::Package-Blacklist {
    // Database (require manual testing)
    // "mysql-server.*";
    // "mariadb-server.*";
    // "postgresql.*";
    
    // Web servers (test before upgrading)
    // "nginx.*";
    // "apache2.*";
    
    // PHP (test compatibility with WordPress first)
    // "php.*";
    
    // Kernel (test before upgrading)
    // "linux-image.*";
    // "linux-headers.*";
    
    // WordPress CLI (if installed)
    // "wp-cli";
};

# Regular expressions to blacklist packages
# Unattended-Upgrade::Package-Blacklist {
#     "^mysql-.*";
#     "^nginx-.*";
#     "^php[0-9]+\.[0-9]+-.*";
# };

# ==================================================================
# ADDITIONAL SETTINGS
# ==================================================================

# Skip updates that require restarting services
# (set to false to allow service restarts)
Unattended-Upgrade::Skip-Updates-On-Metered-Connections "true";

# Verbose logging
Unattended-Upgrade::Verbose "{{ unattended_upgrades_verbose | default('false') | lower }}";

# Debug mode (very verbose, only for troubleshooting)
// Unattended-Upgrade::Debug "false";

# Log to syslog
Unattended-Upgrade::SyslogEnable "true";
Unattended-Upgrade::SyslogFacility "daemon";

# Keep debs after installation (for rollback if needed)
Unattended-Upgrade::Keep-Debs-After-Install "false";