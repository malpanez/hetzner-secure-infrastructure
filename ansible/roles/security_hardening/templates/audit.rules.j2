## Auditd Rules - Comprehensive Security Logging
## Managed by Ansible - DO NOT EDIT MANUALLY
## Optimized for Debian 13 (Trixie) with WordPress
## Compliance: SOC-2, NIST 800-53, FedRAMP, HIPAA, PCI-DSS

# Remove any existing rules
-D

# Buffer Size (increase for WordPress high I/O)
-b 16384

# Failure Mode (0=silent 1=printk 2=panic)
-f 1

# Rate limit (prevent log flooding from WordPress)
-r 500

## ===== AUDITD SELF-MONITORING =====
-w /var/log/audit/ -p wa -k auditlog
-w /etc/audit/ -p wa -k auditconfig
-w /etc/libaudit.conf -p wa -k auditconfig
-w /etc/audisp/ -p wa -k audispconfig
-w /sbin/auditctl -p x -k audittools
-w /sbin/auditd -p x -k audittools

## ===== TIME CHANGES (PCI-DSS 10.4.2.b) =====
-a always,exit -F arch=b64 -S adjtimex -S settimeofday -k time-change
-a always,exit -F arch=b32 -S adjtimex -S settimeofday -S stime -k time-change
-a always,exit -F arch=b64 -S clock_settime -k time-change
-a always,exit -F arch=b32 -S clock_settime -k time-change
-w /etc/localtime -p wa -k time-change

## ===== USER/GROUP CHANGES (PCI-DSS 10.2.5) =====
-w /etc/group -p wa -k identity
-w /etc/passwd -p wa -k identity
-w /etc/gshadow -p wa -k identity
-w /etc/shadow -p wa -k identity
-w /etc/security/opasswd -p wa -k identity

## ===== NETWORK ENVIRONMENT (PCI-DSS 10.6.1) =====
-a always,exit -F arch=b64 -S sethostname -S setdomainname -k system-locale
-a always,exit -F arch=b32 -S sethostname -S setdomainname -k system-locale
-w /etc/issue -p wa -k system-locale
-w /etc/issue.net -p wa -k system-locale
-w /etc/hosts -p wa -k system-locale
-w /etc/network/ -p wa -k system-locale

## ===== MAC POLICY CHANGES (AppArmor) =====
-w /etc/apparmor/ -p wa -k MAC-policy
-w /etc/apparmor.d/ -p wa -k MAC-policy

## ===== LOGIN/LOGOUT EVENTS (PCI-DSS 10.2.1-10.2.3) =====
-w /var/log/faillog -p wa -k logins
-w /var/log/lastlog -p wa -k logins
-w /var/log/tallylog -p wa -k logins

## ===== SESSION INITIATION (PCI-DSS 10.2.7) =====
-w /var/run/utmp -p wa -k session
-w /var/log/wtmp -p wa -k logins
-w /var/log/btmp -p wa -k logins

## ===== DAC PERMISSION CHANGES (PCI-DSS 10.2.5.b) =====
-a always,exit -F arch=b64 -S chmod -S fchmod -S fchmodat -F auid>=1000 -F auid!=4294967295 -k perm_mod
-a always,exit -F arch=b32 -S chmod -S fchmod -S fchmodat -F auid>=1000 -F auid!=4294967295 -k perm_mod
-a always,exit -F arch=b64 -S chown -S fchown -S fchownat -S lchown -F auid>=1000 -F auid!=4294967295 -k perm_mod
-a always,exit -F arch=b32 -S chown -S fchown -S fchownat -S lchown -F auid>=1000 -F auid!=4294967295 -k perm_mod
-a always,exit -F arch=b64 -S setxattr -S lsetxattr -S fsetxattr -S removexattr -S lremovexattr -S fremovexattr -F auid>=1000 -F auid!=4294967295 -k perm_mod
-a always,exit -F arch=b32 -S setxattr -S lsetxattr -S fsetxattr -S removexattr -S lremovexattr -S fremovexattr -F auid>=1000 -F auid!=4294967295 -k perm_mod

## ===== UNAUTHORIZED ACCESS ATTEMPTS (PCI-DSS 10.2.4) =====
-a always,exit -F arch=b64 -S open -S openat -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access
-a always,exit -F arch=b32 -S open -S openat -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access
-a always,exit -F arch=b64 -S open -S openat -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access
-a always,exit -F arch=b32 -S open -S openat -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access
-a always,exit -F arch=b64 -S truncate -S ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access
-a always,exit -F arch=b32 -S truncate -S ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access
-a always,exit -F arch=b64 -S truncate -S ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access
-a always,exit -F arch=b32 -S truncate -S ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access

## ===== PRIVILEGED COMMAND EXECUTION (PCI-DSS 10.2.2) =====
-a always,exit -F arch=b64 -S execve -C uid!=euid -F euid=0 -k setuid
-a always,exit -F arch=b32 -S execve -C uid!=euid -F euid=0 -k setuid
-a always,exit -F arch=b64 -S execve -C gid!=egid -F egid=0 -k setgid
-a always,exit -F arch=b32 -S execve -C gid!=egid -F egid=0 -k setgid

## ===== FILE DELETION EVENTS (PCI-DSS 10.2.7) =====
-a always,exit -F arch=b64 -S unlink -S unlinkat -S rename -S renameat -F auid>=1000 -F auid!=4294967295 -k delete
-a always,exit -F arch=b32 -S unlink -S unlinkat -S rename -S renameat -F auid>=1000 -F auid!=4294967295 -k delete

## ===== SUDOERS CHANGES (PCI-DSS 10.2.2) =====
-w /etc/sudoers -p wa -k scope
-w /etc/sudoers.d/ -p wa -k scope

## ===== KERNEL MODULE CHANGES (PCI-DSS 10.6.2) =====
-w /sbin/insmod -p x -k modules
-w /sbin/rmmod -p x -k modules
-w /sbin/modprobe -p x -k modules
-a always,exit -F arch=b64 -S init_module -S delete_module -k modules

## ===== CRITICAL SYSTEM FILES =====
# PAM configuration
-w /etc/pam.d/ -p wa -k pam
-w /etc/security/limits.conf -p wa -k pam
-w /etc/security/pwquality.conf -p wa -k pam
-w /etc/security/namespace.conf -p wa -k pam
-w /etc/security/namespace.init -p wa -k pam

# SSH configuration
-w /etc/ssh/sshd_config -p wa -k sshd
-w /etc/ssh/sshd_config.d/ -p wa -k sshd

# Cron jobs
-w /etc/cron.allow -p wa -k cron
-w /etc/cron.deny -p wa -k cron
-w /etc/cron.d/ -p wa -k cron
-w /etc/cron.daily/ -p wa -k cron
-w /etc/cron.hourly/ -p wa -k cron
-w /etc/cron.monthly/ -p wa -k cron
-w /etc/cron.weekly/ -p wa -k cron
-w /etc/crontab -p wa -k cron
-w /var/spool/cron/ -p wa -k cron

# Systemd services
-w /etc/systemd/ -p wa -k systemd
-w /usr/lib/systemd/ -p wa -k systemd

# Firewall changes
-w /etc/ufw/ -p wa -k firewall
-w /etc/default/ufw -p wa -k firewall

## ===== SYSTEM ADMINISTRATION =====
-w /sbin/shutdown -p x -k power
-w /sbin/poweroff -p x -k power
-w /sbin/reboot -p x -k power
-w /sbin/halt -p x -k power

## ===== MOUNT OPERATIONS =====
-a always,exit -F arch=b64 -S mount -S umount2 -F auid>=1000 -F auid!=4294967295 -k mounts
-a always,exit -F arch=b32 -S mount -S umount -S umount2 -F auid>=1000 -F auid!=4294967295 -k mounts

## ===== WORDPRESS/WEB APPLICATION SECURITY =====
# Nginx configuration (Debian path)
-w /etc/nginx/nginx.conf -p wa -k webconfig
-w /etc/nginx/sites-enabled/ -p wa -k webconfig
-w /etc/nginx/sites-available/ -p wa -k webconfig
-w /etc/nginx/conf.d/ -p wa -k webconfig

# PHP configuration (all versions - use wildcard for flexibility)
# This covers PHP 8.2, 8.3, 8.4, and future versions
-w /etc/php/ -p wa -k phpconfig

# WordPress core files (only critical ones to avoid log spam)
{% set wp_root = nginx_wordpress_web_root | default('/var/www/wordpress') %}
-w {{ wp_root }}/wp-config.php -p wa -k wordpress
-w {{ wp_root }}/.htaccess -p wa -k wordpress
-w {{ wp_root }}/wp-admin/includes/ -p wa -k wordpress
-w {{ wp_root }}/wp-includes/capabilities.php -p wa -k wordpress
-w {{ wp_root }}/wp-includes/user.php -p wa -k wordpress

# WordPress uploads (file creation monitoring - be careful, can be noisy)
# Uncomment only if you need forensics, can generate massive logs
# -w {{ wp_root }}/wp-content/uploads/ -p wa -k wordpress-uploads

# WordPress plugins and themes (security-critical)
-w {{ wp_root }}/wp-content/plugins/ -p wa -k wordpress-plugins
-w {{ wp_root }}/wp-content/themes/ -p wa -k wordpress-themes
-w {{ wp_root }}/wp-content/mu-plugins/ -p wa -k wordpress-plugins

# Database configuration
-w /etc/mysql/ -p wa -k database
-w /etc/mysql/mariadb.conf.d/ -p wa -k database

# SSL/TLS certificates
-w /etc/letsencrypt/ -p wa -k certificates
-w /etc/ssl/private/ -p wa -k certificates

## ===== SECRETS AND CREDENTIALS =====
-w /root/.ssh/ -p wa -k rootkey
{% if security_hardening_admin_username is defined %}
-w /home/{{ security_hardening_admin_username }}/.ssh/ -p wa -k adminkey
{% endif %}

# WordPress secrets
-w /root/.my.cnf -p wa -k dbcredentials

## ===== MAKE CONFIGURATION IMMUTABLE =====
# This must be the last rule
# Use -e 1 for first deployment/testing (mutable, allows changes)
# Use -e 2 for stable production (immutable, requires reboot to modify)
-e {{ audit_immutable_mode | default('1') }}