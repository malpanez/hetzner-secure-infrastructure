---
# Security Hardening Role

- name: Install security packages
  ansible.builtin.apt:
    name: "{{ security_hardening_packages }}"
    state: present
  tags: packages

- name: Configure sysctl parameters
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    sysctl_set: true
    state: present
    reload: true
  loop: "{{ sysctl_config | dict2items }}"
  when: security_hardening_kernel_enabled | default(true)
  tags: sysctl

- name: Deploy sysctl configuration file
  ansible.builtin.template:
    src: 99-hardening.conf.j2
    dest: /etc/sysctl.d/99-hardening.conf
    owner: root
    group: root
    mode: "0644"
  notify: reload sysctl
  tags: sysctl

- name: Configure unattended-upgrades
  ansible.builtin.template:
    src: 50unattended-upgrades.j2
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    owner: root
    group: root
    mode: "0644"
  when: security_hardening_unattended_upgrades_enabled | default(true)
  tags: auto-updates

- name: Enable unattended-upgrades
  ansible.builtin.template:
    src: 20auto-upgrades.j2
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    owner: root
    group: root
    mode: "0644"
  when: security_hardening_unattended_upgrades_enabled | default(true)
  tags: auto-updates

- name: Secure shared memory
  ansible.builtin.lineinfile:
    path: /etc/fstab
    line: tmpfs /run/shm tmpfs defaults,noexec,nosuid 0 0
    state: present
  tags: filesystem

- name: Disable core dumps
  block:
    - name: Disable core dumps via limits
      community.general.pam_limits:
        domain: "*"
        limit_type: hard
        limit_item: core
        value: "0"

    - name: Disable core dumps via sysctl
      ansible.posix.sysctl:
        name: fs.suid_dumpable
        value: "0"
        state: present
        reload: true
  tags: security

- name: Configure password quality requirements
  ansible.builtin.apt:
    name: libpam-pwquality
    state: present
  tags: [security, password]
- name: Set password quality policy
  ansible.builtin.template:
    src: pwquality.conf.j2
    dest: /etc/security/pwquality.conf
    owner: root
    group: root
    mode: "0644"
  tags: [security, password]
- name: Disable USB storage (optional)
  ansible.builtin.copy:
    content: |
      # Disable USB storage
      blacklist usb-storage
    dest: /etc/modprobe.d/disable-usb-storage.conf
    owner: root
    group: root
    mode: "0644"
  when: security_hardening_disable_usb_storage | default(false)
  tags: [security, usb]
- name: Configure login.defs
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
  loop:
    - { regexp: ^PASS_MAX_DAYS, line: PASS_MAX_DAYS   90 }
    - { regexp: ^PASS_MIN_DAYS, line: PASS_MIN_DAYS   1 }
    - { regexp: ^PASS_WARN_AGE, line: PASS_WARN_AGE   7 }
    - { regexp: ^UMASK, line: UMASK           027 }
  tags: [security, password]
- name: Restrict cron to authorized users
  block:
    - name: Create cron.allow
      ansible.builtin.file:
        path: /etc/cron.allow
        state: touch
        owner: root
        group: root
        mode: "0640"

    - name: Add admin user to cron.allow
      ansible.builtin.lineinfile:
        path: /etc/cron.allow
        line: "{{ security_hardening_admin_username }}"
        state: present

    - name: Remove cron.deny if exists
      ansible.builtin.file:
        path: /etc/cron.deny
        state: absent
  tags: [security, cron]
- name: Set permissions on sensitive files
  ansible.builtin.file:
    path: "{{ item }}"
    mode: "0600"
    owner: root
    group: root
  loop:
    - /etc/crontab
    - /etc/ssh/sshd_config
  failed_when: false
  tags: permissions

- name: Configure auditd
  ansible.builtin.template:
    src: auditd.conf.j2
    dest: /etc/audit/auditd.conf
    owner: root
    group: root
    mode: "0640"
  when: security_hardening_auditd_enabled | default(true)
  notify: restart auditd
  tags: [security, auditd]

- name: Deploy audit rules
  ansible.builtin.template:
    src: audit.rules.j2
    dest: /etc/audit/rules.d/hardening.rules
    owner: root
    group: root
    mode: "0640"
  when: security_hardening_auditd_enabled | default(true)
  notify: restart auditd
  tags: [security, auditd]

- name: Enable and start auditd service
  ansible.builtin.systemd:
    name: auditd
    enabled: true
    state: started
  when: security_hardening_auditd_enabled | default(true)
  tags: [security, auditd]

- name: Initialize AIDE database (this may take a while)
  ansible.builtin.shell: aideinit && mv /var/lib/aide/aide.db.new /var/lib/aide/aide.db
  args:
    creates: /var/lib/aide/aide.db
  when: security_hardening_aide_enabled | default(false)
  tags: [security, aide]
