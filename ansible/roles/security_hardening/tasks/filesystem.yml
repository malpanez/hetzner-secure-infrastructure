---
- name: Security Hardening | Filesystem | Deploy /run/shm systemd mount unit
  ansible.builtin.template:
    src: run-shm.mount.j2
    dest: /etc/systemd/system/run-shm.mount
    owner: root
    group: root
    mode: '0644'
  tags: [security, filesystem]

- name: Security Hardening | Filesystem | Enable and start run-shm.mount
  ansible.builtin.systemd:
    name: run-shm.mount
    enabled: true
    state: started
    daemon_reload: true
  failed_when: false
  tags: [security, filesystem, molecule-notest]

- name: Security Hardening | Filesystem | Harden /tmp directory
  block:
    - name: Security Hardening | Filesystem | Check if /tmp is separate mount
      ansible.builtin.command: mountpoint -q /tmp
      register: tmp_mountpoint
      failed_when: false
      changed_when: false

    - name: Security Hardening | Filesystem | Deploy /tmp systemd mount unit
      ansible.builtin.template:
        src: tmp.mount.j2
        dest: /etc/systemd/system/tmp.mount
        owner: root
        group: root
        mode: '0644'
      when: tmp_mountpoint.rc != 0

    - name: Security Hardening | Filesystem | Enable tmp.mount
      ansible.builtin.systemd:
        name: tmp.mount
        enabled: true
        daemon_reload: true
      when: tmp_mountpoint.rc != 0
      failed_when: false
  when: security_hardening_harden_tmp
  tags: [security, filesystem, tmp, molecule-notest]
