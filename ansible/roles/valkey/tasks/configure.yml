---
# Valkey Role - Configuration Tasks

- name: Valkey | Configure | Create Valkey directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ valkey_user }}"
    group: "{{ valkey_group }}"
    mode: '0750'
  loop:
    - "{{ valkey_config_dir }}"
    - "{{ valkey_data_dir }}"
    - "{{ valkey_log_dir }}"
    - "{{ valkey_run_dir }}"
  tags: [valkey, config, directories]

- name: Valkey | Configure | Deploy Valkey configuration
  ansible.builtin.template:
    src: valkey.conf.j2
    dest: "{{ valkey_config_file }}"
    owner: "{{ valkey_user }}"
    group: "{{ valkey_group }}"
    mode: '0640'
  notify: restart valkey
  register: valkey_config_deployed
  tags: [valkey, config]

- name: Valkey | Configure | Check system configuration
  ansible.builtin.command:
    cmd: valkey-server --check-system
  changed_when: false
  failed_when: false
  register: valkey_system_check
  when: valkey_config_deployed is changed
  tags: [valkey, config, validate]

- name: Valkey | Configure | Display system check result
  ansible.builtin.debug:
    msg:
      - "Valkey system configuration check:"
      - "{{ valkey_system_check.stdout_lines }}"
  when:
    - valkey_config_deployed is changed
    - valkey_system_check is defined
  tags: [valkey, config, validate]

- name: Valkey | Configure | Configure system parameters
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    sysctl_file: "{{ valkey_sysctl_config_file }}"
    reload: true
  loop:
    - {name: 'vm.overcommit_memory', value: '1'}
    - {name: 'net.core.somaxconn', value: '{{ valkey_tcp_backlog }}'}
  when: valkey_overcommit_memory
  tags: [valkey, config, sysctl]

- name: Valkey | Configure | Disable transparent huge pages
  block:
    - name: Valkey | Configure | Create THP disable service
      ansible.builtin.copy:
        content: |
          [Unit]
          Description=Disable Transparent Huge Pages for Valkey
          DefaultDependencies=no
          After=sysinit.target local-fs.target
          Before=valkey-server.service

          [Service]
          Type=oneshot
          ExecStart=/bin/sh -c 'echo never > /sys/kernel/mm/transparent_hugepage/enabled'

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/disable-thp.service
        owner: root
        group: root
        mode: '0644'

    - name: Valkey | Configure | Enable THP disable service
      ansible.builtin.systemd:
        name: disable-thp
        enabled: true
        daemon_reload: true
        state: started
  when: valkey_disable_thp
  tags: [valkey, config, thp]
