---
# Loki Role - Validation Tasks

- name: Loki | Validate | Wait for Loki to be ready
  ansible.builtin.uri:
    url: "http://localhost:{{ loki_http_listen_port }}/ready"
    status_code: 200
  register: result
  until: result.status == 200
  retries: 12
  delay: 5
  tags: [loki, validate]

- name: Loki | Validate | Get Loki version
  ansible.builtin.uri:
    url: "http://localhost:{{ loki_http_listen_port }}/loki/api/v1/status/buildinfo"
    method: GET
    return_content: true
  register: loki_buildinfo
  tags: [loki, validate]

- name: Loki | Validate | Display Loki status
  ansible.builtin.debug:
    msg: |
      Loki deployed successfully!
      - HTTP API: http://{{ ansible_host }}:{{ loki_http_listen_port }}
      - Config: {{ loki_config_dir }}/loki.yml
      - Data: {{ loki_data_dir }}
      - Logs: {{ loki_log_dir }}
      - Retention: {{ loki_retention_period }}
      - Version: {{ loki_buildinfo.json.version | default('unknown') }}
  tags: [loki, info]
