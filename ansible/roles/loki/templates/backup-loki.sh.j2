#!/bin/bash
# Loki Backup Script
# Generated by Ansible - DO NOT EDIT MANUALLY

set -euo pipefail

BACKUP_DIR="{{ loki_backup_dir }}"
DATA_DIR="{{ loki_data_dir }}"
RETENTION_DAYS="{{ loki_backup_retention_days }}"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
BACKUP_FILE="loki-backup-${TIMESTAMP}.tar.gz"

echo "[$(date)] Starting Loki backup..."

# Create backup directory if it doesn't exist
mkdir -p "${BACKUP_DIR}"

# Create backup (exclude cache directories to save space)
tar czf "${BACKUP_DIR}/${BACKUP_FILE}" \
    --exclude='{{ loki_data_dir }}/tsdb-cache' \
    --exclude='{{ loki_data_dir }}/*.tmp' \
    -C "$(dirname ${DATA_DIR})" \
    "$(basename ${DATA_DIR})" \
    2>/dev/null || {
    echo "[$(date)] ERROR: Failed to create backup"
    exit 1
}

# Verify backup was created
if [[ -f "${BACKUP_DIR}/${BACKUP_FILE}" ]]; then
    BACKUP_SIZE=$(du -h "${BACKUP_DIR}/${BACKUP_FILE}" | cut -f1)
    echo "[$(date)] Backup created: ${BACKUP_FILE} (${BACKUP_SIZE})"
else
    echo "[$(date)] ERROR: Backup file not found"
    exit 1
fi

# Remove old backups (older than RETENTION_DAYS)
echo "[$(date)] Removing backups older than ${RETENTION_DAYS} days..."
find "${BACKUP_DIR}" -name "loki-backup-*.tar.gz" -type f -mtime +${RETENTION_DAYS} -delete

# Show remaining backups
BACKUP_COUNT=$(find "${BACKUP_DIR}" -name "loki-backup-*.tar.gz" -type f | wc -l)
TOTAL_SIZE=$(du -sh "${BACKUP_DIR}" | cut -f1)
echo "[$(date)] Backup completed. Total backups: ${BACKUP_COUNT} (${TOTAL_SIZE})"

exit 0
