---
# Firewall Role - Main Tasks (Orchestrator)

- name: Firewall | Main | Load OS-specific variables
  ansible.builtin.include_vars: "{{ ansible_os_family }}.yml"
  tags: [firewall, always]

- name: Firewall | Main | Check if deployment is enabled
  ansible.builtin.debug:
    msg: "Firewall deployment: {{ firewall_enabled }}"
  tags: [firewall]

- name: Firewall | Main | Skip deployment if not enabled
  ansible.builtin.meta: end_play
  when: not firewall_enabled
  tags: [firewall]

- name: Firewall | Main | Require explicit SSH management IPs
  ansible.builtin.assert:
    that:
      - ssh_allowed_ips is defined
      - ssh_allowed_ips | length > 0
      - "'0.0.0.0/0' not in ssh_allowed_ips"
      - "'::/0' not in ssh_allowed_ips"
    fail_msg: "ssh_allowed_ips must be explicitly defined and must not include 0.0.0.0/0 or ::/0."
  tags: [firewall]

- name: Firewall | Main | Include installation tasks
  ansible.builtin.include_tasks: install.yml
  tags: [firewall, install]

- name: Firewall | Main | Include configuration tasks
  ansible.builtin.include_tasks: configure.yml
  tags: [firewall, config]

- name: Firewall | Main | Include firewall rules tasks
  ansible.builtin.include_tasks: rules.yml
  tags: [firewall, rules]

- name: Firewall | Main | Include validation tasks
  ansible.builtin.include_tasks: validate.yml
  tags: [firewall, validate]
