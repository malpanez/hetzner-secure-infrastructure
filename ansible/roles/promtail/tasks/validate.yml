---
# Promtail Role - Validation Tasks

- name: Promtail | Validate | Wait for Promtail to be ready
  ansible.builtin.uri:
    url: "http://localhost:{{ promtail_http_listen_port }}/ready"
    status_code: 200
  register: result
  until: result.status == 200
  retries: 12
  delay: 5
  tags: [promtail, validate]

- name: Promtail | Validate | Get Promtail metrics
  ansible.builtin.uri:
    url: "http://localhost:{{ promtail_http_listen_port }}/metrics"
    method: GET
    return_content: true
  register: promtail_metrics
  tags: [promtail, validate]

- name: Promtail | Validate | Display status
  ansible.builtin.debug:
    msg: |
      Promtail deployed successfully!
      - HTTP API: http://{{ ansible_host }}:{{ promtail_http_listen_port }}
      - Config: {{ promtail_config_dir }}/promtail.yml
      - Positions: {{ promtail_positions_dir }}
      - Loki URL: {{ promtail_loki_url }}
      - Installation method: APT (DEB822 format)
  tags: [promtail, info]
