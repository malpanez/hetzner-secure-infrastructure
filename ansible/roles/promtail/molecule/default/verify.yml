---
# Molecule verify playbook for Promtail role

- name: Verify
  hosts: all
  become: true
  gather_facts: true

  tasks:
    # ========================================
    # Package Installation Tests
    # ========================================

    - name: Check that Promtail is installed
      ansible.builtin.package:
        name: promtail
        state: present
      check_mode: true
      register: promtail_package
      failed_when: promtail_package is changed

    # ========================================
    # Service Tests
    # ========================================

    - name: Check that Promtail service is running
      ansible.builtin.systemd:
        name: promtail
      register: promtail_service
      failed_when: promtail_service.status.ActiveState != "active"

    - name: Check that Promtail service is enabled
      ansible.builtin.systemd:
        name: promtail
      register: promtail_enabled
      failed_when: promtail_enabled.status.UnitFileState != "enabled"

    # ========================================
    # HTTP API Tests
    # ========================================

    - name: Check Promtail health endpoint
      ansible.builtin.uri:
        url: http://localhost:9080/ready
        status_code: 200
      register: promtail_health
      retries: 5
      delay: 3
      until: promtail_health.status == 200

    - name: Check Promtail metrics endpoint
      ansible.builtin.uri:
        url: http://localhost:9080/metrics
        status_code: 200
        return_content: true
      register: promtail_metrics

    - name: Verify metrics contain expected data
      ansible.builtin.assert:
        that:
          - "'promtail_build_info' in promtail_metrics.content"
        fail_msg: "Promtail metrics missing expected data"

    # ========================================
    # Configuration Tests
    # ========================================

    - name: Check that Promtail config exists
      ansible.builtin.stat:
        path: /etc/promtail/promtail.yml
      register: promtail_config
      failed_when: not promtail_config.stat.exists

    - name: Verify config file permissions
      ansible.builtin.stat:
        path: /etc/promtail/promtail.yml
      register: config_perms
      failed_when: config_perms.stat.mode != "0640"

    - name: Validate Promtail configuration syntax
      ansible.builtin.command:
        cmd: /usr/bin/promtail -config.file=/etc/promtail/promtail.yml -dry-run
      changed_when: false
      register: config_validation

    # ========================================
    # Directory Tests
    # ========================================

    - name: Check that data directories exist
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - /etc/promtail
        - /var/lib/promtail
        - /var/log/promtail
      register: promtail_dirs
      failed_when: not item.stat.exists
      loop_control:
        loop_var: item
        label: "{{ item.item }}"

    - name: Check that positions file exists
      ansible.builtin.stat:
        path: /var/lib/promtail/positions.yaml
      register: positions_file

    - name: Verify directory ownership
      ansible.builtin.stat:
        path: /var/lib/promtail
      register: data_dir_owner
      failed_when: data_dir_owner.stat.pw_name != "promtail"

    # ========================================
    # User/Group Tests
    # ========================================

    - name: Check that Promtail user exists
      ansible.builtin.getent:
        database: passwd
        key: promtail
      register: promtail_user

    - name: Check that Promtail group exists
      ansible.builtin.getent:
        database: group
        key: promtail
      register: promtail_group

    - name: Check that Promtail user is in adm group
      ansible.builtin.command:
        cmd: groups promtail
      register: promtail_groups
      changed_when: false
      failed_when: "'adm' not in promtail_groups.stdout"

    # ========================================
    # Logrotate Tests
    # ========================================

    - name: Check that logrotate config exists
      ansible.builtin.stat:
        path: /etc/logrotate.d/promtail
      register: logrotate_config
      failed_when: not logrotate_config.stat.exists

    - name: Test logrotate configuration
      ansible.builtin.command:
        cmd: logrotate -d /etc/logrotate.d/promtail
      changed_when: false
      register: logrotate_test

    # ========================================
    # File Permissions Tests
    # ========================================

    - name: Verify Promtail can read /var/log
      ansible.builtin.stat:
        path: /var/log/syslog
      register: syslog_perms

    - name: Check Promtail can read auth.log
      ansible.builtin.stat:
        path: /var/log/auth.log
      register: auth_perms

    # ========================================
    # Functional Tests
    # ========================================

    - name: Write test log entry
      ansible.builtin.lineinfile:
        path: /var/log/syslog
        line: "{{ ansible_date_time.iso8601 }} test-host promtail-test[12345]: Test log message from Molecule"
        create: true
        mode: '0644'

    - name: Wait for Promtail to process log (5 seconds)
      ansible.builtin.pause:
        seconds: 5

    - name: Check Promtail targets endpoint
      ansible.builtin.uri:
        url: http://localhost:9080/targets
        method: GET
        return_content: true
      register: targets_response

    - name: Verify targets are configured
      ansible.builtin.assert:
        that:
          - targets_response.status == 200
        fail_msg: "Promtail targets endpoint not responding"

    # ========================================
    # Summary
    # ========================================

    - name: Display test summary
      ansible.builtin.debug:
        msg: |
          âœ… Promtail role tests passed!
          - Package: installed
          - Service: active and enabled
          - API: responding on port 9080
          - Config: valid syntax
          - Directories: exist with correct permissions
          - User: in adm group (can read /var/log)
          - Logrotate: configured
          - Targets: configured and ready
