# Promtail Configuration
# Generated by Ansible - DO NOT EDIT MANUALLY

server:
  http_listen_port: {{ promtail_http_listen_port }}
  grpc_listen_port: {{ promtail_grpc_listen_port }}
  log_level: info

# Where to store positions (offset in log files)
positions:
  filename: {{ promtail_positions_dir }}/positions.yaml

# Loki connection
clients:
  - url: {{ promtail_loki_url }}
    batchwait: {{ promtail_loki_batch_wait }}
    batchsize: {{ promtail_loki_batch_size }}
    timeout: 10s
    backoff_config:
      min_period: 500ms
      max_period: 5m
      max_retries: 10

# Log scraping configuration
scrape_configs:

{% if promtail_scrape_nginx %}
  # ========================================
  # Nginx Access Logs
  # ========================================
  - job_name: nginx-access
    static_configs:
      - targets:
          - localhost
        labels:
          job: nginx
          type: access
          __path__: {{ promtail_nginx_access_log }}
    pipeline_stages:
      # Parse nginx access log format
      - regex:
          expression: '^(?P<remote_addr>[\w\.]+) - (?P<remote_user>[^ ]*) \[(?P<time_local>.*)\] "(?P<method>[^ ]*) (?P<request>[^ ]*) (?P<protocol>[^ ]*)" (?P<status>[\d]+) (?P<body_bytes_sent>[\d]+) "(?P<http_referer>[^"]*)" "(?P<http_user_agent>[^"]*)"'
      - labels:
          method:
          status:
      - timestamp:
          source: time_local
          format: 02/Jan/2006:15:04:05 -0700

  # ========================================
  # Nginx Error Logs
  # ========================================
  - job_name: nginx-error
    static_configs:
      - targets:
          - localhost
        labels:
          job: nginx
          type: error
          __path__: {{ promtail_nginx_error_log }}
    pipeline_stages:
      # Parse nginx error log format
      - regex:
          expression: '^(?P<timestamp>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[(?P<level>\w+)\] (?P<message>.*)'
      - labels:
          level:
      - timestamp:
          source: timestamp
          format: 2006/01/02 15:04:05
{% endif %}

{% if promtail_scrape_php %}
  # ========================================
  # PHP-FPM Logs
  # ========================================
  - job_name: php-fpm
    static_configs:
      - targets:
          - localhost
        labels:
          job: php
          type: fpm
          __path__: {{ promtail_php_fpm_log }}
    pipeline_stages:
      - regex:
          expression: '^\[(?P<timestamp>.*)\] (?P<level>\w+): (?P<message>.*)'
      - labels:
          level:
      - timestamp:
          source: timestamp
          format: 02-Jan-2006 15:04:05
{% endif %}

{% if promtail_scrape_mariadb %}
  # ========================================
  # MariaDB Error Logs
  # ========================================
  - job_name: mariadb-error
    static_configs:
      - targets:
          - localhost
        labels:
          job: mariadb
          type: error
          __path__: {{ promtail_mariadb_error_log }}
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}) (?P<thread_id>\d+) \[(?P<level>\w+)\] (?P<message>.*)'
      - labels:
          level:
      - timestamp:
          source: timestamp
          format: 2006-01-02 15:04:05

  # ========================================
  # MariaDB Slow Query Logs
  # ========================================
  - job_name: mariadb-slow
    static_configs:
      - targets:
          - localhost
        labels:
          job: mariadb
          type: slow_query
          __path__: {{ promtail_mariadb_slow_log }}
{% endif %}

{% if promtail_scrape_wordpress %}
  # ========================================
  # WordPress Debug Logs
  # ========================================
  - job_name: wordpress
    static_configs:
      - targets:
          - localhost
        labels:
          job: wordpress
          type: debug
          __path__: {{ promtail_wordpress_debug_log }}
    pipeline_stages:
      - regex:
          expression: '^\[(?P<timestamp>.*)\] (?P<message>.*)'
      - timestamp:
          source: timestamp
          format: 02-Jan-2006 15:04:05 UTC
{% endif %}

{% if promtail_scrape_syslog %}
  # ========================================
  # System Logs (syslog)
  # ========================================
  - job_name: syslog
    static_configs:
      - targets:
          - localhost
        labels:
          job: system
          type: syslog
          __path__: {{ promtail_syslog }}
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\w+\s+\d+\s+\d{2}:\d{2}:\d{2}) (?P<hostname>\S+) (?P<process>\S+?)(\[(?P<pid>\d+)\])?: (?P<message>.*)'
      - labels:
          hostname:
          process:
      - timestamp:
          source: timestamp
          format: Jan 02 15:04:05
          action_on_failure: skip
{% endif %}

{% if promtail_scrape_auth %}
  # ========================================
  # Authentication Logs
  # ========================================
  - job_name: auth
    static_configs:
      - targets:
          - localhost
        labels:
          job: auth
          type: authentication
          __path__: {{ promtail_auth_log }}
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\w+\s+\d+\s+\d{2}:\d{2}:\d{2}) (?P<hostname>\S+) (?P<process>\S+?)(\[(?P<pid>\d+)\])?: (?P<message>.*)'
      - labels:
          process:
      # Detect SSH login attempts
      - match:
          selector: '{job="auth"}'
          stages:
            - regex:
                expression: '(?P<auth_result>Failed|Accepted) (?P<auth_method>\w+) for (?P<username>\w+)'
            - labels:
                auth_result:
                username:
{% endif %}

{% if promtail_scrape_fail2ban %}
  # ========================================
  # Fail2ban Logs
  # ========================================
  - job_name: fail2ban
    static_configs:
      - targets:
          - localhost
        labels:
          job: fail2ban
          type: security
          __path__: {{ promtail_fail2ban_log }}
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3}) (?P<level>\w+)\s+(?P<message>.*)'
      - labels:
          level:
      - timestamp:
          source: timestamp
          format: 2006-01-02 15:04:05
          action_on_failure: skip
{% endif %}

# Limits
limits_config:
  readline_rate_enabled: true
  readline_rate: 10000
  readline_burst: 20000
