---
# Grafana Role - Configuration Tasks

- name: Grafana | Configure | Deploy Grafana configuration
  ansible.builtin.template:
    src: grafana.ini.j2
    dest: "{{ grafana_config_dir }}/grafana.ini"
    owner: "{{ grafana_user }}"
    group: "{{ grafana_group }}"
    mode: "0640"
  notify: restart grafana
  tags: [grafana, config]

- name: Grafana | Configure | Provision Grafana datasources
  ansible.builtin.template:
    src: datasources.yml.j2
    dest: "{{ grafana_config_dir }}/provisioning/datasources/ansible.yml"
    owner: "{{ grafana_user }}"
    group: "{{ grafana_group }}"
    mode: "0640"
  notify: restart grafana
  tags: [grafana, datasources]

- name: Grafana | Configure | Provision dashboard configuration
  ansible.builtin.template:
    src: dashboards.yml.j2
    dest: "{{ grafana_config_dir }}/provisioning/dashboards/ansible.yml"
    owner: "{{ grafana_user }}"
    group: "{{ grafana_group }}"
    mode: "0640"
  when: grafana_dashboards_enabled
  notify: restart grafana
  tags: [grafana, dashboards]

- name: Grafana | Configure | Download default dashboards
  ansible.builtin.get_url:
    url: https://grafana.com/api/dashboards/{{ item.dashboard_id }}/revisions/{{ item.dashboard_revision }}/download
    dest: "{{ grafana_dashboards_dir }}/{{ item.name }}.json"
    owner: "{{ grafana_user }}"
    group: "{{ grafana_group }}"
    mode: "0644"
  loop: "{{ grafana_default_dashboards }}"
  when:
    - grafana_dashboards_enabled
    - item.enabled | default(true)
  tags: [grafana, dashboards]

- name: Grafana | Configure | Deploy Grafana backup script
  ansible.builtin.template:
    src: backup-grafana.sh.j2
    dest: /usr/local/bin/backup-grafana
    owner: root
    group: root
    mode: "0755"
  when: grafana_backup_enabled
  tags: [grafana, backup]

- name: Grafana | Configure | Create Grafana backup cron job
  ansible.builtin.cron:
    name: Grafana backup
    minute: "{{ grafana_backup_schedule.split()[0] }}"
    hour: "{{ grafana_backup_schedule.split()[1] }}"
    day: "{{ grafana_backup_schedule.split()[2] }}"
    month: "{{ grafana_backup_schedule.split()[3] }}"
    weekday: "{{ grafana_backup_schedule.split()[4] }}"
    user: root
    job: /usr/local/bin/backup-grafana > /dev/null 2>&1
    state: present
  when: grafana_backup_enabled
  tags: [grafana, backup]
