#!/bin/bash
# Grafana Backup Script
# Generated by Ansible - Do not edit manually

set -euo pipefail

# Configuration
BACKUP_DIR="{{ grafana_backup_dir }}"
DATE=$(date +%Y%m%d-%H%M%S)
GRAFANA_DATA="{{ grafana_data_dir }}"
GRAFANA_CONFIG="{{ grafana_config_dir }}"
RETENTION_DAYS={{ grafana_backup_retention_days }}

# Logging
log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $*" | tee -a "${BACKUP_DIR}/backup.log"
}

# Stop Grafana temporarily for consistent backup
stop_grafana() {
    log "Stopping Grafana service..."
    systemctl stop grafana-server
}

# Start Grafana after backup
start_grafana() {
    log "Starting Grafana service..."
    systemctl start grafana-server
}

# Backup database and configuration
backup_grafana() {
    local data_backup="${BACKUP_DIR}/grafana-data-${DATE}.tar.gz"
    local config_backup="${BACKUP_DIR}/grafana-config-${DATE}.tar.gz"

    log "Backing up Grafana data to ${data_backup}..."
    tar -czf "${data_backup}" \
        -C "$(dirname ${GRAFANA_DATA})" \
        "$(basename ${GRAFANA_DATA})"

    log "Backing up Grafana configuration to ${config_backup}..."
    tar -czf "${config_backup}" "${GRAFANA_CONFIG}"

    # Set proper permissions
    chown root:root "${data_backup}" "${config_backup}"
    chmod 600 "${data_backup}" "${config_backup}"

    log "Backup complete"
    log "  - Data: ${data_backup}"
    log "  - Config: ${config_backup}"
}

# Cleanup old backups
cleanup_old_backups() {
    log "Cleaning up backups older than ${RETENTION_DAYS} days..."
    find "${BACKUP_DIR}" -name "grafana-*.tar.gz" -type f -mtime "+${RETENTION_DAYS}" -delete
    log "Cleanup complete"
}

# Main execution
main() {
    log "===== Grafana Backup Started ====="

    # Ensure backup directory exists
    mkdir -p "${BACKUP_DIR}"

    # Stop service for consistent backup
    stop_grafana

    # Perform backup
    backup_grafana

    # Start service
    start_grafana

    # Cleanup old backups
    cleanup_old_backups

    # Calculate backup sizes
    total_size=$(du -sh "${BACKUP_DIR}" | cut -f1)
    log "Total backup size: ${total_size}"

    log "===== Grafana Backup Completed ====="
}

# Execute main function
main "$@"
