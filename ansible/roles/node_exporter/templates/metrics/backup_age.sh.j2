#!/bin/bash
# Custom Node Exporter Metric: Backup Age
# Generated by Ansible - Do not edit manually

set -euo pipefail

# Backup directories to monitor
BACKUP_DIRS=(
    "/var/backups/grafana"
    "/var/backups/prometheus"
    "/var/backups/openbao"
)

# Output metric header
cat <<EOF
# HELP node_custom_backup_age_seconds Age of the most recent backup in seconds
# TYPE node_custom_backup_age_seconds gauge
# HELP node_custom_backup_exists Whether a backup exists (1) or not (0)
# TYPE node_custom_backup_exists gauge
EOF

for backup_dir in "${BACKUP_DIRS[@]}"; do
    # Extract service name from path
    service_name=$(basename "$backup_dir")

    # Check if directory exists
    if [ ! -d "$backup_dir" ]; then
        echo "node_custom_backup_exists{service=\"$service_name\"} 0"
        echo "node_custom_backup_age_seconds{service=\"$service_name\"} -1"
        continue
    fi

    # Find the most recent backup file
    latest_backup=$(find "$backup_dir" -name "*.tar.gz" -type f -printf '%T@ %p\n' 2>/dev/null | sort -n | tail -1 | cut -d' ' -f2-)

    if [ -z "$latest_backup" ]; then
        # No backup found
        echo "node_custom_backup_exists{service=\"$service_name\"} 0"
        echo "node_custom_backup_age_seconds{service=\"$service_name\"} -1"
    else
        # Backup exists - calculate age
        backup_timestamp=$(stat -c %Y "$latest_backup")
        current_timestamp=$(date +%s)
        age_seconds=$((current_timestamp - backup_timestamp))

        echo "node_custom_backup_exists{service=\"$service_name\"} 1"
        echo "node_custom_backup_age_seconds{service=\"$service_name\"} $age_seconds"
    fi
done
