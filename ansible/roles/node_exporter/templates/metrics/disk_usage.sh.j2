#!/bin/bash
# Custom Node Exporter Metric: Disk Usage Details
# Generated by Ansible - Do not edit manually

set -euo pipefail

# Output metric header
cat <<EOF
# HELP node_custom_disk_usage_percent Filesystem usage percentage
# TYPE node_custom_disk_usage_percent gauge
EOF

# Collect disk usage for all mounted filesystems
df -h | grep -vE '^Filesystem|tmpfs|cdrom|loop' | awk '{
    # Extract mount point and usage percentage
    mountpoint = $6
    usage = $5
    gsub(/%/, "", usage)

    # Output Prometheus metric
    printf "node_custom_disk_usage_percent{mountpoint=\"%s\"} %s\n", mountpoint, usage
}'

# Output inode usage
cat <<EOF

# HELP node_custom_inode_usage_percent Filesystem inode usage percentage
# TYPE node_custom_inode_usage_percent gauge
EOF

df -i | grep -vE '^Filesystem|tmpfs|cdrom|loop' | awk '{
    # Extract mount point and inode usage percentage
    mountpoint = $6
    usage = $5
    gsub(/%/, "", usage)

    # Handle '-' for filesystems without inodes
    if (usage == "-") {
        usage = 0
    }

    # Output Prometheus metric
    printf "node_custom_inode_usage_percent{mountpoint=\"%s\"} %s\n", mountpoint, usage
}'
