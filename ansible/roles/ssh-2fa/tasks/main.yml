---
# SSH 2FA Role - FIDO2 + TOTP authentication

- name: Install SSH and PAM packages
  ansible.builtin.apt:
    name:
      - openssh-server
      - libpam-google-authenticator
      - libqrencode4
      - qrencode
    state: present
  tags: packages

- name: Backup original SSH configuration
  ansible.builtin.copy:
    src: /etc/ssh/sshd_config
    dest: /etc/ssh/sshd_config.backup-{{ ansible_date_time.epoch }}
    remote_src: true
    force: false
  tags: backup

- name: Backup original PAM configuration
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "{{ item }}.backup-{{ ansible_date_time.epoch }}"
    remote_src: true
    force: false
  loop:
    - /etc/pam.d/sshd
    - /etc/pam.d/sudo
  tags: backup

- name: Deploy hardened SSH configuration
  ansible.builtin.template:
    src: sshd_config.j2
    dest: /etc/ssh/sshd_config
    owner: root
    group: root
    mode: "0600"
    validate: /usr/sbin/sshd -t -f %s
    backup: true
  notify: restart sshd
  tags: [ssh, config]
- name: Deploy PAM configuration for SSH with 2FA
  ansible.builtin.template:
    src: pam_sshd.j2
    dest: /etc/pam.d/sshd
    owner: root
    group: root
    mode: "0644"
    backup: true
  when: enable_2fa_ssh | default(true)
  tags: [pam, 2fa]
- name: Deploy PAM configuration for sudo with 2FA
  ansible.builtin.template:
    src: pam_sudo.j2
    dest: /etc/pam.d/sudo
    owner: root
    group: root
    mode: "0644"
    backup: true
  when: enable_2fa_sudo | default(true)
  tags: [pam, 2fa, sudo]
- name: Deploy 2FA setup script for Yubikey
  ansible.builtin.copy:
    src: setup-2fa-yubikey.sh
    dest: /usr/local/bin/setup-2fa-yubikey.sh
    owner: root
    group: root
    mode: "0755"
  tags: [scripts, 2fa]
- name: Create SSH banner
  ansible.builtin.template:
    src: ssh_banner.j2
    dest: /etc/ssh/banner
    owner: root
    group: root
    mode: "0644"
  when: ssh_banner_enabled | default(false)
  tags: [ssh, banner]
- name: Disable SSH password authentication immediately for root
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: ^PermitRootLogin
    line: PermitRootLogin {{ ssh_permit_root_login }}
    state: present
  notify: restart sshd
  tags: [ssh, security]
- name: Generate strong SSH host keys
  block:
    - name: Remove weak SSH host keys
      ansible.builtin.file:
        path: /etc/ssh/{{ item }}
        state: absent
      loop:
        - ssh_host_dsa_key
        - ssh_host_dsa_key.pub
        - ssh_host_ecdsa_key
        - ssh_host_ecdsa_key.pub

    - name: Generate Ed25519 host key
      ansible.builtin.command: ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key -N ""
      args:
        creates: /etc/ssh/ssh_host_ed25519_key

    - name: Generate RSA 4096 host key
      ansible.builtin.command: ssh-keygen -t rsa -b 4096 -f /etc/ssh/ssh_host_rsa_key -N ""
      args:
        creates: /etc/ssh/ssh_host_rsa_key
  tags: [ssh, keys]
- name: Set permissions on SSH host keys
  ansible.builtin.file:
    path: /etc/ssh/{{ item }}
    owner: root
    group: root
    mode: "0600"
  loop:
    - ssh_host_ed25519_key
    - ssh_host_rsa_key
  tags: [ssh, permissions]
- name: Test SSH configuration
  ansible.builtin.command: sshd -t
  changed_when: false
  tags: [ssh, test]
- name: Ensure SSH service is enabled and running
  ansible.builtin.systemd:
    name: sshd
    enabled: true
    state: started
  tags: [ssh, service]
