# Hardened SSH Configuration for Debian
# Managed by Ansible - DO NOT EDIT MANUALLY

# Network
Port {{ ssh_port }}
AddressFamily inet
Listen Address 0.0.0.0

# Protocol
Protocol 2

# Host Keys - Only strong algorithms
HostKey /etc/ssh/ssh_host_ed25519_key
HostKey /etc/ssh/ssh_host_rsa_key

# Ciphers and Keying - Modern only
Ciphers {{ ssh_ciphers | join(',') }}
MACs {{ ssh_macs | join(',') }}
KexAlgorithms {{ ssh_kex_algorithms | join(',') }}
HostKeyAlgorithms {{ ssh_host_key_algorithms | join(',') }}

# Authentication
PubkeyAuthentication {{ ssh_pubkey_authentication | ternary('yes', 'no') }}
AuthenticationMethods {{ ssh_authentication_methods }}
PasswordAuthentication {{ ssh_password_authentication | ternary('yes', 'no') }}
PermitEmptyPasswords no
ChallengeResponseAuthentication {{ ssh_challenge_response_authentication | ternary('yes', 'no') }}
UsePAM {{ ssh_use_pam | ternary('yes', 'no') }}

# Disable insecure authentication
HostbasedAuthentication no
IgnoreRhosts yes
PermitRootLogin {{ ssh_permit_root_login }}

# 2FA Configuration
KbdInteractiveAuthentication yes

# Security
PermitUserEnvironment no
AllowAgentForwarding no
AllowTcpForwarding no
X11Forwarding no
PrintMotd no
PrintLastLog yes
TCPKeepAlive yes
PermitTunnel no
Compression no

# Logging
SyslogFacility AUTH
LogLevel VERBOSE

# Session
ClientAliveInterval {{ ssh_client_alive_interval }}
ClientAliveCountMax {{ ssh_client_alive_count_max }}
MaxAuthTries {{ ssh_max_auth_tries }}
MaxSessions {{ ssh_max_sessions }}
MaxStartups 10:30:60
LoginGraceTime {{ ssh_login_grace_time }}

# User Restrictions
{% if ssh_allowed_users is defined and ssh_allowed_users | length > 0 %}
AllowUsers {{ ssh_allowed_users | join(' ') }}
{% endif %}
{% if ssh_allowed_groups is defined and ssh_allowed_groups | length > 0 %}
AllowGroups {{ ssh_allowed_groups | join(' ') }}
{% endif %}

# SFTP Subsystem
Subsystem sftp /usr/lib/openssh/sftp-server -f AUTHPRIV -l INFO

# Banner
{% if ssh_banner_enabled | default(false) %}
Banner /etc/ssh/banner
{% endif %}

# Accept locale environment variables
AcceptEnv LANG LC_*
