---
# Common Role - User Management Tasks

- name: Common | Users | Create ansible-automation group
  ansible.builtin.group:
    name: ansible-automation
    state: present
    system: yes
  tags: [common, user, groups]

- name: Common | Users | Ensure admin user exists
  ansible.builtin.user:
    name: "{{ common_admin_user_name }}"
    groups: "{{ common_admin_user_groups }}"
    shell: "{{ common_admin_user_shell }}"
    create_home: true
    append: true
  when: common_admin_user_create
  tags: [common, user]

- name: Common | Users | Add admin user to ansible-automation group (SSH key-only access)
  ansible.builtin.user:
    name: "{{ common_admin_user_name }}"
    groups: ansible-automation
    append: yes
  when: common_admin_user_create
  tags: [common, user, ssh]

- name: Common | Users | Create .ssh directory for admin user
  ansible.builtin.file:
    path: "/home/{{ common_admin_user_name }}/.ssh"
    state: directory
    owner: "{{ common_admin_user_name }}"
    group: "{{ common_admin_user_name }}"
    mode: '0700'
  when: common_admin_user_create
  tags: [common, user]

- name: Common | Users | Set up authorized keys for admin user
  ansible.posix.authorized_key:
    user: "{{ common_admin_user_name }}"
    key: "{{ item }}"
    state: present
  loop: "{{ common_admin_user_ssh_keys }}"
  when:
    - common_admin_user_create
    - common_admin_user_ssh_keys | length > 0
  tags: [common, user, ssh]

- name: Common | Users | Set up sudoers for admin user
  ansible.builtin.template:
    src: sudoers.j2
    dest: "/etc/sudoers.d/{{ common_admin_user_name }}"
    owner: root
    group: root
    mode: '0440'
    validate: visudo -cf %s
  when: common_admin_user_create
  tags: [common, sudo]

# - name: Common | Users | Disable root account password
#   ansible.builtin.user:
#     name: root
#     password: "!"
#   when: common_disable_root_password | default(false)
#   tags: [common, security]
