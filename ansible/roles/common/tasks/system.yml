---
# Common Role - System Configuration Tasks

- name: Common | System | Create Ansible temporary directory
  ansible.builtin.file:
    path: /root/.ansible/tmp
    state: directory
    owner: root
    group: root
    mode: '0700'
  tags: [common, system]

- name: Common | System | Set hostname
  ansible.builtin.hostname:
    name: "{{ inventory_hostname }}"
  tags: [common, hostname]

- name: Common | System | Set timezone
  community.general.timezone:
    name: "{{ common_system_timezone }}"
  tags: [common, timezone]

- name: Common | System | Set locale
  community.general.locale_gen:
    name: "{{ common_system_locale }}"
    state: present
  tags: [common, locale]

- name: Common | System | Configure NTP
  block:
    - name: Common | System | Install NTP package
      ansible.builtin.apt:
        name: "{{ common_ntp_package }}"
        state: present
        update_cache: true
        cache_valid_time: 3600

    - name: Common | System | Configure NTP servers
      ansible.builtin.template:
        src: timesyncd.conf.j2
        dest: /etc/systemd/timesyncd.conf
        owner: root
        group: root
        mode: '0644'
      notify: restart timesyncd

    - name: Common | System | Enable and start NTP service
      ansible.builtin.systemd:
        name: "{{ common_ntp_service }}"
        enabled: true
        state: started
        daemon_reload: true
  when: common_ntp_enabled
  tags: [common, ntp]

- name: Common | System | Configure log rotation
  ansible.builtin.template:
    src: logrotate.conf.j2
    dest: /etc/logrotate.d/custom
    owner: root
    group: root
    mode: '0644'
  tags: [common, logging]

- name: Common | System | Check if reboot is required
  ansible.builtin.stat:
    path: /var/run/reboot-required
  register: reboot_required_file
  tags: [common, always]

- name: Common | System | Set reboot fact
  ansible.builtin.set_fact:
    ansible_reboot_required: "{{ reboot_required_file.stat.exists }}"
  tags: [common, always]
