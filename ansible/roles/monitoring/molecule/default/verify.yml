---
- name: Verify
  hosts: all
  become: true
  gather_facts: true

  tasks:
    - name: Check if Node Exporter is installed
      ansible.builtin.stat:
        path: /usr/local/bin/node_exporter
      register: node_exporter_binary
      failed_when: not node_exporter_binary.stat.exists

    - name: Check if Node Exporter service is running
      ansible.builtin.service:
        name: node_exporter
        state: started
        enabled: true
      check_mode: true
      register: node_exporter_service
      failed_when: node_exporter_service.changed

    - name: Verify Node Exporter is listening on port 9100
      ansible.builtin.wait_for:
        port: 9100
        timeout: 5

    - name: Test Node Exporter metrics endpoint
      ansible.builtin.uri:
        url: http://localhost:9100/metrics
        return_content: true
      register: metrics_response
      failed_when: "'node_' not in metrics_response.content"

    - name: Check if Promtail is installed (if configured)
      ansible.builtin.stat:
        path: /usr/local/bin/promtail
      register: promtail_binary
      ignore_errors: true

    - name: Display test results
      ansible.builtin.debug:
        msg: "All monitoring role tests passed!"
